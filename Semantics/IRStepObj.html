<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory IRStepObj</title>
</head>


<body>
<div class="head">
<h1>Theory IRStepObj</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Control-flow Semantics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IRStepObj
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="IRTreeEval.html">IRTreeEval</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Heap›</span></span> <span class="comment1">(* TODO: find a better location for heap definition *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The heap model we introduce maps field references to object instances to runtime values.
We use the H[f][p] heap representation. See <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"\\cite{heap-reps-2011}"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We also introduce the DynamicHeap type which allocates new object references sequentially
storing the next free object reference as 'Free'.
›</span></span>
<span class="comment1">(* TODO: Record volatile fields?  Include class name of field? *)</span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\Snip{heapdef}%›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> Heap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> Value"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Free <span class="main">=</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DynamicHeap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> Heap <span class="main">×</span> Free"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">h_load_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DynamicHeap <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h_load_field</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">h_store_field</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> Value <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DynamicHeap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DynamicHeap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h_store_field</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">:=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">h_new_inst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DynamicHeap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DynamicHeap <span class="main">×</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">h_new_inst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>ObjRef <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> FieldRefHeap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string<span class="main">,</span> objref<span class="main">)</span> DynamicHeap"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\EndSnip›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">new_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DynamicHeap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">new_heap</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">λ</span><span class="bound">p</span><span class="main">.</span> UndefVal<span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Intraprocedural Semantics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Intraprocedural semantics are given as a small-step semantics.

Within the context of a graph, the configuration triple, (ID, MethodState, Heap),
is related to the subsequent configuration.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> Params <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> MapState <span class="main">×</span> FieldRefHeap<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> MapState <span class="main">×</span> FieldRefHeap<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span> _ <span class="keyword1">⊢</span> _ <span class="keyword1">→</span> _"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">where</span></span>

  SequentialNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_sequential_node <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="main">=</span> <span class="main">(</span>successors_of <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  IfNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">condE</span></span></span><span class="main">;</span> 
    <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">condE</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>  

  EndNodes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_AbstractEndNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">merge</span></span></span> <span class="main">=</span> any_usage <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>
    is_AbstractMergeNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">merge</span></span></span><span class="main">)</span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> find_index <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>inputs_of <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">merge</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">=</span> <span class="main">(</span>phi_list <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">merge</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">inps</span></span></span> <span class="main">=</span> <span class="main">(</span>phi_inputs <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">inps</span></span></span> <span class="keyword1">▹<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">inpsE</span></span></span><span class="main">;</span>
    <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">inpsE</span></span></span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> set_phis <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">merge</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>


  NewInstanceNode<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>NewInstanceNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span> <span class="main">=</span> h_new_inst <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  LoadFieldNode<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>LoadFieldNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">objE</span></span></span><span class="main">;</span> 
      <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">objE</span></span></span> <span class="main">↦</span> ObjRef <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">;</span>
      h_load_field <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  SignedDivNode<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>SignedDivNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">zero</span></span></span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="free"><span class="bound"><span class="entity">nxt</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span> 
      <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">;</span> 
      <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">;</span>
      <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span>intval_div <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nxt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  SignedRemNode<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>SignedRemNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">zero</span></span></span> <span class="free"><span class="bound"><span class="entity">sb</span></span></span> <span class="free"><span class="bound"><span class="entity">nxt</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span> 
      <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">;</span> 
      <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">;</span>
      <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span>intval_mod <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nxt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  StaticLoadFieldNode<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>LoadFieldNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> None <span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">)</span><span class="main">;</span>
      h_load_field <span class="free"><span class="bound"><span class="entity">f</span></span></span> None <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  StoreFieldNode<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>StoreFieldNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">newval</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">obj</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">newval</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">newvalE</span></span></span><span class="main">;</span>
      <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">obj</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">objE</span></span></span><span class="main">;</span> 
      <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">newvalE</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
      <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">objE</span></span></span> <span class="main">↦</span> ObjRef <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">=</span> h_store_field <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  StaticStoreFieldNode<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>StoreFieldNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">newval</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> None <span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">newval</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">newvalE</span></span></span><span class="main">;</span> 
      <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">newvalE</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">h'</span></span></span> <span class="main">=</span> h_store_field <span class="free"><span class="bound"><span class="entity">f</span></span></span> None <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">;</span>
      <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">g</span><span class="main"><span class="free">,</span></span> <span class="free">p</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ i * i * i ⇒ o * o * o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">step</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interprocedural Semantics›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> Signature <span class="main">=</span> <span class="quoted"><span class="quoted">"string"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Program <span class="main">=</span> <span class="quoted"><span class="quoted">"Signature <span class="main">⇀</span> IRGraph"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">step_top</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Program <span class="main">⇒</span> <span class="main">(</span>IRGraph <span class="main">×</span> ID <span class="main">×</span> MapState <span class="main">×</span> Params<span class="main">)</span> list <span class="main">×</span> FieldRefHeap <span class="main">⇒</span> <span class="main">(</span>IRGraph <span class="main">×</span> ID <span class="main">×</span> MapState <span class="main">×</span> Params<span class="main">)</span> list <span class="main">×</span> FieldRefHeap <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">⟶</span> _"</span> 55<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">where</span></span>

  Lift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⊢</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟶</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  InvokeNodeStep<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_Invoke <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">callTarget</span></span></span> <span class="main">=</span> ir_callTarget <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">callTarget</span></span></span> <span class="main">=</span> <span class="main">(</span>MethodCallTargetNode <span class="free"><span class="bound"><span class="entity">targetMethod</span></span></span> <span class="free"><span class="bound"><span class="entity">arguments</span></span></span><span class="main">)</span><span class="main">;</span>
    Some <span class="free"><span class="bound"><span class="entity">targetGraph</span></span></span> <span class="main">=</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">targetMethod</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> new_map_state<span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">arguments</span></span></span> <span class="keyword1">▹<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">argsE</span></span></span><span class="main">;</span>
    <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">argsE</span></span></span>  <span class="keyword1">↦<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟶</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">targetGraph</span></span></span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ReturnNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>ReturnNode <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">expr</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
    <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">cm'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cnid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">cnid'</span></span></span> <span class="main">=</span> <span class="main">(</span>successors_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">cg</span></span></span> <span class="free"><span class="bound"><span class="entity">cnid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cg</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cnid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cp</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟶</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cg</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cnid'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cm'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cp</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ReturnNodeVoid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>ReturnNode None <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">cm'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cnid</span></span></span> <span class="main">:=</span> <span class="main">(</span>ObjRef <span class="main">(</span>Some <span class="main">(</span><span class="numeral">2048</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    
    <span class="free"><span class="bound"><span class="entity">cnid'</span></span></span> <span class="main">=</span> <span class="main">(</span>successors_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">cg</span></span></span> <span class="free"><span class="bound"><span class="entity">cnid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cg</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cnid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cp</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟶</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cg</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cnid'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cm'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cp</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  UnwindNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span>UnwindNode <span class="free"><span class="bound"><span class="entity">exception</span></span></span><span class="main">)</span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">exception</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">exceptionE</span></span></span><span class="main">;</span>
    <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">exceptionE</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">;</span>
     
    kind <span class="free"><span class="bound"><span class="entity">cg</span></span></span> <span class="free"><span class="bound"><span class="entity">cnid</span></span></span> <span class="main">=</span> <span class="main">(</span>InvokeWithExceptionNode <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">exEdge</span></span></span><span class="main">)</span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">cm'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cnid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">P</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cg</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cnid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cp</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟶</span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">cg</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">exEdge</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cm'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">cp</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">stk</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">step_top</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Big-step Execution›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> Trace <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IRGraph <span class="main">×</span> ID <span class="main">×</span> MapState <span class="main">×</span> Params<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">has_return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"MapState <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_return</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">0</span> <span class="main">≠</span> UndefVal<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Program 
      <span class="main">⇒</span> <span class="main">(</span>IRGraph <span class="main">×</span> ID <span class="main">×</span> MapState <span class="main">×</span> Params<span class="main">)</span> list <span class="main">×</span> FieldRefHeap
      <span class="main">⇒</span> Trace 
      <span class="main">⇒</span> <span class="main">(</span>IRGraph <span class="main">×</span> ID <span class="main">×</span> MapState <span class="main">×</span> Params<span class="main">)</span> list <span class="main">×</span> FieldRefHeap
      <span class="main">⇒</span> Trace 
      <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">|</span> _ <span class="keyword1">⟶*</span> _ <span class="keyword1">|</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">P</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>has_return <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>

    <span class="free">exec</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="free"><span class="bound"><span class="entity">next_state</span></span></span> <span class="free"><span class="bound"><span class="entity">l''</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">exec</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">next_state</span></span></span> <span class="free"><span class="bound"><span class="entity">l''</span></span></span>"</span></span> 
<span class="comment1">(* TODO: refactor this stopping condition to be more abstract *)</span>
  <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span><span class="main">;</span>
    has_return <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">exec</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">h'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l'</span></span></span>"</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ i ⇒ o ⇒ o ⇒ bool as Exec<span class="main">)</span> <span class="quoted"><span class="quoted"><span class="quoted">"exec"</span></span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">exec_debug</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Program
     <span class="main">⇒</span> <span class="main">(</span>IRGraph <span class="main">×</span> ID <span class="main">×</span> MapState <span class="main">×</span> Params<span class="main">)</span> list <span class="main">×</span> FieldRefHeap
     <span class="main">⇒</span> nat
     <span class="main">⇒</span> <span class="main">(</span>IRGraph <span class="main">×</span> ID <span class="main">×</span> MapState <span class="main">×</span> Params<span class="main">)</span> list <span class="main">×</span> FieldRefHeap
     <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_<span class="keyword1">⊢</span>_<span class="keyword1">→*</span>_<span class="keyword1">*</span> _"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">;</span>
    <span class="free">exec_debug</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">exec_debug</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">exec_debug</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted"><span class="quoted">"exec_debug"</span></span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Heap Testing›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">p3</span><span class="main">::</span> <span class="quoted">Params</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">p3</span> <span class="main">=</span> <span class="main">[</span>IntVal32 <span class="numeral">3</span><span class="main">]</span>"</span></span>

<span class="comment1">(* Eg. call eg2_sq with [3] ⟶ 9 *)</span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>prod.fst<span class="main">(</span>prod.snd <span class="main">(</span>prod.snd <span class="main">(</span>hd <span class="main">(</span>prod.fst <span class="bound">res</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> 
        <span class="main">|</span> <span class="bound">res</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> Some eg2_sq<span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span>eg2_sq<span class="main">,</span><span class="main">0</span><span class="main">,</span>new_map_state<span class="main">,</span>p3<span class="main">)</span><span class="main">,</span> <span class="main">(</span>eg2_sq<span class="main">,</span><span class="main">0</span><span class="main">,</span>new_map_state<span class="main">,</span>p3<span class="main">)</span><span class="main">]</span><span class="main">,</span> new_heap<span class="main">)</span> <span class="main">→*</span><span class="numeral">2</span><span class="main">*</span> <span class="bound">res</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">field_sq</span> <span class="main">::</span> <span class="quoted">string</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">field_sq</span> <span class="main">=</span> <span class="inner_quoted">''sq''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eg3_sq</span> <span class="main">::</span> <span class="quoted">IRGraph</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eg3_sq</span> <span class="main">=</span> irgraph <span class="main">[</span>
    <span class="main">(</span><span class="main">0</span><span class="main">,</span> StartNode None <span class="numeral">4</span><span class="main">,</span> VoidStamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">1</span><span class="main">,</span> ParameterNode <span class="main">0</span><span class="main">,</span> default_stamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> MulNode <span class="main">1</span> <span class="main">1</span><span class="main">,</span> default_stamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">4</span><span class="main">,</span> StoreFieldNode <span class="numeral">4</span> field_sq <span class="numeral">3</span> None None <span class="numeral">5</span><span class="main">,</span> VoidStamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">5</span><span class="main">,</span> ReturnNode <span class="main">(</span>Some <span class="numeral">3</span><span class="main">)</span> None<span class="main">,</span> default_stamp<span class="main">)</span>
   <span class="main">]</span>"</span></span>

<span class="comment1">(* Eg. call eg2_sq with [3] ⟶ heap with object None={sq: 9} *)</span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>h_load_field field_sq None <span class="main">(</span>prod.snd <span class="bound">res</span><span class="main">)</span>
        <span class="main">|</span> <span class="bound">res</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some eg3_sq<span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span>eg3_sq<span class="main">,</span> <span class="main">0</span><span class="main">,</span> new_map_state<span class="main">,</span> p3<span class="main">)</span><span class="main">,</span> <span class="main">(</span>eg3_sq<span class="main">,</span> <span class="main">0</span><span class="main">,</span> new_map_state<span class="main">,</span> p3<span class="main">)</span><span class="main">]</span><span class="main">,</span> new_heap<span class="main">)</span> <span class="main">→*</span><span class="numeral">3</span><span class="main">*</span> <span class="bound">res</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eg4_sq</span> <span class="main">::</span> <span class="quoted">IRGraph</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eg4_sq</span> <span class="main">=</span> irgraph <span class="main">[</span>
    <span class="main">(</span><span class="main">0</span><span class="main">,</span> StartNode None <span class="numeral">4</span><span class="main">,</span> VoidStamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">1</span><span class="main">,</span> ParameterNode <span class="main">0</span><span class="main">,</span> default_stamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> MulNode <span class="main">1</span> <span class="main">1</span><span class="main">,</span> default_stamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">4</span><span class="main">,</span> NewInstanceNode <span class="numeral">4</span> <span class="inner_quoted">''obj_class''</span> None <span class="numeral">5</span><span class="main">,</span> ObjectStamp <span class="inner_quoted">''obj_class''</span> True True True<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">5</span><span class="main">,</span> StoreFieldNode <span class="numeral">5</span> field_sq <span class="numeral">3</span> None <span class="main">(</span>Some <span class="numeral">4</span><span class="main">)</span> <span class="numeral">6</span><span class="main">,</span> VoidStamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> ReturnNode <span class="main">(</span>Some <span class="numeral">3</span><span class="main">)</span> None<span class="main">,</span> default_stamp<span class="main">)</span>
   <span class="main">]</span>"</span></span>

<span class="comment1">(* Eg. call eg2_sq with [3] ⟶ heap with object 0={sq: 9} *)</span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>h_load_field field_sq <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">(</span>prod.snd <span class="bound">res</span><span class="main">)</span> <span class="main">|</span> <span class="bound">res</span><span class="main">.</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some eg4_sq<span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span>eg4_sq<span class="main">,</span> <span class="main">0</span><span class="main">,</span> new_map_state<span class="main">,</span> p3<span class="main">)</span><span class="main">,</span> <span class="main">(</span>eg4_sq<span class="main">,</span> <span class="main">0</span><span class="main">,</span> new_map_state<span class="main">,</span> p3<span class="main">)</span><span class="main">]</span><span class="main">,</span> new_heap<span class="main">)</span> <span class="main">→*</span><span class="numeral">4</span><span class="main">*</span> <span class="bound">res</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</body>

</html>