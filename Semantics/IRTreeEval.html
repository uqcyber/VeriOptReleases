<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory IRTreeEval</title>
</head>


<body>
<div class="head">
<h1>Theory IRTreeEval</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Data-flow Semantics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IRTreeEval
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Graph/IRGraph.html">Graph.IRGraph</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We define a tree representation of data-flow nodes, as an abstraction of the graph view.

Data-flow trees are evaluated in the context of a method state
(currently called MapState in the theories for historical reasons).

The method state consists of the values for each method parameter, references to
method parameters use an index of the parameter within the parameter list, as such
we store a list of parameter values which are looked up at parameter references.

The method state also stores a mapping of node ids to values. The contents of this
mapping is calculates during the traversal of the control flow graph.

As a concrete example, as the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SignedDivNode</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can have side-effects
(during division by zero), it is treated as part of the control-flow, since
the data-flow phase is specified to be side-effect free.
As a result, the control-flow semantics for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SignedDivNode</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> calculates the
value of a node and maps the node identifier to the value within the method state.
The data-flow semantics then just reads the value stored in the method state for the node.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> MapState <span class="main">=</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> Value"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Params <span class="main">=</span> <span class="quoted"><span class="quoted">"Value list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">new_map_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"MapState"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">new_map_state</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> UndefVal<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">val_to_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val_to_bool</span> <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> True<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">val_to_bool</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bool_to_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_to_val</span> True <span class="main">=</span> <span class="main">(</span>IntVal32  <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_to_val</span> False <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span>"</span></span>


<span class="comment1">(* TODO: move the following phi helpers to step semantics? *)</span>
<span class="comment1">(* Yoinked from https://www.isa-afp.org/browser_info/Isabelle2012/HOL/List-Index/List_Index.html*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_index</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">find_index</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">find_index</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">phi_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">phi_list</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> 
    <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span><span class="main">(</span>is_PhiNode <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>sorted_list_of_set <span class="main">(</span>usages <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">input_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input_index</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">=</span> find_index <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">(</span>inputs_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">phi_inputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> nat <span class="main">⇒</span> ID list <span class="main">⇒</span> ID list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">phi_inputs</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">nodes</span></span></span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>inputs_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nodes</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">set_phis</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ID list <span class="main">⇒</span> Value list <span class="main">⇒</span> MapState <span class="main">⇒</span> MapState"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_phis</span> <span class="main">[]</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">set_phis</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">set_phis</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">set_phis</span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">set_phis</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_node_and_stamp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>IRNode <span class="main">×</span> Stamp<span class="main">)</span> <span class="main">⇒</span> ID option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_node_and_stamp</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
     find <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set<span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">find_node_and_stamp</span></span>


<span class="comment1">(* ======================== START OF NEW TREE STUFF ==========================*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data-flow Tree Representation›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> IRUnaryOp <span class="main">=</span>
    UnaryAbs
  <span class="main">|</span> UnaryNeg
  <span class="main">|</span> UnaryNot
  <span class="main">|</span> UnaryLogicNegation

<span class="keyword1"><span class="command">datatype</span></span> IRBinaryOp <span class="main">=</span>
    BinAdd
  <span class="main">|</span> BinMul
  <span class="main">|</span> BinSub
  <span class="main">|</span> BinAnd
  <span class="main">|</span> BinOr
  <span class="main">|</span> BinXor
  <span class="main">|</span> BinIntegerEquals
  <span class="main">|</span> BinIntegerLessThan


<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>discs_sels<span class="main">)</span> IRExpr <span class="main">=</span>
    UnaryExpr <span class="main">(</span><span class="free"><span class="entity">ir_uop</span></span><span class="main">:</span> <span class="quoted">IRUnaryOp</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">ir_value</span></span><span class="main">:</span> <span class="quoted">IRExpr</span><span class="main">)</span>
  <span class="main">|</span> BinaryExpr <span class="main">(</span><span class="free"><span class="entity">ir_op</span></span><span class="main">:</span> <span class="quoted">IRBinaryOp</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">ir_x</span></span><span class="main">:</span> <span class="quoted">IRExpr</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">ir_y</span></span><span class="main">:</span> <span class="quoted">IRExpr</span><span class="main">)</span>
  <span class="main">|</span> ConditionalExpr <span class="main">(</span><span class="free"><span class="entity">ir_condition</span></span><span class="main">:</span> <span class="quoted">IRExpr</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">ir_trueValue</span></span><span class="main">:</span> <span class="quoted">IRExpr</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">ir_falseValue</span></span><span class="main">:</span> <span class="quoted">IRExpr</span><span class="main">)</span>
  <span class="main">|</span> ConstantExpr <span class="main">(</span><span class="free"><span class="entity">ir_const</span></span><span class="main">:</span> <span class="quoted">Value</span><span class="main">)</span> 
<span class="comment1">(* TODO
  | IsNullNode (ir_value: IRExpr) 
  | RefNode ?
*)</span>
  <span class="main">|</span> ParameterExpr <span class="main">(</span><span class="free"><span class="entity">ir_index</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">ir_stamp</span></span><span class="main">:</span> <span class="quoted">Stamp</span><span class="main">)</span>
<span class="comment1">(* Not needed?
  | PiNode (ir_object: IRExpr) (ir_guard_opt: "IRExpr option")
  | ShortCircuitOrNode (ir_x: IRExpr) (ir_y: IRExpr)
*)</span>
<span class="comment1">(* Not needed?
  | UnwindNode (ir_exception: IRExpr) 
  | ValueProxyNode (ir_value: IRExpr) (ir_loopExit: IRExpr) 
*)</span>
  <span class="main">|</span> LeafExpr <span class="main">(</span><span class="free"><span class="entity">ir_nid</span></span><span class="main">:</span> <span class="quoted">ID</span><span class="main">)</span> <span class="main">(</span>ir_stamp<span class="main">:</span> <span class="quoted">Stamp</span><span class="main">)</span>
  <span class="comment1">(* LeafExpr is for pre-evaluated nodes, like LoadFieldNode, SignedDivNode. *)</span> 


<span class="comment1">(* These kinds of nodes are evaluated during the control flow, so are already in MapState. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_preevaluated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRNode <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_preevaluated</span> <span class="main">(</span>InvokeNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_preevaluated</span> <span class="main">(</span>InvokeWithExceptionNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_preevaluated</span> <span class="main">(</span>NewInstanceNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_preevaluated</span> <span class="main">(</span>LoadFieldNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_preevaluated</span> <span class="main">(</span>SignedDivNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_preevaluated</span> <span class="main">(</span>SignedRemNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_preevaluated</span> <span class="main">(</span>ValuePhiNode <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_preevaluated</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">rep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">▹</span> _"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>

  ConstantNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ParameterNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> ParameterNode <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">;</span>
    stamp <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span>  <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>ParameterExpr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ConditionalNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> ConditionalNode <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">te</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">ce</span></span></span> <span class="free"><span class="bound"><span class="entity">te</span></span></span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

<span class="comment1">(* Unary nodes *)</span>
  AbsNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> AbsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>UnaryExpr UnaryAbs <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  NotNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> NotNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>UnaryExpr UnaryNot <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  NegateNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> NegateNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  LogicNegationNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> LogicNegationNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>UnaryExpr UnaryLogicNegation <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

<span class="comment1">(* Binary nodes *)</span>
  AddNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  MulNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>BinaryExpr BinMul <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  SubNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  AndNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>BinaryExpr BinAnd <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  OrNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>BinaryExpr BinOr <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  XorNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> XorNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>BinaryExpr BinXor <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  IntegerEqualsNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  IntegerLessThanNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>BinaryExpr BinIntegerLessThan <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  LeafNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_preevaluated <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span>
    stamp <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="main">(</span>LeafExpr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool as exprE<span class="main">)</span> <span class="quoted"><span class="quoted">rep</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">replist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID list <span class="main">⇒</span> IRExpr list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">▹<span class="hidden">⇩</span><sub>L</sub></span> _"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>

  RepNil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="main">[]</span> <span class="keyword1"><span class="free">▹<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>

  RepCons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">;</span>
    <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1"><span class="free">▹<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">xse</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1"><span class="free">▹<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xse</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool as exprListE<span class="main">)</span> <span class="quoted"><span class="quoted">replist</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\Snip{repRules}%
\begin{center}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] rep.ConstantNode <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] rep.ParameterNode <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] rep.AbsNode <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] rep.AddNode <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] rep.MulNode <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] rep.SubNode <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] rep.LeafNode <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
\end{center}
\EndSnip›</span></span>

<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> eg2_sq <span class="main">⊢</span> <span class="numeral">4</span> <span class="main">▹</span> <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> ConstantNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>ConstantExpr <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ParameterNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>ParameterExpr <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ConditionalNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>ConditionalExpr <span class="free">ce</span> <span class="free">te</span> <span class="free">fe</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> AbsNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>UnaryExpr UnaryAbs <span class="free">xe</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> NotNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="free">xe</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> NegateNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free">xe</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> LogicNegationNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>UnaryExpr UnaryLogicNegation <span class="free">xe</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> AddNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> MulNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>BinaryExpr BinMul <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> SubNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>BinaryExpr BinSub <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> AndNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>BinaryExpr BinAnd <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> OrNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>BinaryExpr BinOr <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> XorNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>BinaryExpr BinXor <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> IntegerEqualsNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> IntegerLessThanNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>BinaryExpr BinIntegerLessThan <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> LeafNodeE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">n</span> <span class="main">▹</span> <span class="main">(</span>LeafExpr <span class="free">nid</span> <span class="free">s</span><span class="main">)</span>"</span></span>

<span class="comment1">(* group those forward rules into a named set *)</span>
<span class="keyword1"><span class="command">lemmas</span></span> RepE<span class="comment1">✐<span class="quoted">‹tag invisible›</span></span> <span class="main">=</span> 
  ConstantNodeE
  ParameterNodeE
  ConditionalNodeE
  AbsNodeE
  NotNodeE
  NegateNodeE
  LogicNegationNodeE
  AddNodeE
  MulNodeE
  SubNodeE
  AndNodeE
  OrNodeE
  XorNodeE
  IntegerEqualsNodeE
  IntegerLessThanNodeE
  LeafNodeE

<span class="comment1">(* ======== TODO: Functions for re-calculating stamps ========== *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stamp_unary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRUnaryOp <span class="main">⇒</span> Stamp <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_unary</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span> <span class="main">=</span> unrestricted_stamp <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* for now... *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_unary</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> IllegalStamp"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stamp_binary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRBinaryOp <span class="main">⇒</span> Stamp <span class="main">⇒</span> Stamp <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_binary</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">lo1</span></span></span> <span class="free"><span class="bound"><span class="entity">hi1</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">lo2</span></span></span> <span class="free"><span class="bound"><span class="entity">hi2</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="keyword1">then</span> unrestricted_stamp <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">lo1</span></span></span> <span class="free"><span class="bound"><span class="entity">hi1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> IllegalStamp<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* for now... *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_binary</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> IllegalStamp"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stamp_expr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_expr</span> <span class="main">(</span>UnaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> stamp_unary <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span><span class="free">stamp_expr</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_expr</span> <span class="main">(</span>BinaryExpr <span class="free"><span class="bound"><span class="entity">bop</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> stamp_binary <span class="free"><span class="bound"><span class="entity">bop</span></span></span> <span class="main">(</span><span class="free">stamp_expr</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">stamp_expr</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_expr</span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="main">=</span> constantAsStamp <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_expr</span> <span class="main">(</span>LeafExpr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_expr</span> <span class="main">(</span>ParameterExpr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">stamp_expr</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> meet <span class="main">(</span><span class="free">stamp_expr</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">stamp_expr</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">stamp_unary</span></span> <span class="quoted"><span class="quoted">stamp_binary</span></span> <span class="quoted"><span class="quoted">stamp_expr</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unary_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRUnaryOp <span class="main">⇒</span> ID <span class="main">⇒</span> IRNode"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unary_node</span> UnaryAbs <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> AbsNode <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unary_node</span> UnaryNot <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> NotNode <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unary_node</span> UnaryNeg <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> NegateNode <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unary_node</span> UnaryLogicNegation <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> LogicNegationNode <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="comment1">(* Creates the appropriate IRNode for a given binary operator. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bin_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRBinaryOp <span class="main">⇒</span> ID <span class="main">⇒</span> ID <span class="main">⇒</span> IRNode"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_node</span> BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_node</span> BinMul <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_node</span> BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_node</span> BinAnd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_node</span> BinOr  <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_node</span> BinXor <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> XorNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_node</span> BinIntegerEquals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_node</span> BinIntegerLessThan <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="comment1">(* TODO: switch these to new Values2 *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unary_eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRUnaryOp <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unary_eval</span> UnaryAbs <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span>  <span class="main">=</span> IntVal32 <span class="main">(</span> <span class="main">(</span><span class="keyword1">if</span> sint<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unary_eval</span> UnaryAbs <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span>  <span class="main">=</span> IntVal64 <span class="main">(</span> <span class="main">(</span><span class="keyword1">if</span> sint<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">unary_eval</span> UnaryNot <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">=</span> IntVal32 <span class="main">(</span><span class="keyword1">NOT</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unary_eval</span> UnaryNot <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">=</span> IntVal64 <span class="main">(</span><span class="keyword1">NOT</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">unary_eval</span> UnaryLogicNegation <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>IntVal32 <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">unary_eval</span> UnaryNeg <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> intval_negate <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>

  <span class="quoted"><span class="quoted">"<span class="free">unary_eval</span> <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bin_eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRBinaryOp <span class="main">⇒</span> Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_eval</span> BinAdd <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> intval_add <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_eval</span> BinMul <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> intval_mul <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_eval</span> BinSub <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> intval_sub <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_eval</span> BinAnd <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> intval_and <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_eval</span> BinOr  <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> intval_or <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_eval</span> BinXor <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> intval_xor <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_eval</span> BinIntegerEquals <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> intval_equals <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_eval</span> BinIntegerLessThan <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> intval_less_than <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span>
<span class="comment1">(*  "bin_eval op v1 v2 = UndefVal" *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">fresh_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">∉</span> ids <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟹</span> <span class="free">fresh_id</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">fresh_id</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">(* This generates a specific fresh ID (max+1), in a code-friendly way. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_fresh_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">(* Previous attempts - cannot generate code due to nat not Enum. 
  "get_fresh_id g = 100"
  "get_fresh_id g = (ffold max (0::nat) (f_ids g))"
  "get_fresh_id g = fst(last(as_list g))"
  "get_fresh_id g = last(sorted_list_of_set (dom (Rep_IRGraph g)))"
*)</span>
  <span class="quoted"><span class="quoted">"<span class="free">get_fresh_id</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> last<span class="main">(</span>sorted_list_of_set<span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">get_fresh_id</span></span>
<span class="comment1">(* these examples return 6 and 7 respectively *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"get_fresh_id eg2_sq"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"get_fresh_id <span class="main">(</span>add_node <span class="numeral">6</span> <span class="main">(</span>ParameterNode <span class="numeral">2</span><span class="main">,</span> default_stamp<span class="main">)</span> eg2_sq<span class="main">)</span>"</span></span>

<span class="comment1">(* Second version of tree insertion into graph:

      g ◃ expr ↝ (g',nid) re-inserts expr into g and returns the new root nid.

   This means that we can try to re-use existing nodes by finding node IDs bottom-up.
*)</span>
<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">unrep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRExpr <span class="main">⇒</span> <span class="main">(</span>IRGraph <span class="main">×</span> ID<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">◃</span> _ <span class="keyword1">↝</span> _"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">unrepList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRExpr list <span class="main">⇒</span> <span class="main">(</span>IRGraph <span class="main">×</span> ID list<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">◃<span class="hidden">⇩</span><sub>L</sub></span> _ <span class="keyword1">↝</span> _"</span> 55<span class="main">)</span>
   <span class="keyword2"><span class="keyword">where</span></span>

  ConstantNodeSame<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> constantAsStamp <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ConstantNodeNew<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> constantAsStamp <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> None<span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> get_fresh_id <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> constantAsStamp <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ParameterNodeSame<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ParameterNode <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>ParameterExpr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ParameterNodeNew<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ParameterNode <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> None<span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> get_fresh_id <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>ParameterNode <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>ParameterExpr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ConditionalNodeSame<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">◃<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">te</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">]</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> meet <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">ce</span></span></span> <span class="free"><span class="bound"><span class="entity">te</span></span></span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  ConditionalNodeNew<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">◃<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">ce</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">te</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">]</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> meet <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span> None<span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> get_fresh_id <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">ce</span></span></span> <span class="free"><span class="bound"><span class="entity">te</span></span></span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  UnaryNodeSame<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> stamp_unary <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">(</span>unary_node <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>UnaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  UnaryNodeNew<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> stamp_unary <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">(</span>unary_node <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span> None<span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> get_fresh_id <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>unary_node <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>UnaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  BinaryNodeSame<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">◃<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">]</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> stamp_binary <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">(</span>bin_node <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>BinaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  BinaryNodeNew<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">◃<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">]</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> stamp_binary <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    find_node_and_stamp <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="main">(</span>bin_node <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">=</span> None<span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> get_fresh_id <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>bin_node <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>BinaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  AllLeafNodes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="main">(</span>LeafExpr <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  UnrepNil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">◃<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">[]</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>

<span class="comment1">(* TODO: this will fail for [xe,ye] where they are not equal.
         Figure out how to generate code for this?
*)</span>
  UnrepCons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="free">◃</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="keyword1"><span class="free">◃<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">xes</span></span></span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">◃<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xes</span></span></span><span class="main">)</span> <span class="main"><span class="free">↝</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g3</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool as unrepE<span class="main">)</span>
<span class="comment1">(*
  [show_steps,show_mode_inference,show_intermediate_results] 
*)</span>  <span class="quoted"><span class="quoted">unrep</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool as unrepListE<span class="main">)</span> <span class="quoted"><span class="quoted">unrepList</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\Snip{unrepRules}%
\begin{center}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.ConstantNodeSame <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.ConstantNodeNew <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.ParameterNodeSame <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.ParameterNodeNew <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.ConditionalNodeSame <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.ConditionalNodeNew <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.BinaryNodeSame <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.BinaryNodeNew <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.UnaryNodeSame <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.UnaryNodeNew <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] unrep_unrepList.AllLeafNodes <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
\end{center}
\EndSnip›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sq_param0</span> <span class="main">::</span> <span class="quoted">IRExpr</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sq_param0</span> <span class="main">=</span> BinaryExpr BinMul 
    <span class="main">(</span>ParameterExpr <span class="main">0</span> <span class="main">(</span>IntegerStamp <span class="numeral">32</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">2147483648</span><span class="main">)</span> <span class="numeral">2147483647</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>ParameterExpr <span class="main">0</span> <span class="main">(</span>IntegerStamp <span class="numeral">32</span> <span class="main">(</span><span class="main">-</span> <span class="numeral">2147483648</span><span class="main">)</span> <span class="numeral">2147483647</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*
instantiation IRGraph :: equal begin

definition "(g1 = g2) ⟷ 
              (f_ids g1 = f_ids g2 ∧
               (∀n. (n ∈ ids g1 ⟹ (Rep_IRGraph g1 n = Rep_IRGraph g2 n))))"
instance proof 
  fix x y :: IRGraph
  show "x = y ⟷ x ≤ y ∧ ¬ (y ≤ x)" by (simp add: equiv_exprs_def; auto)
  show "x ≤ x" by simp
  show "x ≤ y ⟹ y ≤ z ⟹ x ≤ z" by simp 
qed
end
*)</span>

<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">nid</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span>eg2_sq <span class="main">◃</span> sq_param0 <span class="main">↝</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">nid</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data-flow Tree Evaluation›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">evaltree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"MapState <span class="main">⇒</span> Params <span class="main">⇒</span> IRExpr <span class="main">⇒</span> Value <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">,</span>_<span class="keyword1">]</span> <span class="keyword1">⊢</span> _ <span class="keyword1">↦</span> _"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">m</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">where</span></span>

  ConstantExpr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≠</span> UndefVal<span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>

  ParameterExpr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid_value <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">p</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>ParameterExpr <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main"><span class="free">↦</span></span> <span class="free">p</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span> <span class="main">|</span>

  ConditionalExpr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ce</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">te</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">branch</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">ce</span></span></span> <span class="free"><span class="bound"><span class="entity">te</span></span></span> <span class="free"><span class="bound"><span class="entity">fe</span></span></span><span class="main">)</span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>

  UnaryExpr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>UnaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span><span class="main">)</span> <span class="main"><span class="free">↦</span></span> unary_eval <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>

  BinaryExpr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>BinaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">xe</span></span></span> <span class="free"><span class="bound"><span class="entity">ye</span></span></span><span class="main">)</span> <span class="main"><span class="free">↦</span></span> bin_eval <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>

  LeafExpr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> <span class="free">m</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>
    valid_value <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> LeafExpr <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\Snip{evalRules}%
\begin{center}
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] evaltree.ConstantExpr <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] evaltree.ParameterExpr <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] evaltree.ConditionalExpr <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] evaltree.UnaryExpr <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] evaltree.BinaryExpr <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[mode=Rule] evaltree.LeafExpr <span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\\[8px]
\end{center}
\EndSnip›</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ i ⇒ o ⇒ bool as evalT<span class="main">)</span>
  <span class="main">[</span>show_steps<span class="main">,</span>show_mode_inference<span class="main">,</span>show_intermediate_results<span class="main">]</span> 
  <span class="quoted"><span class="quoted">evaltree</span></span> <span class="keyword1"><span class="command">.</span></span>



<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">evaltrees</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"MapState <span class="main">⇒</span> Params <span class="main">⇒</span> IRExpr list <span class="main">⇒</span> Value list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">,</span>_<span class="keyword1">]</span> <span class="keyword1">⊢</span> _ <span class="keyword1">↦<span class="hidden">⇩</span><sub>L</sub></span> _"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">m</span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">where</span></span>

  EvalNil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">[]</span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>

  EvalCons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">xval</span></span></span><span class="main">;</span>
    <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">yy</span></span></span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">yyval</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="main"><span class="free">[</span></span><span class="free">m</span><span class="main"><span class="free">,</span></span><span class="free">p</span><span class="main"><span class="free">]</span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">yy</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">↦<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xval</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">yyval</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ i ⇒ o ⇒ bool as evalTs<span class="main">)</span>
  <span class="quoted"><span class="quoted">evaltrees</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> evaltree new_map_state <span class="main">[</span>IntVal32 <span class="numeral">5</span><span class="main">]</span> sq_param0 <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="comment1">(* We add all the inductive rules as unsafe intro rules. *)</span>
<span class="keyword1"><span class="command">declare</span></span> evaltree.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> evaltrees.intros <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="comment1">(* We derive a safe elimination (forward) reasoning rule for each case.
  Note that each pattern is as general as possible. *)</span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ConstantExprE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="main">(</span>ConstantExpr <span class="free">c</span><span class="main">)</span> <span class="main">↦</span> <span class="free">val</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ParameterExprE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="main">(</span>ParameterExpr <span class="free">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="free">val</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> ConditionalExprE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="main">(</span>ConditionalExpr <span class="free">c</span> <span class="free">t</span> <span class="free">f</span><span class="main">)</span> <span class="main">↦</span> <span class="free">val</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> UnaryExprE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="main">(</span>UnaryExpr <span class="free">op</span> <span class="free">xe</span><span class="main">)</span> <span class="main">↦</span> <span class="free">val</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> BinaryExprE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="main">(</span>BinaryExpr <span class="free">op</span> <span class="free">xe</span> <span class="free">ye</span><span class="main">)</span> <span class="main">↦</span> <span class="free">val</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> LeafExprE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="main">(</span>LeafExpr <span class="free">nid</span> <span class="free">s</span><span class="main">)</span> <span class="main">↦</span> <span class="free">val</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> EvalNilE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="main">[]</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">vals</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> EvalConsE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">m</span><span class="main">,</span><span class="free">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">yy</span><span class="main">)</span> <span class="keyword1">↦<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">vals</span>"</span></span>

<span class="comment1">(* group these forward rules into a named set *)</span>
<span class="keyword1"><span class="command">lemmas</span></span> EvalTreeE<span class="comment1">✐<span class="quoted">‹tag invisible›</span></span> <span class="main">=</span> 
  ConstantExprE
  ParameterExprE
  ConditionalExprE
  UnaryExprE
  BinaryExprE
  LeafExprE
  EvalNilE
  EvalConsE


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data-flow Tree Refinement›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the induced semantic equivalence relation between expressions.
  Note that syntactic equality implies semantic equivalence, but not vice versa.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">equiv_exprs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≐</span> _"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">≐</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">m</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">[</span><span class="bound">m</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also prove that this is a total equivalence relation (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"equivp equiv_exprs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>)
  (HOL.Equiv\_Relations), so that we can reuse standard results about equivalence relations.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"equivp equiv_exprs"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equivp_def equiv_exprs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equiv_exprs_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a refinement ordering over IRExpr and show that it is a preorder.
  Note that it is asymmetric because e2 may refer to fewer variables than e1.
›</span></span>
<span class="keyword1"><span class="command">instantiation</span></span> IRExpr <span class="main">::</span> <span class="quoted">preorder</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  le_expr_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">m</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">[</span><span class="bound">m</span><span class="main">,</span><span class="bound">p</span><span class="main">]</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  lt_expr_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">≐</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">IRExpr</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_exprs_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</body>

</html>