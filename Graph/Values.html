<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Values</title>
</head>


<body>
<div class="head">
<h1>Theory Values</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Runtime Values and Arithmetic›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Values
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Word.html">HOL-Library.Word</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Signed_Division.html">HOL-Library.Signed_Division</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Float.html">HOL-Library.Float</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/LaTeXsugar.html">HOL-Library.LaTeXsugar</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In order to properly implement the IR semantics we first introduce
a new type of runtime values. Our evaluation semantics are defined
in terms of these runtime values.
These runtime values represent the full range of primitive types
currently allowed by our semantics, ranging from basic integer types
to object references and eventually arrays.

An object reference is an option type where the None object reference
points to the static fields. This is examined more closely in our
definition of the heap.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> objref <span class="main">=</span> <span class="quoted"><span class="quoted">"nat option"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> Value  <span class="main">=</span>
  UndefVal <span class="main">|</span> <span class="comment1">(* TODO: still required? *)</span>
  IntVal <span class="main">(</span><span class="free"><span class="entity">v_bits</span></span><span class="main">:</span> <span class="quoted">int</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">v_int</span></span><span class="main">:</span> <span class="quoted">int</span><span class="main">)</span> <span class="main">|</span>
  FloatVal <span class="main">(</span>v_bits<span class="main">:</span> <span class="quoted">int</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">v_float</span></span><span class="main">:</span> <span class="quoted">float</span><span class="main">)</span> <span class="main">|</span>
  ObjRef <span class="quoted">objref</span> <span class="main">|</span>
  ObjStr <span class="quoted">string</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Java supports 64, 32, 16, 8 signed ints, plus 1 bit (boolean) ints.
Our Value type models this by keeping the value as an infinite precision signed int,
but also carrying along the number of bits allowed.

So each (IntVal b v) should satisfy the invariants:

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">b</span></span> <span class="main"><span class="main">∈</span></span> <span class="main"><span class="main">{</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">8</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">16</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">32</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">64</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">b</span></span> <span class="main"><span class="main">&gt;</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">v</span></span> <span class="main"><span class="main">==</span></span> signed <span class="main"><span class="main">(</span></span>signed_take_bit <span class="free"><span class="free">b</span></span> <span class="free"><span class="free">v</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> int64 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">64</span> word"</span></span> <span class="comment1">― ‹long›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> int32 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">32</span> word"</span></span> <span class="comment1">― ‹int›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> int16 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">16</span> word"</span></span> <span class="comment1">― ‹short›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> int8 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">8</span> word"</span></span> <span class="comment1">― ‹char›</span>
<span class="keyword1"><span class="command">type_synonym</span></span> int1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> word"</span></span> <span class="comment1">― ‹boolean›</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We define integer values to be well-formed when their bit size is valid
and their integer value is able to fit within the bit size.
This is defined using the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">wf_value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function.
›</span></span>

<span class="comment1">― ‹Check that a signed int value does not overflow b bits.›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fits_into_n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fits_into_n</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">int_bits_allowed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">int_bits_allowed</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">32</span><span class="main">}</span>"</span></span>

<span class="comment1">(* was:   (nat b ∈ {1,8,16,32,64} ∧ ...
   But we temporarily reduce this to 32/64 until we use stamps more statically.
*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wf_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_value</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> int_bits_allowed <span class="main">∧</span>
    <span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟶</span> fits_into_n <span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_value</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>


<span class="comment1">(* boolean values  TODO
lemma "¬ (wf_value (IntVal 1 (-1)))" by simp
lemma wf_false: "wf_value (IntVal 1 0)" by simp
lemma wf_true: "wf_value (IntVal 1 1)" by simp
lemma "¬ (wf_value (IntVal 1 2))" by simp

value "(-7::int) div (4::int)"   (* gives -2.  Truncates towards negative infinity, unlike Java. *)
value "(-7::int) mod (4::int)"   (* gives 1.  Whereas Java gives -3. *)
*)</span>

<span class="comment1">(* byte values TODO
lemma wf_byte__neg129: "i &lt; -128 ⟶ ¬ (wf_value (IntVal 8 i))" by simp
lemma wf_byte__neg: "-128 ≤ i ∧ i &lt; 0 ⟶ wf_value (IntVal 8 i)" by simp
lemma wf_byte_0: "wf_value (IntVal 8 0)" by simp
lemma wf_byte_pos: "0 &lt; i ∧ i &lt; 128 ⟶ wf_value (IntVal 8 i)" by simp
lemma wf_byte_128: "i ≥ 128 ⟶ ¬ (wf_value (IntVal 8 i))" by simp
*)</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"sint<span class="main">(</span>word_of_int <span class="main">(</span><span class="main">1</span><span class="main">)</span> <span class="main">::</span> int1<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We need to introduce arithmetic operations which agree with the JVM.

Within the JVM, bytecode arithmetic operations are performed on 32
or 64 bit integers, unboxing where appropriate.

The following collection of intval functions correspond to the JVM
arithmetic operations.
›</span></span>

<span class="comment1">(* Corresponds to JVM iadd and ladd instructions. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">intval_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_add</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> 
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int32<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int64<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_add</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Value <span class="main">::</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">plus_Value</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_Value</span> <span class="main">=</span> intval_add"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Corresponds to JVM isub and lsub instructions. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">intval_sub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_sub</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> 
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int32<span class="main">)</span> <span class="main">-</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int64<span class="main">)</span> <span class="main">-</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_sub</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Value <span class="main">::</span> <span class="quoted">minus</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">minus_Value</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minus_Value</span> <span class="main">=</span> intval_sub"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Corresponds to JVM imul and lmul instructions. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">intval_mul</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_mul</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≤</span> <span class="numeral">32</span>
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int32<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int64<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_mul</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Value <span class="main">::</span> <span class="quoted">times</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">times_Value</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">times_Value</span> <span class="main">=</span> intval_mul"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Java division rounds towards 0. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">intval_div</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_div</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≤</span> <span class="numeral">32</span>
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="keyword1">sdiv</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="keyword1">sdiv</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_div</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Value <span class="main">::</span> <span class="quoted">divide</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">divide_Value</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">divide_Value</span> <span class="main">=</span> intval_div"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Java % is a modulo operator that can give negative results, since div rounds towards 0. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">intval_mod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_mod</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≤</span> <span class="numeral">32</span>
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="keyword1">smod</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="keyword1">smod</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_mod</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> Value <span class="main">::</span> <span class="quoted">modulo</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">modulo_Value</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">modulo_Value</span> <span class="main">=</span> intval_mod"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* unsuccessful try at a bitwise generic binary operator:
fun intval_binary :: "('a word ⇒ 'a word ⇒ 'a word) ⇒ Value ⇒ Value ⇒ Value" where
  "intval_binary op (IntVal b1 v1) (IntVal b2 v2) = 
     (if b1 ≤ 32 ∧ b2 ≤ 32
       then (IntVal 32 (sint(op (word_of_int v1 :: 32 word) (word_of_int v2 :: 32 word))))
       else (IntVal 64 (sint((word_of_int v1 :: int64) + (word_of_int v2 :: int64)))))" |
  "intval_binary _ _ _ = UndefVal"
*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">intval_and</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&amp;&amp;*</span>"</span> 64<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_and</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≤</span> <span class="numeral">32</span>
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int32<span class="main">)</span> <span class="keyword1">AND</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int64<span class="main">)</span> <span class="keyword1">AND</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_and</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">intval_or</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">||*</span>"</span> 59<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_or</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≤</span> <span class="numeral">32</span>
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int32<span class="main">)</span> <span class="keyword1">OR</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int64<span class="main">)</span> <span class="keyword1">OR</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_or</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">intval_xor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> Value"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">^*</span>"</span> 59<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_xor</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="main">≤</span> <span class="numeral">32</span>
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int32<span class="main">)</span> <span class="keyword1">XOR</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">::</span> int64<span class="main">)</span> <span class="keyword1">XOR</span> <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">intval_xor</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>



<span class="comment1">(* Other possibly-helpful lemmas from WORD and its ancestors:

lemma signed_take_bit_add:
  ‹signed_take_bit n (signed_take_bit n k + signed_take_bit n l) = signed_take_bit n (k + l)›

lemma plus_dist:
  ‹Word.the_int (v + w) = take_bit LENGTH('a) (Word.the_int v + Word.the_int w)›
  for v w :: ‹'a::len word›
*)</span>

<span class="comment1">(* this follows from the definition of intval_add. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> intval_add_bits<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="free">b</span> <span class="free">res</span> <span class="main">=</span> intval_add <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">32</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">=</span> <span class="numeral">64</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> def<span class="main">:</span> <span class="quoted"><span class="quoted">"intval_add <span class="free">x</span> <span class="free">y</span> <span class="main">≠</span> UndefVal"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> IntVal <span class="skolem">b1</span> <span class="skolem">v1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Value.exhaust_sel def intval_add.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> IntVal <span class="skolem">b2</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Value.exhaust_sel def intval_add.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">,</span></span>7<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">,</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>
     ax<span class="main">:</span> <span class="quoted"><span class="quoted">"intval_add <span class="main">(</span>IntVal <span class="skolem">b1</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="skolem">b2</span> <span class="skolem">v2</span><span class="main">)</span> <span class="main">=</span> 
       <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b1</span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">≤</span> <span class="numeral">32</span> 
       <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="skolem">v1</span> <span class="main">::</span> int32<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>word_of_int <span class="skolem">v2</span> <span class="main">::</span> int32<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span>sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="skolem">v1</span> <span class="main">::</span> int64<span class="main">)</span> <span class="main">+</span> <span class="main">(</span>word_of_int <span class="skolem">v2</span> <span class="main">::</span> int64<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="var">?C</span> <span class="keyword1">then</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="var">?A</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="var">?B</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="free">b</span> <span class="free">res</span> <span class="main">=</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b x y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b1</span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">≤</span> <span class="numeral">32</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="skolem">b1</span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">≤</span> <span class="numeral">32</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b1</span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">≤</span> <span class="numeral">32</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r32<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="var">?A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ax <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">32</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r32 l b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">b1</span> <span class="main">≤</span> <span class="numeral">32</span> <span class="main">∧</span> <span class="skolem">b2</span> <span class="main">≤</span> <span class="numeral">32</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r64<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="var">?B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ax <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">64</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r64 l b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> word_add_sym<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"word_of_int <span class="free">v1</span> <span class="main">+</span> word_of_int <span class="free">v2</span> <span class="main">=</span> word_of_int <span class="free">v2</span> <span class="main">+</span> word_of_int <span class="free">v1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* commutative rules to be used when needed. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> intval_add_sym1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"intval_add <span class="main">(</span>IntVal <span class="free">b1</span> <span class="free">v1</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free">b2</span> <span class="free">v2</span><span class="main">)</span> <span class="main">=</span> intval_add <span class="main">(</span>IntVal <span class="free">b2</span> <span class="free">v2</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free">b1</span> <span class="free">v1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> word_add_sym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> intval_add_sym<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"intval_add <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> intval_add <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> intval_add_sym1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">y</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">lemma</span></span> wf_int32<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_value <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">32</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> int_bits_allowed"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf wf_value.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_bits_allowed_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
lemma int32_mod [simp]:
  assumes wf: "wf_value (IntVal w b)"
  assumes notbool: "w &gt; 1"
  shows "((b + 2^(w-1)) mod 2^w) = (b + 2^(w-1))"
  using wf notbool by auto
*)</span>

<span class="comment1">(* Any well-formed IntVal is equal to its underlying integer value. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> wf_int <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_value <span class="main">(</span>IntVal <span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> notbool<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="numeral">32</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sint<span class="main">(</span><span class="main">(</span>word_of_int <span class="free">n</span><span class="main">)</span> <span class="main">::</span> int32<span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> int_word_sint<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> wf notbool <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="comment1">(* Adding 0 is the identity, if (IntVal 32 b) is well-formed. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> add32_0<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> z<span class="main">:</span><span class="quoted"><span class="quoted">"wf_value <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"wf_value <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"intval_add <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span><span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> intval_add.simps word_of_int_0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> order_class.order.refl conj_absorb if_True<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> word_add_def uint_0_eq add_0<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> word_of_int_uint int_word_sint<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">code_deps</span></span> <span class="quoted"><span class="quoted">intval_add</span></span>  <span class="comment1">(* view dependency graph of code definitions *)</span>
<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">intval_add</span></span>  <span class="comment1">(* print all code definitions used by intval_add *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"intval_add <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">31</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">31</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> IntVal <span class="numeral">32</span> <span class="main">(</span><span class="main">-</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"intval_add <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">31</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">31</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> IntVal <span class="numeral">64</span> <span class="numeral">4294967294</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>