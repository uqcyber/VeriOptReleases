<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Stamp2</title>
</head>


<body>
<div class="head">
<h1>Theory Stamp2</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stamp Typing›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stamp2
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Values2.html">Values2</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The GraalVM compiler uses the Stamp class to store range and type information
for a given node in the IR graph.
We model the Stamp class as a datatype, Stamp, and provide a number of functions
on the datatype which correspond to the class methods within the compiler.

Stamp information is used in a variety of ways in optimizations, and so, we
additionally provide a number of lemmas which help to prove future optimizations.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> Stamp <span class="main">=</span> 
  VoidStamp
  <span class="main">|</span> IntegerStamp <span class="main">(</span><span class="free"><span class="entity">stp_bits</span></span><span class="main">:</span> <span class="quoted">nat</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">stpi_lower</span></span><span class="main">:</span> <span class="quoted">int</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">stpi_upper</span></span><span class="main">:</span> <span class="quoted">int</span><span class="main">)</span>
  <span class="comment1">(* | FloatStamp (stp_bits: nat) (stpf_lower: float) (stpf_upper: float) *)</span>
  <span class="main">|</span> KlassPointerStamp <span class="main">(</span><span class="free"><span class="entity">stp_nonNull</span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">stp_alwaysNull</span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span>
  <span class="main">|</span> MethodCountersPointerStamp <span class="main">(</span>stp_nonNull<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span>stp_alwaysNull<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span>
  <span class="main">|</span> MethodPointersStamp <span class="main">(</span>stp_nonNull<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span>stp_alwaysNull<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span>
  <span class="main">|</span> ObjectStamp <span class="main">(</span><span class="free"><span class="entity">stp_type</span></span><span class="main">:</span> <span class="quoted">string</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">stp_exactType</span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span>stp_nonNull<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span>stp_alwaysNull<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span>
  <span class="main">|</span> RawPointerStamp <span class="main">(</span>stp_nonNull<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span>stp_alwaysNull<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span>
  <span class="main">|</span> IllegalStamp

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bit_bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>int <span class="main">×</span> int<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bit_bounds</span> <span class="free"><span class="bound"><span class="entity">bits</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">bits</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">bits</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="comment1">(* NOTE: the FloatStamp has been commented out to allow use of code generation facilities *)</span>
<span class="comment1">(*
definition pos_infinity :: "float" where
  "pos_infinity = float_of (0 * 2 powr 255)"

definition neg_infinity :: "float" where
  "neg_infinity = -pos_infinity"
*)</span>

<span class="comment1">― ‹A stamp which includes the full range of the type›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unrestricted_stamp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unrestricted_stamp</span> VoidStamp <span class="main">=</span> VoidStamp"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unrestricted_stamp</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">bits</span></span></span> <span class="free"><span class="bound"><span class="entity">lower</span></span></span> <span class="free"><span class="bound"><span class="entity">upper</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">bits</span></span></span> <span class="main">(</span>fst <span class="main">(</span>bit_bounds <span class="free"><span class="bound"><span class="entity">bits</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>bit_bounds <span class="free"><span class="bound"><span class="entity">bits</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="comment1">(* "unrestricted_stamp (FloatStamp bits lower upper) = (FloatStamp bits neg_infinity pos_infinity)" |  *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">unrestricted_stamp</span> <span class="main">(</span>KlassPointerStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>KlassPointerStamp False False<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unrestricted_stamp</span> <span class="main">(</span>MethodCountersPointerStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MethodCountersPointerStamp False False<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unrestricted_stamp</span> <span class="main">(</span>MethodPointersStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MethodPointersStamp False False<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unrestricted_stamp</span> <span class="main">(</span>ObjectStamp <span class="free"><span class="bound"><span class="entity">type</span></span></span> <span class="free"><span class="bound"><span class="entity">exactType</span></span></span> <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ObjectStamp <span class="inner_quoted">''''</span> False False False<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">unrestricted_stamp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> IllegalStamp"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_stamp_unrestricted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_stamp_unrestricted</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> unrestricted_stamp <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹A stamp which provides type information but has an empty range of values›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">empty_stamp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_stamp</span> VoidStamp <span class="main">=</span> VoidStamp"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_stamp</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">bits</span></span></span> <span class="free"><span class="bound"><span class="entity">lower</span></span></span> <span class="free"><span class="bound"><span class="entity">upper</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">bits</span></span></span> <span class="main">(</span>snd <span class="main">(</span>bit_bounds <span class="free"><span class="bound"><span class="entity">bits</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>bit_bounds <span class="free"><span class="bound"><span class="entity">bits</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* "empty_stamp (FloatStamp bits lower upper) = (FloatStamp bits pos_infinity neg_infinity)" | *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_stamp</span> <span class="main">(</span>KlassPointerStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>KlassPointerStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_stamp</span> <span class="main">(</span>MethodCountersPointerStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MethodCountersPointerStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_stamp</span> <span class="main">(</span>MethodPointersStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MethodPointersStamp <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_stamp</span> <span class="main">(</span>ObjectStamp <span class="free"><span class="bound"><span class="entity">type</span></span></span> <span class="free"><span class="bound"><span class="entity">exactType</span></span></span> <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ObjectStamp <span class="inner_quoted">''''</span> True True False<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">empty_stamp</span> <span class="free"><span class="bound"><span class="entity">stamp</span></span></span> <span class="main">=</span> IllegalStamp"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_stamp_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_stamp_empty</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">lower</span></span></span> <span class="free"><span class="bound"><span class="entity">upper</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">upper</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lower</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* "is_stamp_empty (FloatStamp b lower upper) = (upper &lt; lower)" | *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_stamp_empty</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> False"</span></span>

<span class="comment1">― ‹Calculate the meet stamp of two stamps›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">meet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> Stamp <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meet</span> VoidStamp VoidStamp <span class="main">=</span> VoidStamp"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">meet</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> IllegalStamp <span class="keyword1">else</span> 
    <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">(</span>max <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* "meet (FloatStamp b1 l1 u1) (FloatStamp b2 l2 u2) = (
    if b1 ≠ b2 then IllegalStamp else 
    (FloatStamp b1 (min l1 l2) (max u1 u2))
  )" | *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">meet</span> <span class="main">(</span>KlassPointerStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span> <span class="main">(</span>KlassPointerStamp <span class="free"><span class="bound"><span class="entity">nn2</span></span></span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    KlassPointerStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">meet</span> <span class="main">(</span>MethodCountersPointerStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span> <span class="main">(</span>MethodCountersPointerStamp <span class="free"><span class="bound"><span class="entity">nn2</span></span></span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    MethodCountersPointerStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">meet</span> <span class="main">(</span>MethodPointersStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span> <span class="main">(</span>MethodPointersStamp <span class="free"><span class="bound"><span class="entity">nn2</span></span></span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    MethodPointersStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">meet</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> IllegalStamp"</span></span>

<span class="comment1">― ‹Calculate the join stamp of two stamps›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> Stamp <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> VoidStamp VoidStamp <span class="main">=</span> VoidStamp"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">u1</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> <span class="keyword1">then</span> IllegalStamp <span class="keyword1">else</span> 
    <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">(</span>max <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">u1</span></span></span> <span class="free"><span class="bound"><span class="entity">u2</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* "join (FloatStamp b1 l1 u1) (FloatStamp b2 l2 u2) = (
    if b1 ≠ b2 then IllegalStamp else 
    (FloatStamp b1 (max l1 l2) (min u1 u2))
  )" | *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">(</span>KlassPointerStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span> <span class="main">(</span>KlassPointerStamp <span class="free"><span class="bound"><span class="entity">nn2</span></span></span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">then</span> <span class="main">(</span>empty_stamp <span class="main">(</span>KlassPointerStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span>KlassPointerStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">(</span>MethodCountersPointerStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span> <span class="main">(</span>MethodCountersPointerStamp <span class="free"><span class="bound"><span class="entity">nn2</span></span></span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">then</span> <span class="main">(</span>empty_stamp <span class="main">(</span>MethodCountersPointerStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span>MethodCountersPointerStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="main">(</span>MethodPointersStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span> <span class="main">(</span>MethodPointersStamp <span class="free"><span class="bound"><span class="entity">nn2</span></span></span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">then</span> <span class="main">(</span>empty_stamp <span class="main">(</span>MethodPointersStamp <span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="free"><span class="bound"><span class="entity">an1</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span>MethodPointersStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nn1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">nn2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">an1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">an2</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> IllegalStamp"</span></span>

<span class="comment1">― ‹
In certain circumstances a stamp provides enough information to evaluate a value as a stamp,
the asConstant function converts the stamp to a value where one can be inferred.
›</span>
<span class="comment1">(* NOTE: we could also add a 32-bit version of this if needed. *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">asConstant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">asConstant</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> IntVal64 <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">else</span> UndefVal<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">asConstant</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="comment1">― ‹Determine if two stamps never have value overlaps i.e. their join is empty›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">alwaysDistinct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> Stamp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alwaysDistinct</span> <span class="free"><span class="bound"><span class="entity">stamp1</span></span></span> <span class="free"><span class="bound"><span class="entity">stamp2</span></span></span> <span class="main">=</span> is_stamp_empty <span class="main">(</span>join <span class="free"><span class="bound"><span class="entity">stamp1</span></span></span> <span class="free"><span class="bound"><span class="entity">stamp2</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Determine if two stamps must always be the same value i.e. two equal constants›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">neverDistinct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> Stamp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">neverDistinct</span> <span class="free"><span class="bound"><span class="entity">stamp1</span></span></span> <span class="free"><span class="bound"><span class="entity">stamp2</span></span></span> <span class="main">=</span> <span class="main">(</span>asConstant <span class="free"><span class="bound"><span class="entity">stamp1</span></span></span> <span class="main">=</span> asConstant <span class="free"><span class="bound"><span class="entity">stamp2</span></span></span> <span class="main">∧</span> asConstant <span class="free"><span class="bound"><span class="entity">stamp1</span></span></span> <span class="main">≠</span> UndefVal<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">constantAsStamp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">constantAsStamp</span> <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntegerStamp <span class="main">(</span>nat <span class="numeral">32</span><span class="main">)</span> <span class="main">(</span>sint <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>sint <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">constantAsStamp</span> <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntegerStamp <span class="main">(</span>nat <span class="numeral">64</span><span class="main">)</span> <span class="main">(</span>sint <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>sint <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* TODO: float *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">constantAsStamp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> IllegalStamp"</span></span>

<span class="comment1">― ‹Define when a runtime value is valid for a stamp›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> Value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_value</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">=</span><span class="numeral">32</span> <span class="main">∧</span> <span class="main">(</span>sint <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>sint <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_value</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">=</span><span class="numeral">64</span> <span class="main">∧</span> <span class="main">(</span>sint <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>sint <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* "valid_value (FloatStamp b1 l h) (FloatVal b2 v) = ((b1 = b2) ∧ (v ≥ l) ∧ (v ≤ h))" | *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_value</span> <span class="main">(</span>VoidStamp<span class="main">)</span> <span class="main">(</span>UndefVal<span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_value</span> <span class="main">(</span>ObjectStamp <span class="free"><span class="bound"><span class="entity">klass</span></span></span> <span class="free"><span class="bound"><span class="entity">exact</span></span></span> <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="free"><span class="bound"><span class="entity">alwaysNull</span></span></span><span class="main">)</span> <span class="main">(</span>ObjRef <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">nonNull</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">ref</span></span></span><span class="main">≠</span>None <span class="keyword1">else</span> True<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_value</span> <span class="free"><span class="bound"><span class="entity">stamp</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> False"</span></span>
<span class="comment1">(* TODO: add the other stamps:
  | KlassPointerStamp (stp_nonNull: bool) (stp_alwaysNull: bool)
  | MethodCountersPointerStamp (stp_nonNull: bool) (stp_alwaysNull: bool)
  | MethodPointersStamp (stp_nonNull: bool) (stp_alwaysNull: bool)
  | RawPointerStamp (stp_nonNull: bool) (stp_alwaysNull: bool)
*)</span>

<span class="comment1">― ‹
The most common type of stamp within the compiler (apart from the VoidStamp) is a 32 bit
integer stamp with an unrestricted range. We use <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">default_stamp</span><span class="antiquote">}</span></span> as it is a frequently used stamp.
›</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">default_stamp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">default_stamp</span> <span class="main">=</span> <span class="main">(</span>unrestricted_stamp <span class="main">(</span>IntegerStamp <span class="numeral">32</span> <span class="main">0</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>