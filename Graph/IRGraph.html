<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory IRGraph</title>
</head>


<body>
<div class="head">
<h1>Theory IRGraph</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Graph Representation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> IRGraph
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="IRNodeHierarchy.html">IRNodeHierarchy</a>
    <a href="Stamp.html">Stamp</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL/Relation.html">HOL.Relation</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory defines the main Graal data structure - an entire IR Graph.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
IRGraph is defined as a partial map with a finite domain.
The finite domain is required to be able to generate code and produce an interpreter.
›</span></span>
<span class="keyword1"><span class="command">typedef</span></span> IRGraph <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span> <span class="main">::</span> ID <span class="main">⇀</span> <span class="main">(</span>IRNode <span class="main">×</span> Stamp<span class="main">)</span> <span class="main">.</span> finite <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite<span class="main">(</span>dom<span class="main">(</span>Map.empty<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> ran Map.empty <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_IRGraph

<span class="keyword1"><span class="command">lift_definition</span></span> ids <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID set"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">nid</span></span> <span class="main">∈</span> dom <span class="bound">g</span> <span class="main">.</span> <span class="main">∄</span><span class="bound">s</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">nid</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>NoNode<span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">with_default</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">with_default</span> <span class="free"><span class="bound"><span class="entity">def</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">m</span> <span class="bound">k</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">def</span></span></span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> kind <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">⇒</span> IRNode<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"with_default NoNode fst"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> stamp <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> Stamp"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"with_default IllegalStamp snd"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> add_node <span class="main">::</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> <span class="main">(</span>IRNode <span class="main">×</span> Stamp<span class="main">)</span> <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">nid</span> <span class="bound">k</span> <span class="bound">g</span><span class="main">.</span> <span class="keyword1">if</span> fst <span class="bound">k</span> <span class="main">=</span> NoNode <span class="keyword1">then</span> <span class="bound">g</span> <span class="keyword1">else</span> <span class="bound">g</span><span class="main">(</span><span class="bound">nid</span> <span class="main">↦</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> remove_node <span class="main">::</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">nid</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span><span class="main">(</span><span class="bound">nid</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> replace_node <span class="main">::</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> <span class="main">(</span>IRNode <span class="main">×</span> Stamp<span class="main">)</span> <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">nid</span> <span class="bound">k</span> <span class="bound">g</span><span class="main">.</span> <span class="keyword1">if</span> fst <span class="bound">k</span> <span class="main">=</span> NoNode <span class="keyword1">then</span> <span class="bound">g</span> <span class="keyword1">else</span> <span class="bound">g</span><span class="main">(</span><span class="bound">nid</span> <span class="main">↦</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> as_list <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> IRNode <span class="main">×</span> Stamp<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">g</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> the <span class="main">(</span><span class="bound">g</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>dom <span class="bound">g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">no_node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ID <span class="main">×</span> <span class="main">(</span>IRNode <span class="main">×</span> Stamp<span class="main">)</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> <span class="main">(</span>IRNode <span class="main">×</span> Stamp<span class="main">)</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">no_node</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="bound">n</span><span class="main">)</span> <span class="main">≠</span> NoNode<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> irgraph <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ID <span class="main">×</span> <span class="main">(</span>IRNode <span class="main">×</span> Stamp<span class="main">)</span><span class="main">)</span> list <span class="main">⇒</span> IRGraph"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">∘</span> no_node"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_dom_map_of<span class="main">)</span>

<span class="comment1">(* Theories are required for code generation to work *)</span>
<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">irgraph</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filter_none</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_none</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">nid</span></span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">.</span> <span class="main">∄</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">nid</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>NoNode<span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_node_clears<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> no_node <span class="free">xs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">res</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> NoNode<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> NoNode"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter_none <span class="main">(</span>map_of <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span>map_of <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filter_none.simps <span class="keyword1"><span class="command">using</span></span> assms map_of_SomeD
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> fil_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter_none <span class="main">(</span>map_of <span class="main">(</span>no_node <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>no_node <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_node_clears
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_eq dom_map_of_conv_image_fst list.set_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> irgraph<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ids <span class="main">(</span>irgraph <span class="free">m</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>no_node <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> irgraph_def ids_def <span class="keyword1"><span class="command">using</span></span> fil_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Rep_IRGraph comp_apply eq_onp_same_args filter_none.simps ids.abs_eq ids_def irgraph.abs_eq irgraph.rep_eq irgraph_def mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_IRGraph <span class="main">(</span>irgraph <span class="free">m</span><span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span>no_node <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_IRGraph_inverse
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irgraph.rep_eq<span class="main">)</span>


<span class="comment1">― ‹Get the inputs set of a given node ID›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inputs</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> set <span class="main">(</span>inputs_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹Get the successor set of a given node ID›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> set <span class="main">(</span>successors_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹Gives a relation between node IDs - between a node and its input nodes›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">input_edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">input_edges</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">i</span> <span class="main">∈</span> ids <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">|</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">(</span>inputs <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹Find all the nodes in the graph that have nid as an input - the usages of nid›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">usages</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">usages</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> ids <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="main">∈</span> input_edges <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">successor_edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">successor_edges</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">i</span> <span class="main">∈</span> ids <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">|</span><span class="bound">j</span> <span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">(</span>succ  <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">predecessors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">predecessors</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> ids <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="main">∈</span> successor_edges <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nodes_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>IRNode <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> ID set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nodes_of</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">nid</span></span> <span class="main">∈</span> ids <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">nid</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">edge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IRNode <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> ID <span class="main">⇒</span> IRGraph <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">edge</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sel</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filtered_inputs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> <span class="main">(</span>IRNode <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> ID list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filtered_inputs</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∘</span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inputs_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filtered_successors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> <span class="main">(</span>IRNode <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> ID list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filtered_successors</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∘</span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>successors_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filtered_usages</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> <span class="main">(</span>IRNode <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> ID set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filtered_usages</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">n</span></span> <span class="main">∈</span> <span class="main">(</span>usages <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">any_usage</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">any_usage</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> hd <span class="main">(</span>sorted_list_of_set <span class="main">(</span>usages <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ids_some<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ids <span class="free">g</span> <span class="main">⟷</span> kind <span class="free">g</span> <span class="free">x</span> <span class="main">≠</span> NoNode"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> that<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ids <span class="free">g</span> <span class="main">⟶</span> kind <span class="free">g</span> <span class="free">x</span> <span class="main">≠</span> NoNode"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ids.rep_eq kind.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">x</span> <span class="main">≠</span> NoNode <span class="main">⟶</span> <span class="free">x</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> with_default.simps kind_def ids_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Rep_IRGraph <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> None"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_g<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> NoNode"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ids_some <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_creation<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span> <span class="main">⟷</span> Rep_IRGraph <span class="main">(</span>Abs_IRGraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_IRGraph_inverse <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_IRGraph mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ids <span class="free">g</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Rep_IRGraph ids.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ids <span class="main">(</span>irgraph <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_dom_map_of<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span> <span class="main">⟶</span> ids <span class="main">(</span>Abs_IRGraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">nid</span></span> <span class="main">∈</span> dom <span class="free">g</span> <span class="main">.</span> <span class="main">∄</span><span class="bound">s</span><span class="main">.</span> <span class="free">g</span> <span class="bound">nid</span> <span class="main">=</span> Some <span class="main">(</span>NoNode<span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ids.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span> <span class="main">⟶</span> kind <span class="main">(</span>Abs_IRGraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> NoNode <span class="main">|</span> Some <span class="bound">n</span> <span class="main">⇒</span> fst <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kind.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span> <span class="main">⟶</span> stamp <span class="main">(</span>Abs_IRGraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> IllegalStamp <span class="main">|</span> Some <span class="bound">n</span> <span class="main">⇒</span> snd <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> stamp.abs_eq stamp.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ids <span class="main">(</span>irgraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="main">(</span>no_node <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> irgraph <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="main">(</span>irgraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">nid</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>map_of <span class="main">(</span>no_node <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="bound">nid</span> <span class="keyword1">of</span> None <span class="main">⇒</span> NoNode <span class="main">|</span> Some <span class="bound">n</span> <span class="main">⇒</span> fst <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> irgraph.rep_eq kind.transfer kind.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stamp <span class="main">(</span>irgraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">nid</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>map_of <span class="main">(</span>no_node <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="bound">nid</span> <span class="keyword1">of</span> None <span class="main">⇒</span> IllegalStamp <span class="main">|</span> Some <span class="bound">n</span> <span class="main">⇒</span> snd <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> irgraph.rep_eq stamp.transfer stamp.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_of <span class="free">g</span><span class="main">)</span><span class="main">(</span><span class="free">k</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_of <span class="main">(</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* this proof should be simplier *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"replace_node <span class="free">nid</span> <span class="free">k</span> <span class="main">(</span>irgraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>irgraph <span class="main">(</span> <span class="main">(</span><span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="free">k</span> <span class="main">=</span> NoNode"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Rep_IRGraph_inject filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> irgraph.abs_eq no_node.simps replace_node.rep_eq snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> irgraph_def replace_node_def no_node.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Rep_IRGraph comp_apply eq_onp_same_args filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> id_def irgraph.rep_eq map_fun_apply map_of_upd mem_Collect_eq no_node.elims replace_node.abs_eq replace_node_def snd_eqD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"add_node <span class="free">nid</span> <span class="free">k</span> <span class="main">(</span>irgraph <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>irgraph <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">#</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Rep_IRGraph_inject add_node.rep_eq filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> irgraph.rep_eq map_of_upd no_node.simps snd_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_node_lookup<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">gup</span> <span class="main">=</span> add_node <span class="free">nid</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">g</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">≠</span> NoNode <span class="keyword1">then</span> kind <span class="free">gup</span> <span class="free">nid</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> stamp <span class="free">gup</span> <span class="free">nid</span> <span class="main">=</span> <span class="free">s</span> <span class="keyword1">else</span> kind <span class="free">gup</span> <span class="free">nid</span> <span class="main">=</span> kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> NoNode"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_node.rep_eq kind.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kind.rep_eq add_node.rep_eq stamp.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_node_lookup<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">gup</span> <span class="main">=</span> remove_node <span class="free">nid</span> <span class="free">g</span> <span class="main">⟶</span> kind <span class="free">gup</span> <span class="free">nid</span> <span class="main">=</span> NoNode <span class="main">∧</span> stamp <span class="free">gup</span> <span class="free">nid</span> <span class="main">=</span> IllegalStamp"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kind.rep_eq remove_node.rep_eq stamp.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_node_lookup<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">gup</span> <span class="main">=</span> replace_node <span class="free">nid</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≠</span> NoNode <span class="main">⟶</span> kind <span class="free">gup</span> <span class="free">nid</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> stamp <span class="free">gup</span> <span class="free">nid</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replace_node.rep_eq kind.rep_eq stamp.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_node_unchanged<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">gup</span> <span class="main">=</span> replace_node <span class="free">nid</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">g</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">n</span> <span class="main">∈</span> <span class="main">(</span>ids <span class="free">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">nid</span><span class="main">}</span><span class="main">)</span> <span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> ids <span class="free">g</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∈</span> ids <span class="free">gup</span> <span class="main">∧</span> kind <span class="free">g</span> <span class="bound">n</span> <span class="main">=</span> kind <span class="free">gup</span> <span class="bound">n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kind.rep_eq replace_node.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Example Graphs"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Example 1: empty graph (just a start and end node)"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">start_end_graph</span><span class="main">::</span> <span class="quoted">IRGraph</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">start_end_graph</span> <span class="main">=</span> irgraph <span class="main">[</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> StartNode None <span class="main">1</span><span class="main">,</span> VoidStamp<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> ReturnNode None None<span class="main">,</span> VoidStamp<span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Example 2:
  public static int sq(int x) { return x * x; }

             [1 P(0)]
               \ /
  [0 Start]   [4 *]
       |      /
       V     /
      [5 Return]
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eg2_sq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eg2_sq</span> <span class="main">=</span> irgraph <span class="main">[</span>
    <span class="main">(</span><span class="main">0</span><span class="main">,</span> StartNode None <span class="numeral">5</span><span class="main">,</span> VoidStamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="main">1</span><span class="main">,</span> ParameterNode <span class="main">0</span><span class="main">,</span> default_stamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">4</span><span class="main">,</span> MulNode <span class="main">1</span> <span class="main">1</span><span class="main">,</span> default_stamp<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="numeral">5</span><span class="main">,</span> ReturnNode <span class="main">(</span>Some <span class="numeral">4</span><span class="main">)</span> None<span class="main">,</span> default_stamp<span class="main">)</span>
   <span class="main">]</span>"</span></span>

<span class="comment1">(* TODO: to include the float type (used by stamps) we need
         a code equation for float_of but it is not clear how
         to implement this correctly
lemma[code]: "float_of n = 0"
*)</span>

<span class="comment1">(* Test the code generation. *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"input_edges eg2_sq"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"usages eg2_sq <span class="main">1</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</body>

</html>