<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹phase.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹phase.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Optimizations/DSL/phase.ML
    Author:     Brae Webb

Organisation of rules into phases.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>Rule</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>DSL_PHASE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span>
   </span><span>trm</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   </span><span>rules</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Map.map</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> current</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> phases</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> enter</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> exit</span><span class="main"><span>:</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>DSL_Phase</span></span><span class="main"><span>(</span></span><span>Rule</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Rule</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>DSL_PHASE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rule.T</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span>
   </span><span>trm</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   </span><span>rules</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Map.map</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>store</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Map.map</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>status</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>NoPhase</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>InPhase</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> binding

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>store</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>store</span></span><span class="main"><span>,</span></span><span>
   </span><span>status</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>status</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>store</span><span class="main"><span>=</span></span><span class="entity"><span>Map.empty</span></span><span class="main"><span>,</span></span><span> </span><span>status</span><span class="main"><span>=</span></span><span class="entity"><span>NoPhase</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_statuses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NoPhase</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NoPhase</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NoPhase</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge_statuses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NoPhase</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>InPhase</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>InPhase</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge_statuses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>InPhase</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NoPhase</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>InPhase</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge_statuses</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>InPhase</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>InPhase</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>ERROR</span><span> </span><span class="inner_quoted"><span>"oh no"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>PhaseData</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="main"><span>{</span></span><span>status</span><span class="main"><span>=</span></span><span class="entity"><span>merge_statuses</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>status</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>status</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span>store</span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Map.merge</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>store</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>store</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>PhaseData.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phase_name</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>status</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>NoPhase</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>InPhase</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phase_by_name</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span>option</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lookup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>store</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lookup</span></span><span> </span><span class="entity"><span>n</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>current</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phase_name</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>phase_by_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phase</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phases</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Map.values</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>store</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_phase</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phase</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>trm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>trm</span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span>rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Map.insert</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rules</span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_rule'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phase'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>expand_phase</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Map.insert</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>store</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phase'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>{</span></span><span>status</span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>status</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> </span><span>store</span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>data'</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_rule</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>status</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>NoPhase</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Optimization phase missing"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span>
      </span><span class="entity"><span>InPhase</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>phase_by_name</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Optimization phase missing"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>insert_rule'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="entity"><span>data</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>data'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>PhaseData.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_rule</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_phase</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>trm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>,</span></span><span> </span><span>rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Map.empty</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enter'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>PhaseData.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>status</span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>NoPhase</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>status</span><span class="main"><span>=</span></span><span class="entity"><span>InPhase</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>store</span><span class="main"><span>=</span></span><span class="entity"><span>Map.insert</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>store</span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_phase</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>InPhase</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"optimization phase already established"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Proof_Context.init_global</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>enter'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.read_term_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exit'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>PhaseData.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>status</span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>NoPhase</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"no phase to exit"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>InPhase</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>status</span><span class="main"><span>=</span></span><span class="entity"><span>NoPhase</span></span><span class="main"><span>,</span></span><span> </span><span>store</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>store</span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.background_theory</span><span> </span><span class="entity"><span>exit'</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_bind</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Pretty.markup</span><span> 
    </span><span class="main"><span>(</span></span><span>Position.markup</span><span> </span><span class="main"><span>(</span></span><span>Binding.pos_of</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span> </span><span>Markup.position</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_phase</span></span><span> </span><span class="entity"><span>obligation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phase</span></span><span class="main"><span>:</span></span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Pretty.block</span><span> 
    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"phase: "</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_bind</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
     </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"trm: "</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>trm</span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
     </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"rules:"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rule.pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>obligation</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Map.values</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rules</span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty</span></span><span> </span><span class="entity"><span>obligation</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>pretty_phase</span></span><span> </span><span class="entity"><span>obligation</span></span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty'</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>status</span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>NoPhase</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"No phase"</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>InPhase</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Map.lookup</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>store</span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>ERROR</span><span> </span><span class="inner_quoted"><span>"Bug"</span></span><span> </span><span class="main"><span>|</span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty_phase</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty''</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="entity"><span>pretty'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Local_Theory.init</span><span> 
    </span><span class="main"><span>{</span></span><span>background_naming</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.naming_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span>
        </span><span>setup</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>enter</span></span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>,</span></span><span>
        </span><span>conclude</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exit</span></span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>{</span></span><span>define</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Target.define</span></span><span> </span><span class="entity"><span>Generic_Target.theory_target_foundation</span></span><span class="main"><span>,</span></span><span>
        </span><span>notes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Target.notes</span></span><span> </span><span class="entity"><span>Generic_Target.theory_target_notes</span></span><span class="main"><span>,</span></span><span>
        </span><span>abbrev</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Target.abbrev</span></span><span> </span><span class="entity"><span>Generic_Target.theory_target_abbrev</span></span><span class="main"><span>,</span></span><span>
        </span><span>declaration</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>Generic_Target.theory_declaration</span></span><span class="main"><span>,</span></span><span>
        </span><span>theory_registration</span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>Generic_Target.theory_registration</span></span><span class="main"><span>,</span></span><span>
        </span><span>locale_dependency</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Not possible in instantiation target"</span></span><span class="main"><span>,</span></span><span>
        </span><span>pretty</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pretty''</span></span><span class="main"><span>}</span></span><span>
    </span><span class="entity"><span>thy</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span></pre>
</body>

</html>