<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹rewrites.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹rewrites.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Optimizations/DSL/rewrites.ML
    Author:     Brae Webb

Generate proof obligation for expression rewrites.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>RewriteSystem</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> preservation</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> termination</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> intval</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>DSL_REWRITES</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> of_term</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> preservation_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> termination_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rewrite_cmd</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>DSL_Rewrites</span></span><span class="main"><span>(</span></span><span>System</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>RewriteSystem</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>DSL_REWRITES</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>of_term</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>source</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Markup.Rewrite.Transform"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>rewrite</span><span class="main"><span>=</span></span><span class="entity"><span>Transform</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>proofs</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>code</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>source</span><span class="main"><span>=</span></span><span class="entity"><span>source</span></span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Markup.Rewrite.Conditional"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>cond</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>rewrite</span><span class="main"><span>=</span></span><span class="entity"><span>Conditional</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cond</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>proofs</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>code</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>source</span><span class="main"><span>=</span></span><span class="entity"><span>source</span></span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"optimization is not a rewrite"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>term</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_term</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rewrite</span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Transform</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Markup.Rewrite.Transform"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><a class="entity_ref" href="../../../../../Markup.html#Markup.Rewrite|type"><span>Rewrite</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Conditional</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cond</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Markup.Rewrite.Conditional"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><a class="entity_ref" href="../../../../../Markup.html#Markup.Rewrite|type"><span>Rewrite</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>cond</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rewrite cannot be translated yet"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>:</span></span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Markup.Rewrite.Transform"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="entity"><span>lhs</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Markup.Rewrite.Conditional"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="entity"><span>lhs</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"optimization is not a rewrite"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>term</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>:</span></span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Markup.Rewrite.Transform"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="entity"><span>rhs</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Markup.Rewrite.Conditional"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span class="entity"><span>rhs</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"optimization is not a rewrite"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>term</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preservation_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Syntax.check_prop</span><span> </span><span class="entity"><span>ctxt</span></span><span> 
    </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>System.preservation</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_term</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>termination_of'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Syntax.check_prop</span><span> </span><span class="entity"><span>ctxt</span></span><span> 
    </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>System.termination</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_term</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intval_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Syntax.check_prop</span><span> </span><span class="entity"><span>ctxt</span></span><span> 
    </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>System.intval</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>value_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Pure.eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><span>prop</span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span>
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"val_"</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"HOL.eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../Graph/Values.html#Values.Value|type"><span>Value</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../Graph/Values.html#Values.Value|type"><span>Value</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IntValMarkup.markup_expr</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IntValMarkup.markup_expr</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>val_def_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span>
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"HOL.eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span>
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"val_"</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"HOL.eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(*$ Var (("x", 0), @{typ int})*)</span></span><span>
      </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="numeral"><span>10</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../HOL/HOL/Groups.html#Groups.plus_class.plus|const"><span>+</span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../../../../../../HOL/HOL/Groups.html#Groups.uminus_class.uminus|const"><span>-</span></a></span><span class="main"><span>(</span></span><span class="numeral"><span>12</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span>
      </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="numeral"><span>10</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../HOL/HOL/Groups.html#Groups.plus_class.plus|const"><span>+</span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../../../../../../HOL/HOL/Groups.html#Groups.uminus_class.uminus|const"><span>-</span></a></span><span class="main"><span>(</span></span><span class="numeral"><span>12</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../HOL/HOL/Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>word_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"HOL.eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span>
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"word_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span>
      </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"HOL.eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../HOL/HOL-Library/Type_Length.html#Type_Length.len|class"><span>len</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL-Library/Word.html#Word.word|type"><span>word</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="tfree"><span>'a</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL-Library/Word.html#Word.word|type"><span>word</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>WordMarkup.markup_expr</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>WordMarkup.markup_expr</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>termination_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RewritePhase.current</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Optimization phase missing"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>phase</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>trm</span><span> </span><span class="entity"><span>phase</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>termination_of'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trm</span></span><span> </span><span class="entity"><span>rewrite</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span> 
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"HOL.eq"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/Option.html#Option.option|type"><span>option</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/Option.html#Option.option|type"><span>option</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span>
  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_code"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>typ</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/Option.html#Option.option|type"><span>option</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>$</span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>‹</span><span class="main"><span>λ</span></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>x</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../../../HOL/HOL/Option.html#Option.option.None|const"><span>None</span></a><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../Semantics/IRTreeEval.html#IRTreeEval.IRExpr|type"><span>IRExpr</span></a><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/Option.html#Option.option|type"><span>option</span></a><span class="main"><span>)</span></span><span>›</span></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_proofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proofs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>
    </span><span>name</span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>,</span></span><span>
    </span><span>rewrite</span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>rewrite</span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>,</span></span><span>
    </span><span>proofs</span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span>
    </span><span>code</span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>code</span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>,</span></span><span>
    </span><span>source</span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>source</span><span> </span><span class="entity"><span>rewrite</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intval</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>token</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Token.content_of</span><span> </span><span class="entity"><span>token</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"intval"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subgoals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>token</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Token.content_of</span><span> </span><span class="entity"><span>token</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"subgoals"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.parse_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>opt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IRExprMarkup.markup_expr</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>raw_term</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_term</span></span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>raw_term</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>subgoals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Specification.abbreviation</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.mode_default</span><span class="main"><span>)</span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>val_def_const</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_term</span></span><span class="main"><span>)</span></span><span>
        </span><span>false</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="comment1"><span>(*((Binding.prefix_name "val_" bind, []), value_def ctxt (#name rewrite) raw_term) ctxt)*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*val ctxt = (if subgoals then
      snd (Specification.definition
        NONE [] []
        ((Binding.prefix_name "val_" bind, []), value_def ctxt (#name rewrite) raw_term) ctxt)
      else ctxt);*)</span></span><span>

    </span><span class="comment1"><span>(*val ctxt = (if subgoals then
      (Specification.abbreviation (Syntax.mode_default)
        NONE []
        (word_def ctxt (#name rewrite) raw_term)
        false ctxt)
      else ctxt);*)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intval_preservation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>intval</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>intval_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IntValMarkup.markup_expr</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>term</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Syntax.parse_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>opt</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a></span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>intval</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>intval_preservation</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>intval_preservation</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preservation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>preservation_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preservation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>intval</span></span><span> 
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>"</span><span>Pure.imp</span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="entity"><span>intval_preservation</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>preservation</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>preservation</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>termination</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>termination_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rewrite</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>register</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>proofs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>RewritePhase.register</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bind</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_proofs</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.background_theory</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Specification.definition</span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_code"</span></span><span> </span><span class="entity"><span>bind</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>code</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>lthy'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bind</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> 
        </span><span class="main"><span>[</span></span><span class="entity"><span>extra</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>preservation</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>preservation</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>termination</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>termination</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.apply</span></span><span> 
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Method.Source</span></span><span> </span><span class="main"><span>(</span></span><span>Token.make_src</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unfold_optimization"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.start</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>Position.no_range</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>target</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.hd</span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span>Seq.Result</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>Seq.Error</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>target</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.apply</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Method.Source</span></span><span> </span><span class="main"><span>(</span></span><span>Token.make_src</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unfold_size"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.start</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span>Position.no_range</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.defer</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.hd</span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span>Seq.Result</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>Seq.Error</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>result</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span></pre>
</body>

</html>