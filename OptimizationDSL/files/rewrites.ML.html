<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹rewrites.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹rewrites.ML›</h1>
</div>

<pre class="source"><span class="comment1">(*  Title:      Optimizations/DSL/rewrites.ML
    Author:     Brae Webb

Generate proof obligation for expression rewrites.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">RewriteSystem</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
<span class="keyword1"><span class="keyword">val</span></span> preservation<span class="main">:</span> term<span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> termination<span class="main">:</span> term<span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> intval<span class="main">:</span> term<span class="main">;</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">DSL_REWRITES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
<span class="keyword1"><span class="keyword">val</span></span> of_term<span class="main">:</span> binding <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term <span class="main">-&gt;</span> <span class="entity">rewrite</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> preservation_of<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">rewrite</span> <span class="main">-&gt;</span> term<span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> termination_of<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">rewrite</span> <span class="main">-&gt;</span> term<span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> code_of<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">rewrite</span> <span class="main">-&gt;</span> term<span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> rewrite_cmd<span class="main">:</span> <span class="main">(</span>binding * Token.src list<span class="main">)</span> * string <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">Proof.state</span><span class="main">;</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">functor</span></span> <span class="entity">DSL_Rewrites</span><span class="main">(</span>System<span class="main">:</span> <span class="entity">RewriteSystem</span><span class="main">)</span><span class="main">:</span> <span class="entity">DSL_REWRITES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">of_term</span> <span class="entity">name</span> <span class="entity">term</span> <span class="entity">source</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">term</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="main">(</span><span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Markup.Rewrite.Transform"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">lhs</span><span class="main">)</span> $ <span class="entity">rhs</span><span class="main">)</span> <span class="main">=&gt;</span> 
      <span class="main">{</span>name<span class="main">=</span><span class="entity">name</span><span class="main">,</span> rewrite<span class="main">=</span><span class="entity">Transform</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">)</span><span class="main">,</span> proofs<span class="main">=</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> code<span class="main">=</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> source<span class="main">=</span><span class="entity">source</span><span class="main">}</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Markup.Rewrite.Conditional"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">lhs</span><span class="main">)</span> $ <span class="entity">rhs</span><span class="main">)</span> $ <span class="entity">cond</span><span class="main">)</span> <span class="main">=&gt;</span> 
      <span class="main">{</span>name<span class="main">=</span><span class="entity">name</span><span class="main">,</span> rewrite<span class="main">=</span><span class="entity">Conditional</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">,</span> <span class="entity">cond</span><span class="main">)</span><span class="main">,</span> proofs<span class="main">=</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> code<span class="main">=</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> source<span class="main">=</span><span class="entity">source</span><span class="main">}</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"optimization is not a rewrite"</span><span class="main">,</span> <span class="main">[</span><span class="entity">term</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">to_term</span> <span class="entity">rewrite</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">case</span></span> <span class="main">(</span><span class="main">#</span>rewrite <span class="entity">rewrite</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="entity">Transform</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">)</span> <span class="main">=&gt;</span> 
      <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Markup.Rewrite.Transform"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"IRExpr <span class="main">=&gt;</span> IRExpr <span class="main">=&gt;</span> IRExpr Rewrite"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span> $ <span class="entity">lhs</span> $ <span class="entity">rhs</span>
    <span class="main">|</span> <span class="entity">Conditional</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">,</span> <span class="entity">cond</span><span class="main">)</span> <span class="main">=&gt;</span> 
      <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Markup.Rewrite.Conditional"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"IRExpr <span class="main">=&gt;</span> IRExpr <span class="main">⇒</span> bool <span class="main">⇒</span> IRExpr Rewrite"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span> $ <span class="entity">lhs</span> $ <span class="entity">rhs</span> $ <span class="entity">cond</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"rewrite cannot be translated yet"</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lhs</span> <span class="main">(</span><span class="entity">term</span><span class="main">:</span>term<span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">term</span> <span class="keyword2"><span class="keyword">of</span></span>
  <span class="main">(</span><span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Markup.Rewrite.Transform"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">lhs</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> 
      <span class="entity">lhs</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Markup.Rewrite.Conditional"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">lhs</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> 
      <span class="entity">lhs</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"optimization is not a rewrite"</span><span class="main">,</span> <span class="main">[</span><span class="entity">term</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rhs</span> <span class="main">(</span><span class="entity">term</span><span class="main">:</span>term<span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">term</span> <span class="keyword2"><span class="keyword">of</span></span>
  <span class="main">(</span><span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Markup.Rewrite.Transform"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> $ <span class="entity">rhs</span><span class="main">)</span> <span class="main">=&gt;</span> 
      <span class="entity">rhs</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Markup.Rewrite.Conditional"</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> $ <span class="entity">rhs</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> 
      <span class="entity">rhs</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"optimization is not a rewrite"</span><span class="main">,</span> <span class="main">[</span><span class="entity">term</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">preservation_of</span> <span class="entity">ctxt</span> <span class="entity">rewrite</span> <span class="main">=</span>
  Syntax.check_prop <span class="entity">ctxt</span> 
    <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="entity">System.preservation</span> $ <span class="main">(</span><span class="entity">to_term</span> <span class="entity">rewrite</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">termination_of'</span> <span class="entity">ctxt</span> <span class="entity">trm</span> <span class="entity">rewrite</span> <span class="main">=</span>
  Syntax.check_prop <span class="entity">ctxt</span> 
    <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="entity">System.termination</span> $ <span class="main">(</span><span class="entity">to_term</span> <span class="entity">rewrite</span><span class="main">)</span> $ <span class="entity">trm</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">intval_of</span> <span class="entity">ctxt</span> <span class="entity">term</span> <span class="main">=</span>
  Syntax.check_prop <span class="entity">ctxt</span> 
    <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="entity">System.intval</span> $ <span class="entity">term</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">value_def</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="entity">rewrite</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Pure.eq"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"bool <span class="main">⇒</span> bool <span class="main">⇒</span> prop"</span><span class="antiquote">}</span></span><span class="main">)</span>
  $ <span class="main">(</span>Free <span class="main">(</span><span class="inner_quoted">"val_"</span> ^ <span class="main">(</span>Binding.name_of <span class="entity">name</span><span class="main">)</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"bool"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
  $ <span class="main">(</span>
      <span class="main">(</span><span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"HOL.eq"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"Value <span class="main">⇒</span> Value <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
      $ <span class="main">(</span><span class="entity">IntValMarkup.markup_expr</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">lhs</span> <span class="entity">rewrite</span><span class="main">]</span><span class="main">)</span>
      $ <span class="main">(</span><span class="entity">IntValMarkup.markup_expr</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rhs</span> <span class="entity">rewrite</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">val_def_const</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="entity">rewrite</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span>
  $ <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"HOL.eq"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"bool <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span><span class="main">)</span>
  $ <span class="main">(</span>Free <span class="main">(</span><span class="inner_quoted">"val_"</span> ^ <span class="main">(</span>Binding.name_of <span class="entity">name</span><span class="main">)</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"bool"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
  $ <span class="main">(</span>
      <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"HOL.eq"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
      <span class="comment1">(*$ Var (("x", 0), @{typ int})*)</span>
      $ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(</span><span class="numeral">10</span><span class="main">::</span>int<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="numeral">12</span><span class="main">::</span>int<span class="main">)</span><span class="main">)</span>"</span><span class="antiquote">}</span></span>
      $ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(</span><span class="numeral">10</span><span class="main">::</span>int<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="numeral">12</span><span class="main">::</span>int<span class="main">)</span><span class="main">)</span>"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">word_def</span> <span class="entity">ctxt</span> <span class="entity">name</span> <span class="entity">rewrite</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"HOL.eq"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"bool <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span><span class="main">)</span>
  $ <span class="main">(</span>Free <span class="main">(</span><span class="inner_quoted">"word_"</span> ^ <span class="entity">name</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"bool"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
  $ <span class="main">(</span>
      <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span>
      $ <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"HOL.eq"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len<span class="main">)</span> word <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
      $ <span class="main">(</span><span class="entity">WordMarkup.markup_expr</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">lhs</span> <span class="entity">rewrite</span><span class="main">]</span><span class="main">)</span>
      $ <span class="main">(</span><span class="entity">WordMarkup.markup_expr</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rhs</span> <span class="entity">rewrite</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">termination_of</span> <span class="entity">ctxt</span> <span class="entity">rewrite</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">state</span> <span class="main">=</span> <span class="entity">RewritePhase.current</span> <span class="main">(</span>Proof_Context.theory_of <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trm</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">state</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"Optimization phase missing"</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">|</span>
      SOME <span class="entity">phase</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">#</span>trm <span class="entity">phase</span><span class="main">)</span>
    <span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">termination_of'</span> <span class="entity">ctxt</span> <span class="entity">trm</span> <span class="entity">rewrite</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">code_of</span> <span class="main">_</span> <span class="entity">rewrite</span> <span class="main">=</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> 
  $ <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"HOL.eq"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="main">(</span>IRExpr <span class="main">⇒</span> IRExpr option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>IRExpr <span class="main">⇒</span> IRExpr option<span class="main">)</span> <span class="main">⇒</span> bool"</span><span class="antiquote">}</span></span><span class="main">)</span>
  $ <span class="main">(</span>Free <span class="main">(</span><span class="main">(</span>Binding.name_of <span class="main">(</span><span class="main">#</span>name <span class="entity">rewrite</span><span class="main">)</span><span class="main">)</span> ^ <span class="inner_quoted">"_code"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr option"</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
  $ <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">‹<span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">::</span>IRExpr<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>None<span class="main">::</span>IRExpr option<span class="main">)</span>›</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_proofs</span> <span class="main">(</span><span class="entity">rewrite</span><span class="main">:</span> <span class="entity">rewrite</span><span class="main">)</span> <span class="entity">proofs</span> <span class="main">=</span>
  <span class="main">{</span>
    name<span class="main">=</span> <span class="main">#</span>name <span class="entity">rewrite</span><span class="main">,</span>
    rewrite<span class="main">=</span> <span class="main">#</span>rewrite <span class="entity">rewrite</span><span class="main">,</span>
    proofs<span class="main">=</span> <span class="entity">proofs</span><span class="main">,</span>
    code<span class="main">=</span> <span class="main">#</span>code <span class="entity">rewrite</span><span class="main">,</span>
    source<span class="main">=</span> <span class="main">#</span>source <span class="entity">rewrite</span>
  <span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite_cmd</span> <span class="main">(</span><span class="main">(</span><span class="entity">bind</span><span class="main">,</span> <span class="entity">options</span><span class="main">)</span><span class="main">,</span> <span class="entity">opt</span><span class="main">)</span> <span class="entity">ctxt</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">intval</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">options</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">[</span><span class="entity">token</span><span class="main">]</span><span class="main">]</span> <span class="main">=&gt;</span> Token.content_of <span class="entity">token</span> <span class="main">=</span> <span class="inner_quoted">"intval"</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subgoals</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">options</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">[</span><span class="entity">token</span><span class="main">]</span><span class="main">]</span> <span class="main">=&gt;</span> Token.content_of <span class="entity">token</span> <span class="main">=</span> <span class="inner_quoted">"subgoals"</span> <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">raw_term</span> <span class="main">=</span> <span class="main">(</span>Syntax.parse_term <span class="entity">ctxt</span> <span class="entity">opt</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term</span> <span class="main">=</span> <span class="entity">IRExprMarkup.markup_expr</span> <span class="main">[</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">raw_term</span><span class="main">]</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rewrite</span> <span class="main">=</span> <span class="entity">of_term</span> <span class="entity">bind</span> <span class="entity">term</span> <span class="entity">raw_term</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">subgoals</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span><span class="entity">Specification.abbreviation</span> <span class="main">(</span>Syntax.mode_default<span class="main">)</span>
        NONE <span class="main">[</span><span class="main">]</span>
        <span class="main">(</span><span class="entity">val_def_const</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="main">#</span>name <span class="entity">rewrite</span><span class="main">)</span> <span class="entity">raw_term</span><span class="main">)</span>
        false <span class="entity">ctxt</span><span class="main">)</span>
        <span class="comment1">(*((Binding.prefix_name "val_" bind, []), value_def ctxt (#name rewrite) raw_term) ctxt)*)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>

    <span class="comment1">(*val ctxt = (if subgoals then
      snd (Specification.definition
        NONE [] []
        ((Binding.prefix_name "val_" bind, []), value_def ctxt (#name rewrite) raw_term) ctxt)
      else ctxt);*)</span>

    <span class="comment1">(*val ctxt = (if subgoals then
      (Specification.abbreviation (Syntax.mode_default)
        NONE []
        (word_def ctxt (#name rewrite) raw_term)
        false ctxt)
      else ctxt);*)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">intval_preservation</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">intval</span> 
      <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">intval_of</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">IntValMarkup.markup_expr</span> <span class="main">[</span><span class="entity">term</span><span class="main">]</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="main">(</span>Syntax.parse_term <span class="entity">ctxt</span> <span class="entity">opt</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">True</span><span class="antiquote">}</span></span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extra</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">intval</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="main">(</span><span class="entity">intval_preservation</span><span class="main">,</span> <span class="main">[</span><span class="entity">intval_preservation</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">preservation</span> <span class="main">=</span> <span class="entity">preservation_of</span> <span class="entity">ctxt</span> <span class="entity">rewrite</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">preservation</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">intval</span> 
      <span class="keyword2"><span class="keyword">then</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Pure.imp"</span><span class="antiquote">}</span></span> $ <span class="entity">intval_preservation</span> $ <span class="entity">preservation</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">preservation</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">termination</span> <span class="main">=</span> <span class="entity">termination_of</span> <span class="entity">ctxt</span> <span class="entity">rewrite</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code</span> <span class="main">=</span> <span class="entity">code_of</span> <span class="entity">ctxt</span> <span class="entity">rewrite</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">register</span> <span class="main">=</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">proofs</span> <span class="main">=&gt;</span> <span class="entity">RewritePhase.register</span> <span class="main">(</span><span class="entity">bind</span><span class="main">,</span> <span class="main">(</span><span class="entity">add_proofs</span> <span class="entity">rewrite</span> <span class="entity">proofs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">after_qed</span> <span class="entity">thms</span> <span class="entity">lthy</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy'</span> <span class="main">=</span> Local_Theory.background_theory <span class="main">(</span><span class="entity">register</span> <span class="main">(</span>hd <span class="entity">thms</span><span class="main">)</span><span class="main">)</span> <span class="entity">lthy</span><span class="main">;</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">lthy''</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Specification.definition</span>
            NONE <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span>
            <span class="main">(</span><span class="main">(</span>Binding.suffix_name <span class="inner_quoted">"_code"</span> <span class="entity">bind</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">code</span><span class="main">)</span>
            <span class="entity">lthy'</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        snd <span class="main">(</span>Local_Theory.note <span class="main">(</span><span class="main">(</span><span class="entity">bind</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> hd <span class="entity">thms</span><span class="main">)</span> <span class="entity">lthy''</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">target</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Proof.theorem</span> NONE <span class="entity">after_qed</span> 
        <span class="main">[</span><span class="entity">extra</span> @ <span class="main">[</span><span class="main">(</span><span class="entity">preservation</span><span class="main">,</span> <span class="main">[</span><span class="entity">preservation</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">termination</span><span class="main">,</span> <span class="main">[</span><span class="entity">termination</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">]</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">apply</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Proof.apply</span> 
      <span class="main">(</span><span class="main">(</span><span class="entity">Method.Source</span> <span class="main">(</span>Token.make_src <span class="main">(</span><span class="inner_quoted">"unfold_optimization"</span><span class="main">,</span> Position.start<span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        Position.no_range<span class="main">)</span> <span class="entity">target</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Seq.hd <span class="entity">apply</span> <span class="keyword2"><span class="keyword">of</span></span>
       Seq.Result <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">r</span>
       <span class="main">|</span> Seq.Error <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">target</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">apply</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Proof.apply</span>
      <span class="main">(</span><span class="main">(</span><span class="entity">Method.Source</span> <span class="main">(</span>Token.make_src <span class="main">(</span><span class="inner_quoted">"unfold_size"</span><span class="main">,</span> Position.start<span class="main">)</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       Position.no_range<span class="main">)</span> <span class="main">(</span><span class="entity">Proof.defer</span> <span class="inner_numeral">1</span> <span class="entity">result</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Seq.hd <span class="entity">apply</span> <span class="keyword2"><span class="keyword">of</span></span>
       Seq.Result <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">r</span>
       <span class="main">|</span> Seq.Error <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">result</span><span class="main">)</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">result</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>