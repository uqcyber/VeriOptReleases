<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹map.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹map.ML›</h1>
</div>

<pre class="source"><span class="comment1">(*  Title:      Optimizations/DSL/map.ML
    Author:     Brae Webb

Simple inefficient map data stucture.
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">MAP</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
<span class="keyword1"><span class="keyword">type</span></span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span> <span class="main">=</span> <span class="main">(</span>''k list * <span class="main">(</span>''k <span class="main">-&gt;</span> 'v option<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> insert<span class="main">:</span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span> <span class="main">-&gt;</span> <span class="main">(</span>''k * 'v<span class="main">)</span> <span class="main">-&gt;</span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span>
<span class="keyword1"><span class="keyword">val</span></span> lookup<span class="main">:</span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span> <span class="main">-&gt;</span> ''k <span class="main">-&gt;</span> 'v option
<span class="keyword1"><span class="keyword">val</span></span> values<span class="main">:</span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span> <span class="main">-&gt;</span> 'v list
<span class="keyword1"><span class="keyword">val</span></span> empty<span class="main">:</span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span>
<span class="keyword1"><span class="keyword">val</span></span> merge<span class="main">:</span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span> <span class="main">-&gt;</span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span> <span class="main">-&gt;</span> <span class="main">(</span>''k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Map</span> <span class="main">:</span> <span class="entity">MAP</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
<span class="keyword1"><span class="keyword">type</span></span> <span class="main">(</span>'k<span class="main">,</span> 'v<span class="main">)</span> <span class="entity">map</span> <span class="main">=</span> <span class="main">(</span>'k list * <span class="main">(</span>'k <span class="main">-&gt;</span> 'v option<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_if_not</span> <span class="entity">xs</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">xs</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">xs</span> <span class="keyword2"><span class="keyword">else</span></span> cons <span class="entity">x</span> <span class="entity">xs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert</span> <span class="entity">xs</span> <span class="main">(</span><span class="entity">key</span><span class="main">,</span> <span class="entity">value</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">add_if_not</span> <span class="main">(</span>fst <span class="entity">xs</span><span class="main">)</span> <span class="entity">key</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">key</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="entity">value</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span>snd <span class="entity">xs</span><span class="main">)</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lookup</span> <span class="entity">xs</span> <span class="entity">key</span> <span class="main">=</span>
  <span class="main">(</span>snd <span class="entity">xs</span><span class="main">)</span> <span class="entity">key</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">only_some</span> <span class="entity">vs</span> <span class="main">=</span>
  List.foldr <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">v</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">v</span> <span class="keyword2"><span class="keyword">of</span></span> NONE <span class="main">=&gt;</span> <span class="entity">xs</span> <span class="main">|</span> SOME <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span><span class="entity">x</span><span class="main">]</span> @ <span class="entity">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="entity">vs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">values</span> <span class="main">(</span><span class="entity">keys</span><span class="main">,</span> <span class="entity">lookup</span><span class="main">)</span> <span class="main">=</span>
  <span class="entity">only_some</span> <span class="main">(</span>map <span class="entity">lookup</span> <span class="entity">keys</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> <span class="main">(</span><span class="entity">lhs_keys</span><span class="main">,</span> <span class="entity">lhs</span><span class="main">)</span> <span class="main">(</span><span class="entity">rhs_keys</span><span class="main">,</span> <span class="entity">rhs</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span><span class="entity">rhs_keys</span> @ <span class="entity">lhs_keys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">lhs_keys</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">lhs</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">rhs</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>