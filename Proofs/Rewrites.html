<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Rewrites</title>
</head>


<body>
<div class="head">
<h1>Theory Rewrites</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Graph Rewriting›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  Rewrites
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="IRGraphFrames.html">IRGraphFrames</a>
  <a href="Stuttering.html">Stuttering</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">replace_usages</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> ID <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_usages</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> replace_usages_effect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> replace_usages <span class="free">nid</span> <span class="free">nid'</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g'</span> <span class="free">nid</span> <span class="main">=</span> RefNode <span class="free">nid'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms replace_node_lookup replace_usages.simps IRNode.distinct<span class="main">(</span>2069<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_usages_changeonly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> replace_usages <span class="free">nid</span> <span class="free">nid'</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"changeonly <span class="main">{</span><span class="free">nid</span><span class="main">}</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> replace_usages.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI changeonly.elims<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ids_some replace_node_unchanged<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_usages_unchanged<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> replace_usages <span class="free">nid</span> <span class="free">nid'</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>ids <span class="free">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">nid</span><span class="main">}</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> replace_usages.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> DiffE ids_some replace_node_unchanged unchanged.simps<span class="main">)</span>



<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nextNid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nextNid</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span>Max <span class="main">(</span>ids <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_plus_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ID set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Max <span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∉</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Max_gr_iff less_add_one less_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ids_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ids <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nextNidNotIn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ids <span class="free">g</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> nextNid <span class="free">g</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nextNid.simps
  <span class="keyword1"><span class="command">using</span></span> ids_finite max_plus_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">constantCondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> ID <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">constantCondition</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> 
    replace_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>IfNode <span class="main">(</span>nextNid <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> 
      <span class="main">(</span>add_node <span class="main">(</span>nextNid <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="main">(</span>bool_to_val <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> default_stamp<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">constantCondition</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> constantConditionTrue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">ifcond</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> constantCondition True <span class="free">ifcond</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">ifcond</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> if'<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g'</span> <span class="free">ifcond</span> <span class="main">=</span> IfNode <span class="main">(</span>nextNid <span class="free">g</span><span class="main">)</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IRNode.simps<span class="main"><span class="main">(</span></span>989<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> constantCondition.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> replace_node_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bool_to_val True <span class="main">=</span> <span class="main">(</span>IntVal <span class="main">1</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifcond</span> <span class="main">≠</span> <span class="main">(</span>nextNid <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IRNode.simps<span class="main"><span class="main">(</span></span>989<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> emptyE ids_some nextNidNotIn<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g'</span> <span class="main">(</span>nextNid <span class="free">g</span><span class="main">)</span> <span class="main">=</span> ConstantNode <span class="main">(</span>IntVal <span class="main">1</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> replace_node_unchanged
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI IRNode.distinct<span class="main"><span class="main">(</span></span>585<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹bool_to_val True <span class="main">=</span> IntVal <span class="main">1</span> <span class="main">1</span>›</span></span> add_node_lookup assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> constantCondition.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> emptyE insertE not_in_g<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> if' c' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IfNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> ConstantNode val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> constantConditionFalse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">ifcond</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> constantCondition False <span class="free">ifcond</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">ifcond</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> if'<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g'</span> <span class="free">ifcond</span> <span class="main">=</span> IfNode <span class="main">(</span>nextNid <span class="free">g</span><span class="main">)</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IRNode.simps<span class="main"><span class="main">(</span></span>989<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> constantCondition.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> replace_node_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bool_to_val False <span class="main">=</span> <span class="main">(</span>IntVal <span class="main">1</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ifcond</span> <span class="main">≠</span> <span class="main">(</span>nextNid <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IRNode.simps<span class="main"><span class="main">(</span></span>989<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> emptyE ids_some nextNidNotIn<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g'</span> <span class="main">(</span>nextNid <span class="free">g</span><span class="main">)</span> <span class="main">=</span> ConstantNode <span class="main">(</span>IntVal <span class="main">1</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> replace_node_unchanged
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffI IRNode.distinct<span class="main"><span class="main">(</span></span>585<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹bool_to_val False <span class="main">=</span> IntVal <span class="main">1</span> <span class="main">0</span>›</span></span> add_node_lookup assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> constantCondition.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> emptyE insertE not_in_g<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> if' c' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IfNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> ConstantNode val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diff_forall<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">∈</span>ids <span class="free">g</span> <span class="main">-</span> <span class="main">{</span><span class="free">nid</span><span class="main">}</span><span class="main">.</span> <span class="free">cond</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> ids <span class="free">g</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">∉</span> <span class="main">{</span><span class="free">nid</span><span class="main">}</span> <span class="main">⟶</span> <span class="free">cond</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Diff_iff assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_node_changeonly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> replace_node <span class="free">nid</span> <span class="free">node</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"changeonly <span class="main">{</span><span class="free">nid</span><span class="main">}</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms replace_node_unchanged
  <span class="keyword1"><span class="command">unfolding</span></span> changeonly.simps <span class="keyword1"><span class="command">using</span></span> diff_forall
  <span class="keyword1"><span class="command">sorry</span></span> <span class="comment1">(* Isabelle isn't doing good *)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_node_changeonly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> add_node <span class="free">nid</span> <span class="free">node</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"changeonly <span class="main">{</span><span class="free">nid</span><span class="main">}</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rep_IRGraph_inverse add_node.rep_eq assms replace_node.rep_eq replace_node_changeonly<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> constantConditionNoEffect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>is_IfNode <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> constantCondition <span class="free">b</span> <span class="free">nid</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> constantCondition.simps 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> is_IfNode_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> constantCondition.simps 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> constantConditionIfNode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constantCondition <span class="free">val</span> <span class="free">nid</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> 
    replace_node <span class="free">nid</span> <span class="main">(</span>IfNode <span class="main">(</span>nextNid <span class="free">g</span><span class="main">)</span> <span class="free">t</span> <span class="free">f</span><span class="main">,</span> stamp <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> 
     <span class="main">(</span>add_node <span class="main">(</span>nextNid <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="main">(</span>bool_to_val <span class="free">val</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> default_stamp<span class="main">)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> constantCondition.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> constantCondition_changeonly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> constantCondition <span class="free">b</span> <span class="free">nid</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"changeonly <span class="main">{</span><span class="free">nid</span><span class="main">}</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_IfNode <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nextNid <span class="free">g</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nextNidNotIn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emptyE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">using</span></span> replace_node_changeonly add_node_changeonly <span class="keyword1"><span class="command">unfolding</span></span> changeonly.simps
    <span class="keyword1"><span class="command">using</span></span> True constantCondition.simps<span class="main">(</span>1<span class="main">)</span> is_IfNode_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> DiffD2 Diff_insert_absorb<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constantConditionNoEffect
    <span class="keyword1"><span class="command">using</span></span> False assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">lemma</span></span> constantConditionNoIf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">cond</span> <span class="bound">t</span> <span class="bound">f</span><span class="main">.</span> kind <span class="free">g</span> <span class="free">ifcond</span> <span class="main">≠</span> IfNode <span class="bound">cond</span> <span class="bound">t</span> <span class="bound">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> constantCondition <span class="free">val</span> <span class="free">ifcond</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">ifcond</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nid'</span> <span class="main">.</span><span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">ifcond</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">ifcond</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> constantConditionNoEffect
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IRNode.collapse<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> constantConditionValid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">ifcond</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">cond</span> <span class="main">↦</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">const</span> <span class="main">=</span> val_to_bool <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> constantCondition <span class="free">const</span> <span class="free">ifcond</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">ifcond</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nid'</span> <span class="main">.</span><span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">ifcond</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">ifcond</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">const</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> ifstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IfNode True assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ifstep'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constantConditionTrue
    <span class="keyword1"><span class="command">using</span></span> True assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">from</span></span> ifstep ifstep' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> StutterStep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> ifstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IfNode False assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ifstep'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constantConditionFalse
    <span class="keyword1"><span class="command">using</span></span> False assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">from</span></span> ifstep ifstep' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> StutterStep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>