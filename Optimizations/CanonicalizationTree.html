<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory CanonicalizationTree</title>
</head>


<body>
<div class="head">
<h1>Theory CanonicalizationTree</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Canonicalization Phase›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CanonicalizationTree
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Semantics/IRTreeEval.html">Semantics.IRTreeEval</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: these functions below could be made more precise (but complicated)
  by operating on stamps rather than just values, as seen in the op table:
  https://github.com/oracle/graal/blob/fbab70f9d788f997c862bdee186ef1d8e6c435f1/compiler/src/org.graalvm.compiler.core.common/src/org/graalvm/compiler/core/common/type/IntegerStamp.java#L602
*)</span>

<span class="comment1">(* is_neutral (⊕, n) ⟹ ∀ x. x ⊕ n = x *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_neutral</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRBinaryOp <span class="main">⇒</span> Value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="comment1">(* x * 1 = x*)</span>
<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> BinMul <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> BinMul <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="comment1">(* x + 0 = x*)</span>
<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> BinAdd <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> BinAdd <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="comment1">(* x ^ 0 = x *)</span>
<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> BinXor <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> BinXor <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="comment1">(* x - 0 = x *)</span>
<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> BinSub <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> BinSub <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>

<span class="quoted"><span class="quoted">"<span class="free">is_neutral</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="comment1">(* is_zerp (⊕, z) ⟹ ∀ x. x ⊕ z = 0 *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRBinaryOp <span class="main">⇒</span> Value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_zero</span> BinMul <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_zero</span> BinMul <span class="main">(</span>IntVal64 <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_zero</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">int_to_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Value <span class="main">⇒</span> int <span class="main">⇒</span> Value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">int_to_value</span> <span class="main">(</span>IntVal32 <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">int_to_value</span> <span class="main">(</span>IntVal64 <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal64 <span class="main">(</span>word_of_int <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">int_to_value</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> UndefVal"</span></span>

<span class="comment1">(* TODO: we should only handle y values being constant and let a higher
    level function swap values (if commutative) and try to recanonicalize if
    x is constant and y is not... (since this is done by almost all binary nodes) *)</span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeBinaryOp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  binary_const_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">val1</span></span></span><span class="main">)</span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">val2</span></span></span><span class="main">)</span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> bin_eval <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">val1</span></span></span> <span class="free"><span class="bound"><span class="entity">val2</span></span></span><span class="main">;</span>
   <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">≠</span> UndefVal<span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeBinaryOp</span> <span class="main">(</span>BinaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  binary_fold_yneutral<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">;</span>
   is_neutral <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">CanonicalizeBinaryOp</span> <span class="main">(</span>BinaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>

  binary_fold_yzero32<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span>
    is_zero <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> <span class="numeral">32</span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeBinaryOp</span> <span class="main">(</span>BinaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  binary_fold_yzero64<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span>
    is_zero <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> <span class="numeral">64</span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeBinaryOp</span> <span class="main">(</span>BinaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal64 <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeUnaryOp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  unary_const_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">val'</span></span></span> <span class="main">=</span> unary_eval <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">val'</span></span></span> <span class="main">≠</span> UndefVal<span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeUnaryOp</span> <span class="main">(</span>UnaryExpr <span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ConstantExpr <span class="free"><span class="bound"><span class="entity">val'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeMul</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(* y * (-1) = -y *)</span>
  mul_negate32<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantExpr <span class="main">(</span>IntVal32 <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> IntegerStamp <span class="numeral">32</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="main">(</span>BinaryExpr BinMul <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  mul_negate64<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantExpr <span class="main">(</span>IntVal64 <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> IntegerStamp <span class="numeral">64</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="main">(</span>BinaryExpr BinMul <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  <span class="comment1">(* NOTE: Skipping bit shift optimisations at MulNode.canonical(130) for now *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeAdd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   add_xsub<span class="main">:</span>  <span class="comment1">(* AddNode.canonical (85) *)</span>
  <span class="comment1">(* (a - y) + y ⇒ a *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>

   add_ysub<span class="main">:</span>  <span class="comment1">(* AddNode.canonical (92) *)</span>
  <span class="comment1">(*  x + (a - x) ⇒ a *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* NOTE: skipping AddNode.canonical (113) for now: No ZeroExtendNode currently in IR *)</span>

  add_xnegate<span class="main">:</span>  <span class="comment1">(* AddNode.canonical (160) *)</span>
  <span class="comment1">(* (-x + y) ⇒ (y - x) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>  <span class="main">|</span>

  add_ynegate<span class="main">:</span>  <span class="comment1">(* AddNode.canonical (165) *)</span>
  <span class="comment1">(* (x + (-y)) ⇒ (x - y) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">ny</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeSub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*
  sub_same: (* SubNode.canonical(76) *)
  (* (x - x) = 0 *)
  "⟦stampx = stamp_expr x;
    is_IntegerStamp stampx;
    b = stp_bits stampx;
    zero = (if b = 32 then (IntVal32 0) else (IntVal64 0))⟧
    ⟹ CanonicalizeSub (BinaryExpr BinSub x x) (ConstantExpr zero)" |
  *)</span>
  sub_same32<span class="main">:</span> <span class="comment1">(* SubNode.canonical(76) *)</span>
  <span class="comment1">(* (x - x) = 0 *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> IntegerStamp <span class="numeral">32</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  sub_same64<span class="main">:</span> <span class="comment1">(* SubNode.canonical(76) *)</span>
  <span class="comment1">(* (x - x) = 0 *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> IntegerStamp <span class="numeral">64</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal64 <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_left_add1<span class="main">:</span> <span class="comment1">(* SubNode.canonical(86) *)</span>
  <span class="comment1">(* (a + b) - b ⇒ a *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampb</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>

  sub_left_add2<span class="main">:</span> <span class="comment1">(* SubNode.canonical(90) *)</span>
  <span class="comment1">(* (a + b) - a ⇒ b *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampb</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>

  sub_left_sub<span class="main">:</span> <span class="comment1">(* SubNode.canonical(94) *)</span>
  <span class="comment1">(* (a - b) - a ⇒ (-b) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampb</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_right_add1<span class="main">:</span> <span class="comment1">(* SubNode.canonical(103) *)</span>
  <span class="comment1">(* a - (a + b) ⇒ (-b) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampb</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_right_add2<span class="main">:</span> <span class="comment1">(* SubNode.canonical(107) *)</span>
  <span class="comment1">(* b - (a + b) ⇒ (-a) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampb</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_right_sub<span class="main">:</span> <span class="comment1">(* SubNode.canonical(111) *)</span>
  <span class="comment1">(* a - (a - b) ⇒ b *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampb</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* SubNode.canonical(146) *)</span>
  <span class="comment1">(* 0 - x ⇒ (-x) *)</span>
  sub_xzero32<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> IntegerStamp <span class="numeral">32</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  sub_xzero64<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> IntegerStamp <span class="numeral">64</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal64 <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_y_negate<span class="main">:</span> <span class="comment1">(* SubNode.canonical(152) *)</span>
  <span class="comment1">(* a - (-b) ⇒ a + b *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nb</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampb</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampa</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampb</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">nb</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

  <span class="comment1">(* x - 0 ⇒ x in SubNode.canonical(121), handled by is_neutral case in CanonicalizeBinaryOp *)</span>

  <span class="comment1">(* TODO: reassociation in SubNode.canonical(119-151) *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeNegate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  negate_negate<span class="main">:</span> <span class="comment1">(* NegateNode.canonical(88) *)</span>
  <span class="comment1">(* -(-x) ⇒ x *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    is_IntegerStamp <span class="main">(</span>stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeNegate</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>

  negate_sub<span class="main">:</span> <span class="comment1">(* NegateNode.canonical(91) *)</span>
  <span class="comment1">(* -(x - y) ⇒ (y - x) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeNegate</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  abs_abs<span class="main">:</span>  <span class="comment1">(* AbsNode.canonical(68) *)</span>
  <span class="comment1">(* abs(abs(x)) = abs(x) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">ax</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryAbs <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    is_IntegerStamp <span class="main">(</span>stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAbs</span> <span class="main">(</span>UnaryExpr UnaryAbs <span class="free"><span class="bound"><span class="entity">ax</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ax</span></span></span>"</span></span> <span class="main">|</span>

  abs_neg<span class="main">:</span>  <span class="comment1">(* AbsNode.canonical(68) *)</span>
  <span class="comment1">(* abs(-x) = abs(x) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNeg <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    is_IntegerStamp <span class="main">(</span>stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAbs</span> <span class="main">(</span>UnaryExpr UnaryAbs <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryAbs <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeNot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  not_not<span class="main">:</span> <span class="comment1">(* NotNode.canonical(75) *)</span>
  <span class="comment1">(* ~(~x) ⇒ x *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    is_IntegerStamp <span class="main">(</span>stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeNot</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeAnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  and_same<span class="main">:</span> <span class="comment1">(* AndNode.canonical(82) *)</span>
  <span class="comment1">(* (x &amp; x) ⇒ x *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_IntegerStamp <span class="main">(</span>stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAnd</span> <span class="main">(</span>BinaryExpr BinAnd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>

  and_demorgans<span class="main">:</span> <span class="comment1">(* AndNode.canonical(119) *)</span>
  <span class="comment1">(* (~x) &amp; (~y) ⇒ ~(x | y) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">ny</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAnd</span> <span class="main">(</span>BinaryExpr BinAnd <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="main">(</span>BinaryExpr BinOr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">(* NOTE: Skipping AndNode.canonical(103).... Should be put in CanonicalizeBinaryOp via is_neutral  *)</span>
  <span class="comment1">(* NOTE: Skipping AndNode.canonical(91), no upMask/downMask for stamps yet? *)</span>
  <span class="comment1">(* NOTE: Skipping AndNode.canonical(107), no ZeroExtend/SignExtend yet *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeOr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  or_same<span class="main">:</span> <span class="comment1">(* OrNode.canonical(93) *)</span>
  <span class="comment1">(* (x | x) ⇒ x *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_IntegerStamp <span class="main">(</span>stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeOr</span> <span class="main">(</span>BinaryExpr BinOr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>

  or_demorgans<span class="main">:</span> <span class="comment1">(* OrNode.canonical(120) *)</span>
  <span class="comment1">(* (~x) | (~y) ⇒ ~(x &amp; y) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">ny</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeOr</span> <span class="main">(</span>BinaryExpr BinOr <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span><span class="main">)</span> <span class="main">(</span>UnaryExpr UnaryNot <span class="main">(</span>BinaryExpr BinAnd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">(* NOTE: Skipping OrNode.canonical(103). Should be put in CanonicalizeBinaryOp via is_neutral *)</span>
  <span class="comment1">(* NOTE: Skipping OrNode.canonical(91), no upMask/downMask for stamps yet? *)</span>
  <span class="comment1">(* NOTE: Skipping OrNode.canonical(107), no ZeroExtend/SignExtend yet *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeIntegerEquals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  int_equals_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(139) *)</span>
  <span class="comment1">(* (x == x) ⇒ T *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_distinct<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(143) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>alwaysDistinct <span class="main">(</span>stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_add_first_both_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(152) *)</span>
  <span class="comment1">(* (x+y) == (x+z) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_add_first_second_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(156) *)</span>
  <span class="comment1">(* (x+y) == (z+x) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_add_second_first_same<span class="main">:</span>  <span class="comment1">(* IntegerEqualsNode.canonical(160) *)</span>
  <span class="comment1">(* (y+x) == (x+z) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_add_second_both__same<span class="main">:</span>  <span class="comment1">(* IntegerEqualsNode.canonical(164) *)</span>
  <span class="comment1">(* (y+x) == (z+x) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_sub_first_both_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(180) *)</span>
  <span class="comment1">(* (x-y) == (x-z) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_sub_second_both_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(184) *)</span>
  <span class="comment1">(* (y-x) == (z-x) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

<span class="comment1">(* TODO: choosing the bitsize of the zeros below *)</span>

  int_equals_left_contains_right1<span class="main">:</span> <span class="comment1">(* IntegerEquals.canonical(197) *)</span>
  <span class="comment1">(* (x+y) == x ⇒ (y == 0) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">zero</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">zero</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_left_contains_right2<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(200) *)</span>
  <span class="comment1">(* (x+y) == y ⇒ (x == 0) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">zero</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">zero</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_right_contains_left1<span class="main">:</span> <span class="comment1">(* IntegerEquals.canonical(208) *)</span>
  <span class="comment1">(* x == (x+y) ⇒ (y == 0) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">zero</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">zero</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_right_contains_left2<span class="main">:</span> <span class="comment1">(* IntegerEquals.canonical(211) *)</span>
  <span class="comment1">(* y == (x+y) ⇒ (x == 0) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinAdd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">zero</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">zero</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_left_contains_right3<span class="main">:</span> <span class="comment1">(* IntegerEquals.canonical(219) *)</span>
  <span class="comment1">(* (x - y) == x ⇒ (y == 0) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">zero</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">zero</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_right_contains_left3<span class="main">:</span> <span class="comment1">(* IntegerEquals.canonical(227) *)</span>
  <span class="comment1">(* x == (x - y) ⇒ (y == 0) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinSub <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">zero</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantExpr <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">zero</span></span></span><span class="main">)</span>"</span></span>

  <span class="comment1">(* NOTE: missing IntegerEqualsNode.canonicalizeSymmetricConstant rules *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeConditional</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  eq_branches<span class="main">:</span>  <span class="comment1">(* ConditionalNode.canonicalizeConditional (152) *)</span>
  <span class="comment1">(* c ? x : x ⇒ x *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>

  cond_eq<span class="main">:</span> <span class="comment1">(* ConditionalNode.canonicalizeConditional (155) *)</span>
  <span class="comment1">(* (x==y) ? x : y ⟹ y *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinIntegerEquals <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>

  condition_bounds_x<span class="main">:</span> <span class="comment1">(* ConditionalNode.canonicalizeConditional (170) *)</span>
  <span class="comment1">(* (x &lt; y ? x : y) ⇒ x    in case we know that x &lt; y via stamps *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinIntegerLessThan <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    stpi_upper <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">≤</span> stpi_lower <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>

  condition_bounds_y<span class="main">:</span> <span class="comment1">(* ConditionalNode.canonicalizeConditional (175) *)</span>
  <span class="comment1">(* (x &lt; y ? y : x) ⇒ y    in case we know that x &lt; y via stamps *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>BinaryExpr BinIntegerLessThan <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    stpi_upper <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">≤</span> stpi_lower <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>

  negate_condition<span class="main">:</span> <span class="comment1">(* ConditionalNode.findSynonym (284) *)</span>
  <span class="comment1">(* (¬c ? x : y) ⇒ (c ? y : x) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">=</span> <span class="main">(</span>UnaryExpr UnaryLogicNegation <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampc</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampc</span></span></span> <span class="main">=</span> IntegerStamp <span class="numeral">32</span> <span class="free"><span class="bound"><span class="entity">lo</span></span></span> <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">stampy</span></span></span> <span class="main">=</span> stamp_expr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    stp_bits <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">=</span> stp_bits <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">;</span>
    is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampx</span></span></span> <span class="main">∧</span> is_IntegerStamp <span class="free"><span class="bound"><span class="entity">stampy</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  const_true<span class="main">:</span>  <span class="comment1">(* ConditionalNode.findSynonym (286) *)</span>
  <span class="comment1">(* TRUE ? t : f ⇒ t *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> ConstantExpr <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>

  const_false<span class="main">:</span>  <span class="comment1">(* ConditionalNode.findSynonym (288) *)</span>
  <span class="comment1">(* FALSE ? t : f ⇒ f*)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> ConstantExpr <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="main">(</span>ConditionalExpr <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

  <span class="comment1">(* ConditionalNode.canonicalizeConditional (188) skipping for now:
      Currently don't have ZeroExtendNode, IntegerConvertNode *)</span>

  <span class="comment1">(* ConditionalNode.canonicalizeConditional (213) skipping for now:
      Currently don't have an IntegerTestNode  *)</span>

  <span class="comment1">(* ConditionalNode.canonicalizeConditional (227) skipping for now:
      Currently don't have a RightShiftNode to transform into  *)</span>

  <span class="comment1">(* ConditionalNode.canonicalizeConditional (253) skipping for now:
      Currently don't have a RoundNode or FloatLessThanNode  *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizationStep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRExpr <span class="main">⇒</span> IRExpr <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  BinaryNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeBinaryOp <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  UnaryNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeUnaryOp <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  NegateNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeNegate <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  NotNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeNegate <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  AddNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeAdd <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  MulNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeMul <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  SubNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeSub <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  AndNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeSub <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  OrNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeSub <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  IntegerEqualsNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeIntegerEquals <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span> <span class="main">|</span>

  ConditionalNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeConditional <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free"><span class="bound"><span class="entity">expr</span></span></span> <span class="free"><span class="bound"><span class="entity">expr'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeBinaryOp</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeUnaryOp</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeNegate</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeNot</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeAdd</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeSub</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeMul</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeAnd</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeIntegerEquals</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeConditional</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizationStep</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>