<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Canonicalization</title>
</head>


<body>
<div class="head">
<h1>Theory Canonicalization</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Canonicalization Phase›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Canonicalization
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="../Proofs/IRGraphFrames.html">Proofs.IRGraphFrames</a>
    <a href="../Proofs/Stuttering.html">Proofs.Stuttering</a>
    <a href="../Proofs/Bisimulation.html">Proofs.Bisimulation</a>
    <a href="../Proofs/Form.html">Proofs.Form</a>

    <a href="../Graph/Traversal.html">Graph.Traversal</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeConditional</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  negate_condition<span class="main">:</span> <span class="comment1">(* ConditionalNode.findSynonym (252) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> LogicNegationNode <span class="free"><span class="bound"><span class="entity">flip</span></span></span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">flip</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  
  const_true<span class="main">:</span> <span class="comment1">(* ConditionalNode.findSynonym (258) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  const_false<span class="main">:</span> <span class="comment1">(* ConditionalNode.findSynonym (256) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  eq_branches<span class="main">:</span> <span class="comment1">(* ConditionalNode.canonicalizeConditional (151) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  cond_eq<span class="main">:</span> <span class="comment1">(* ConditionalNode.canonicalizeConditional (155) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  condition_bounds_x<span class="main">:</span> <span class="comment1">(* ConditionalNode.canonicalizeConditional (169) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">;</span>
    stpi_upper <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span> <span class="main">≤</span> stpi_lower <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  condition_bounds_y<span class="main">:</span> <span class="comment1">(* ConditionalNode.canonicalizeConditional (174) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">fb</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">;</span>
    stpi_upper <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">≤</span> stpi_lower <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span><span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">CanonicalizeConditional</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ConditionalNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span>"</span></span>

  <span class="comment1">(* ConditionalNode.canonicalizeConditional (188) skipping for now:
      Currently don't have ZeroExtendNode, IntegerConvertNode *)</span>

  <span class="comment1">(* ConditionalNode.canonicalizeConditional (213) skipping for now:
      Currently don't have an IntegerTestNode  *)</span>
  
  <span class="comment1">(* ConditionalNode.canonicalizeConditional (227) skipping for now:
      Currently don't have a RightShiftNode to transform into  *)</span>

  <span class="comment1">(* ConditionalNode.canonicalizeConditional (253) skipping for now:
      Currently don't have a RoundNode or FloatLessThanNode  *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeAdd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  add_both_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_2</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> intval_add <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="free"><span class="bound"><span class="entity">c_2</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  add_xzero<span class="main">:</span> <span class="comment1">(* AddNode.canonical (100) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  add_yzero<span class="main">:</span> <span class="comment1">(* AddNode.canonical (100) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_2</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c_2</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  add_xsub<span class="main">:</span>  <span class="comment1">(* AddNode.canonical (85) *)</span>
  <span class="comment1">(* (a - y) + y ⇒ a *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  add_ysub<span class="main">:</span>  <span class="comment1">(* AddNode.canonical (92) *)</span>
  <span class="comment1">(* x + (a - x) ⇒ a *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* AddNode.canonical (113) skipping for now:
    No ZeroExtendNode *)</span> 

  add_xnegate<span class="main">:</span>  <span class="comment1">(* AddNode.canonical (160) *)</span>
  <span class="comment1">(* (-x + y) ⇒ (y - x) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> NegateNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  add_ynegate<span class="main">:</span>  <span class="comment1">(* AddNode.canonical (165) *)</span>
  <span class="comment1">(* (x + (-y)) ⇒ (x - y) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span> <span class="main">=</span> NegateNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeAdd</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span><span class="main">)</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

  <span class="comment1">(* TODO: reassociation of constants *)</span> 

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeIf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  trueConst<span class="main">:</span> <span class="comment1">(* IfNode.simplify (287) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">condv</span></span></span><span class="main">;</span>
    val_to_bool <span class="free"><span class="bound"><span class="entity">condv</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizeIf</span> <span class="free">g</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  falseConst<span class="main">:</span> <span class="comment1">(* IfNode.simplify (287) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">condv</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free"><span class="bound"><span class="entity">condv</span></span></span><span class="main">)</span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizeIf</span> <span class="free">g</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  
  eqBranch<span class="main">:</span> <span class="comment1">(* In ConditionalNode.canonicalizeConditional(152) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizeIf</span> <span class="free">g</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* Brae: made up - find where this occurs *)</span>
  <span class="comment1">(* KT: I imagine the IntegerEqualsNode x x will get canonicalized to a true ConstantNode first *)</span>
  eqCondition<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizeIf</span> <span class="free">g</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeBinaryArithmeticNode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 add_const_fold<span class="main">:</span> <span class="comment1">(* BinaryArithmeticNode.canonical (94) *)</span>
   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">op</span></span></span> <span class="main">=</span> kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">op_id</span></span></span><span class="main">;</span>
    is_AddNode <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ir_x <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">=</span> ConditionalNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_2</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ir_y <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_3</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">tv</span></span></span> <span class="main">=</span> intval_add <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="free"><span class="bound"><span class="entity">c_3</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">fv</span></span></span> <span class="main">=</span> intval_add <span class="free"><span class="bound"><span class="entity">c_2</span></span></span> <span class="free"><span class="bound"><span class="entity">c_3</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span><span class="main">,</span> constantAsStamp <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">fb</span></span></span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">fv</span></span></span><span class="main">)</span><span class="main">,</span> constantAsStamp <span class="free"><span class="bound"><span class="entity">fv</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">op_id</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>ir_x <span class="free"><span class="bound"><span class="entity">op</span></span></span><span class="main">)</span><span class="main">,</span> meet <span class="main">(</span>constantAsStamp <span class="free"><span class="bound"><span class="entity">tv</span></span></span><span class="main">)</span> <span class="main">(</span>constantAsStamp <span class="free"><span class="bound"><span class="entity">fv</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeBinaryArithmeticNode</span> <span class="free"><span class="bound"><span class="entity">op_id</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g'''</span></span></span>"</span></span>

  <span class="comment1">(* TODO: other operators: should these be done as separate rules or should above one be made generic?
     Need to make tradeoff on simplicity to prove vs conciseness/readability? *)</span>

<span class="comment1">(* TODO: is there a nice way to genericise the below rules for any IRNode that is_BinaryCommutative *)</span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(* BinaryArithmeticNode.maybeCommuteInputs *)</span>
  add_ids_ordered<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  and_ids_ordered<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  int_equals_ids_ordered<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  mul_ids_ordered<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  or_ids_ordered<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  xor_ids_ordered<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>XorNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>XorNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* TODO: these swaps to make constants appear as second variable may interact 
    with other canonicalization rules (e.g. for add) that deal with first arguments being constant  *)</span>
  add_swap_const_first<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  and_swap_const_first<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  int_equals_swap_const_first<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  
  mul_swap_const_first<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  or_swap_const_first<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  xor_swap_const_first<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeCommutativeBinaryArithmeticNode</span> <span class="free">g</span> <span class="main">(</span>XorNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>XorNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeSub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  sub_same<span class="main">:</span> <span class="comment1">(* SubNode.canonical(76) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    stamp <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_both_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_2</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> intval_sub <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="free"><span class="bound"><span class="entity">c_2</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span>  <span class="main">|</span>

  sub_left_add1<span class="main">:</span> <span class="comment1">(* SubNode.canonical(86) *)</span>
  <span class="comment1">(* (a + b) - b ⇒ a *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_left_add2<span class="main">:</span> <span class="comment1">(* SubNode.canonical(90) *)</span>
  <span class="comment1">(* (a + b) - a ⇒ b *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_left_sub<span class="main">:</span> <span class="comment1">(* SubNode.canonical(94) *)</span>
  <span class="comment1">(* (a - b) - a ⇒ (-b) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_right_add1<span class="main">:</span> <span class="comment1">(* SubNode.canonical(103) *)</span>
  <span class="comment1">(* a - (a + b) ⇒ (-b) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_right_add2<span class="main">:</span> <span class="comment1">(* SubNode.canonical(107) *)</span>
  <span class="comment1">(* b - (a + b) ⇒ (-a) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  sub_right_sub<span class="main">:</span> <span class="comment1">(* SubNode.canonical(111) *)</span>
  <span class="comment1">(* a - (a - b) ⇒ b *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_yzero<span class="main">:</span> <span class="comment1">(* SubNode.canonical(121) *)</span>
  <span class="comment1">(* x - 0 ⇒ x *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_xzero<span class="main">:</span> <span class="comment1">(* SubNode.canonical(146) *)</span>
  <span class="comment1">(* 0 - x ⇒ (-x). Assuming here y is not a float. *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  sub_y_negate<span class="main">:</span> <span class="comment1">(* SubNode.canonical(152) *)</span>
  <span class="comment1">(* a - (-b) ⇒ a + b *)</span>           
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nb</span></span></span> <span class="main">=</span> NegateNode <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeSub</span> <span class="free">g</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">nb</span></span></span><span class="main">)</span> <span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span> 

  <span class="comment1">(* TODO: reassociation in SubNode.canonical(119-151) *)</span>
                                              
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeMul</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  mul_both_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_2</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> intval_mul <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="free"><span class="bound"><span class="entity">c_2</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  mul_xzero<span class="main">:</span> <span class="comment1">(* MulNode.canonical(124) *)</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  mul_yzero<span class="main">:</span> <span class="comment1">(* MulNode.canonical(124) *)</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  mul_xone<span class="main">:</span> <span class="comment1">(* MulNode.canonical(126) *)</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">1</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  mul_yone<span class="main">:</span>  <span class="comment1">(* MulNode.canonical(126) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">1</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

   mul_xnegate<span class="main">:</span> <span class="comment1">(* MulNode.canonical(128) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  mul_ynegate<span class="main">:</span> <span class="comment1">(* MulNode.canonical(128) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">c_1</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c_1</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeMul</span> <span class="free">g</span> <span class="main">(</span>MulNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> 

  <span class="comment1">(* NOTE: Skipping bit shift optimisations at MulNode.canonical(130) for now *)</span>

  <span class="comment1">(* TODO: reassociation in SubNode.canonical(119-151) *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeAbs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  abs_abs<span class="main">:</span>  <span class="comment1">(* AbsNode.canonical(78) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>AbsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAbs</span> <span class="free">g</span> <span class="main">(</span>AbsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>AbsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* Why don't they canonicalize abs(-x) = abs(x) in Graal source code? 
     Let's try add it here and prove it anyway *)</span>
  abs_negate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAbs</span> <span class="free">g</span> <span class="main">(</span>AbsNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="main">(</span>AbsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> 
  
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeNegate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  negate_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">=</span> <span class="main">(</span>IntVal32 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">neg_val</span></span></span> <span class="main">=</span> intval_sub <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeNegate</span> <span class="free">g</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">neg_val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  negate_negate<span class="main">:</span> <span class="comment1">(* NegateNode.canonical(88) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeNegate</span> <span class="free">g</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  negate_sub<span class="main">:</span> <span class="comment1">(* NegateNode.canonical(91) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">=</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    stamp <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">=</span> <span class="main">(</span>IntegerStamp <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeNegate</span> <span class="free">g</span> <span class="main">(</span>NegateNode <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">)</span> <span class="main">(</span>SubNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

  <span class="comment1">(* NOTE: negate_rightshift in NegateNode.canonical(91) skipped, no RightShiftNode *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeNot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  not_const<span class="main">:</span> <span class="comment1">(* UnaryArithmeticNode.findSynonym(78) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">neg_val</span></span></span> <span class="main">=</span> intval_not <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeNot</span> <span class="free">g</span> <span class="main">(</span>NotNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">neg_val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  not_not<span class="main">:</span>  <span class="comment1">(* NotNode.canonical(75) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>NotNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeNot</span> <span class="free">g</span> <span class="main">(</span>NotNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeLogicNegation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  logical_not_const<span class="main">:</span> <span class="comment1">(* LogicNegationNode.findSynonym(61) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">neg_val</span></span></span> <span class="main">=</span> bool_to_val <span class="main">(</span><span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeLogicNegation</span> <span class="free">g</span> <span class="main">(</span>LogicNegationNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">neg_val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  logical_not_not<span class="main">:</span>  <span class="comment1">(* LogicNegationNode.findSynonym(65) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> <span class="main">(</span>LogicNegationNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeLogicNegation</span> <span class="free">g</span> <span class="main">(</span>LogicNegationNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeAnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  and_same<span class="main">:</span> <span class="comment1">(* AndNode.canonical(82) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAnd</span> <span class="free">g</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  and_xtrue<span class="main">:</span> <span class="comment1">(* AndNode.canonical(102) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAnd</span> <span class="free">g</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  and_ytrue<span class="main">:</span>  <span class="comment1">(* AndNode.canonical(102) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAnd</span> <span class="free">g</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  and_xfalse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAnd</span> <span class="free">g</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  and_yfalse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeAnd</span> <span class="free">g</span> <span class="main">(</span>AndNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span> 

  <span class="comment1">(* Skipping AndNode.canonical(91), no upMask/downMask for stamps yet? *)</span>
  <span class="comment1">(* Skipping AndNode.canonical(107), no ZeroExtend/SignExtend yet *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeOr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  or_same<span class="main">:</span>  <span class="comment1">(* OrNode.canonical(93) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeOr</span> <span class="free">g</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  or_xtrue<span class="main">:</span> <span class="comment1">(* OrNode.canonical(113) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeOr</span> <span class="free">g</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  or_ytrue<span class="main">:</span>  <span class="comment1">(* OrNode.canonical(113) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeOr</span> <span class="free">g</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  or_xfalse<span class="main">:</span> <span class="comment1">(* OrNode.canonical(113) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeOr</span> <span class="free">g</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  or_yfalse<span class="main">:</span> <span class="comment1">(* OrNode.canonical(113) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> ConstantNode <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeOr</span> <span class="free">g</span> <span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> 

  <span class="comment1">(* NOTE: Skipping OrNode.canonical(91), no upMask/downMask for stamps yet? *)</span>
  <span class="comment1">(* NOTE: Skipping OrNode.canonical(107), no ZeroExtend/SignExtend yet *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeDeMorgansLaw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(* OrNode.canonical(120) *)</span>
  <span class="comment1">(* (!x ∨ !y) ⇒ !(x ∧ y) *)</span>
  de_morgan_or_to_and<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> OrNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> NotNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span> <span class="main">=</span> NotNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">new_add_id</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nextNid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">new_add_id</span></span></span> <span class="main">(</span><span class="main">(</span>AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>IntegerStamp <span class="main">1</span> <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span><span class="main">(</span>NotNode <span class="free"><span class="bound"><span class="entity">new_add_id</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>IntegerStamp <span class="main">1</span> <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeDeMorgansLaw</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* AndNode.canonical(119) *)</span>
  <span class="comment1">(* (!x ∧ !y) ⇒ !(x ∨ y) *)</span>
  de_morgan_and_to_or<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> AndNode <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nx</span></span></span> <span class="main">=</span> NotNode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ny</span></span></span> <span class="main">=</span> NotNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">new_add_id</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nextNid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">new_add_id</span></span></span> <span class="main">(</span><span class="main">(</span>OrNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>IntegerStamp <span class="main">1</span> <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span><span class="main">(</span>NotNode <span class="free"><span class="bound"><span class="entity">new_add_id</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>IntegerStamp <span class="main">1</span> <span class="main">0</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeDeMorgansLaw</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeIntegerEquals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  int_equals_same_node<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(139) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_distinct<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(143) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>alwaysDistinct <span class="main">(</span>stamp <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>stamp <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_add_first_both_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(152) *)</span>
  <span class="comment1">(* (x+y) == (x+z) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_add_first_second_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(156) *)</span>
  <span class="comment1">(* (x+y) == (z+x) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 

  int_equals_add_second_first_same<span class="main">:</span>  <span class="comment1">(* IntegerEqualsNode.canonical(160) *)</span>
  <span class="comment1">(* (y+x) == (x+z) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_add_second_both__same<span class="main">:</span>  <span class="comment1">(* IntegerEqualsNode.canonical(164) *)</span>
  <span class="comment1">(* (y+x) == (z+x) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_sub_first_both_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(180) *)</span>
  <span class="comment1">(* (x-y) == (x-z) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>

  int_equals_sub_second_both_same<span class="main">:</span> <span class="comment1">(* IntegerEqualsNode.canonical(184) *)</span>
  <span class="comment1">(* (y-x) == (z-x) ⇒ (y == z) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEquals</span> <span class="free">g</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">)</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span> 

  <span class="comment1">(* NOTE: missing IntegerEqualsNode.canonicalizeSymmetricConstant rules *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizeIntegerEqualsGraph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  int_equals_rewrite<span class="main">:</span> <span class="comment1">(* use above rewrite rules if it matches *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeIntegerEquals <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="main">=</span> kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEqualsGraph</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span> <span class="main">|</span> 

  <span class="comment1">(* IntegerEquals.canonical(197) *)</span>
  <span class="comment1">(* (x+y) == x ⇒ (y == 0) *)</span>
  int_equals_left_contains_right1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nextNid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> constantAsStamp <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> 
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">const_id</span></span></span><span class="main">)</span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEqualsGraph</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* IntegerEquals.canonical(200) *)</span>
  <span class="comment1">(* (x+y) == y ⇒ (x == 0) *)</span>
  int_equals_left_contains_right2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nextNid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> constantAsStamp <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> 
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">const_id</span></span></span><span class="main">)</span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEqualsGraph</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> <span class="main">|</span> 

  <span class="comment1">(* IntegerEquals.canonical(208) *)</span>
  <span class="comment1">(* x == (x+y) ⇒ (y == 0) *)</span>
  int_equals_right_contains_left1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nextNid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> constantAsStamp <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> 
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">const_id</span></span></span><span class="main">)</span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEqualsGraph</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* IntegerEquals.canonical(211) *)</span>
  <span class="comment1">(* y == (x+y) ⇒ (x == 0) *)</span>
  int_equals_right_contains_left2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nextNid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> constantAsStamp <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> 
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">const_id</span></span></span><span class="main">)</span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEqualsGraph</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* IntegerEquals.canonical(219) *)</span>
  <span class="comment1">(* (x - y) == x ⇒ (y == 0) *)</span>
  int_equals_left_contains_right3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">left</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nextNid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> constantAsStamp <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> 
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">const_id</span></span></span><span class="main">)</span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEqualsGraph</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* IntegerEquals.canonical(227) *)</span>
  <span class="comment1">(* x == (x - y) ⇒ (y == 0) *)</span>
  int_equals_right_contains_left3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span><span class="main">;</span>
    kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">right</span></span></span> <span class="main">=</span> SubNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nextNid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>ConstantNode <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> constantAsStamp <span class="main">(</span>IntVal32 <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span> 
    <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">const_id</span></span></span> <span class="main">(</span><span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">const_id</span></span></span><span class="main">)</span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizeIntegerEqualsGraph</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span>

   <span class="comment1">(* NOTE: missing IntegerEqualsNode.canonicalizeSymmetricConstant rules *)</span>

<span class="comment1">(* TODO: BinaryArithmeticNode.reassociateMatchedConstants for all associative nodes *)</span>
<span class="comment1">(* TODO: BinaryArithmeticNode.reassociateUnmatchedValues *)</span>

<span class="comment1">(* TODO: XorNode *)</span>
<span class="comment1">(* TODO: IntegerLessThanNode *)</span>
<span class="comment1">(* TODO: ShortCircuitOrNode *)</span>
<span class="comment1">(* TODO: IsNullNode *)</span>

<span class="comment1">(* TODO: SignedDivNode *)</span>
<span class="comment1">(* TODO: SignedRemNode *)</span>

<span class="comment1">(* TODO: (Value)PhiNode *)</span>

<span class="comment1">(* TODO: LoadFieldNode *)</span>
<span class="comment1">(* TODO: StoreFieldNode *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizationStep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  ConditionalNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeConditional <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  AddNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeAdd <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  IfNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeIf <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* TODO: fix
  BinaryArithmaticNode:
  "⟦CanonicalizeBinaryArithmeticNode g node node'⟧
   ⟹ CanonicalizationStep g node node'"
  *)</span>

  SubNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeSub <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  MulNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeMul <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  AndNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeAnd <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  OrNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeOr <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  AbsNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeAbs <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  NotNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeNot <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  NegateNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeNegate <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span> <span class="main">|</span>

  LogicNegationNode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>CanonicalizeLogicNegation <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">CanonicalizationStep</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span> <span class="free"><span class="bound"><span class="entity">node'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeConditional</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeAdd</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeIf</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeSub</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeMul</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeAnd</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeOr</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeAbs</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeNot</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeNegate</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizeLogicNegation</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizationStep</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="comment1">(* dummy analysis *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> CanonicalizationAnalysis <span class="main">=</span> <span class="quoted"><span class="quoted">"bool option"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">analyse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ID <span class="main">×</span> Seen <span class="main">×</span> CanonicalizationAnalysis<span class="main">)</span> <span class="main">⇒</span> CanonicalizationAnalysis"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">analyse</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizationPhase</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> Seen <span class="main">×</span> CanonicalizationAnalysis<span class="main">)</span> <span class="main">⇒</span> IRGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

  <span class="comment1">― ‹Can do a step and optimise for the current node›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step analyse <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    CanonicalizationStep <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span><span class="main">;</span>
  
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">node</span></span></span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    
    <span class="free">CanonicalizationPhase</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹Can do a step, matches whether optimised or not causing non-determinism
      We need to find a way to negate ConditionalEliminationStep›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step analyse <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    
    <span class="free">CanonicalizationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* TODO: part of the step? *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step analyse <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> None<span class="main">;</span>
    Some <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>
    <span class="free">CanonicalizationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* TODO: part of the step? *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step analyse <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> None<span class="main">;</span>
    None <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizationPhase</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> Trace <span class="main">=</span> <span class="quoted"><span class="quoted">"IRNode list"</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">CanonicalizationPhaseWithTrace</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> Seen <span class="main">×</span> CanonicalizationAnalysis<span class="main">)</span> <span class="main">⇒</span> IRGraph <span class="main">⇒</span> Trace <span class="main">⇒</span> Trace <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

  <span class="comment1">― ‹Can do a step and optimise for the current node›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step analyse <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    CanonicalizationStep <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">node</span></span></span><span class="main">;</span>
  
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> replace_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">node</span></span></span><span class="main">,</span> stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">;</span>
    
    <span class="free">CanonicalizationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹Can do a step, matches whether optimised or not causing non-determinism
      We need to find a way to negate ConditionalEliminationStep›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step analyse <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    
    <span class="free">CanonicalizationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* TODO: part of the step? *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step analyse <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> None<span class="main">;</span>
    Some <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>
    <span class="free">CanonicalizationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* TODO: part of the step? *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step analyse <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> None<span class="main">;</span>
    None <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">CanonicalizationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">CanonicalizationPhaseWithTrace</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>