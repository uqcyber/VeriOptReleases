<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory CanonicalizationProofs</title>
</head>


<body>
<div class="head">
<h1>Theory CanonicalizationProofs</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span>
  CanonicalizationProofs
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Canonicalization.html">Canonicalization</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CanonicalizeConditionalProof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CanonicalizeConditional <span class="free">g</span> <span class="free">before</span> <span class="free">after</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span> <span class="main">∧</span> wf_stamps <span class="free">g</span> <span class="main">∧</span> wf_values <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">before</span> <span class="main">↦</span> <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">after</span> <span class="main">↦</span> <span class="free">res'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CanonicalizeConditional.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>negate_condition <span class="skolem">g</span> <span class="skolem">cond</span> <span class="skolem">flip</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">condv</span></span> <span class="keyword2"><span class="keyword">where</span></span> condv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">cond</span> <span class="main">↦</span> IntVal <span class="main">1</span> <span class="skolem">condv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> negate_condition.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">flipv</span></span> <span class="keyword2"><span class="keyword">where</span></span> flipv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">flip</span> <span class="main">↦</span> IntVal <span class="main">1</span> <span class="skolem">flipv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LogicNegationNodeE negate_condition.hyps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> invert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">condv</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">NOT</span> <span class="skolem">flipv</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.LogicNegationNode condv flipv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> evalDet negate_condition.hyps<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tbval</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">tb</span> <span class="main">↦</span> <span class="skolem">tbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> negate_condition.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fbval</span></span> <span class="keyword2"><span class="keyword">where</span></span> fbval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">fb</span> <span class="main">↦</span> <span class="skolem">fbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> negate_condition.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">condv</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">flipv</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.LogicNegationNode condv flipv
      <span class="keyword1"><span class="command">using</span></span> True evalDet negate_condition.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fbval</span> <span class="main">=</span> <span class="free">res</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.ConditionalNode tbval fbval flipv negate_condition
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> ConditionalNodeE True Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> condv evalDet<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> ConditionalNodeE True Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bit.compl_zero evalDet fbval flipv invert negate_condition.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> flipv_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">flipv</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> flipv wf_value_bit_range <span class="keyword1"><span class="command">sorry</span></span> <span class="comment1">(* broken by wf_range to 32
      by (metis eval_in_ids mem_Collect_eq negate_condition.prems(2) wf_values.elims(2))*)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">NOT</span> <span class="skolem">flipv</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False invert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">flipv</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_eq_complement <span class="keyword1"><span class="command">sorry</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">flipv</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flipv_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tbval</span> <span class="main">=</span> <span class="free">res</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.ConditionalNode tbval fbval flipv negate_condition
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> ConditionalNodeE False Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> condv evalDet<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">flipv</span> <span class="main">=</span> <span class="main">0</span>›</span></span> evalDet flipv negate_condition.prems<span class="main">(</span>4<span class="main">)</span> tbval <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const_true <span class="skolem">g</span> <span class="skolem">cond</span> <span class="skolem">val</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.RefNode evalDet <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const_false <span class="skolem">g</span> <span class="skolem">cond</span> <span class="skolem">val</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.RefNode evalDet <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eq_branches <span class="skolem">tb</span> <span class="skolem">fb</span> <span class="skolem">g</span> <span class="skolem">cond</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.RefNode evalDet <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cond_eq <span class="skolem">g</span> <span class="skolem">cond</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">condv</span></span> <span class="keyword2"><span class="keyword">where</span></span> condv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">cond</span> <span class="main">↦</span> <span class="skolem">condv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tbval</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">tb</span> <span class="main">↦</span> <span class="skolem">tbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cond_eq.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fbval</span></span> <span class="keyword2"><span class="keyword">where</span></span> fbval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">fb</span> <span class="main">↦</span> <span class="skolem">fbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cond_eq.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> cond_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"val_to_bool <span class="skolem">condv</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tbval</span> <span class="main">=</span> <span class="skolem">fbval</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IntegerEqualsNodeE condv cond_eq<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> True bool_to_val.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> evalDet fbval tbval val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cond_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> ConditionalNodeE eval.RefNode evalDet fbval tbval<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> ConditionalNodeE cond_eq.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cond_eq.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> condv eval.RefNode evalDet val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>condition_bounds_x <span class="skolem">g</span> <span class="skolem">cond</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tbval</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">tb</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">tbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> condition_bounds_x.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fbval</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> fbval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">fb</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">fbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> condition_bounds_x.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tbval</span> <span class="main">≤</span> <span class="skolem">fbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> condition_bounds_x.prems<span class="main">(</span>2<span class="main">)</span> tbval fbval condition_bounds_x.hyps<span class="main">(</span>2<span class="main">)</span> int_valid_range
    <span class="keyword1"><span class="command">unfolding</span></span> wf_stamps.simps 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> Stamp.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Stamp.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval_in_ids valid_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_value.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> IntVal <span class="skolem">b</span> <span class="skolem">tbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ConditionalNodeE tbval fbval
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> del_insts<span class="main"><span class="main">)</span></span> IntegerLessThanNodeE Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> condition_bounds_x.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> condition_bounds_x.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> evalDet<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> condition_bounds_x.prems<span class="main">(</span>3<span class="main">)</span> eval.RefNode evalDet tbval
    <span class="keyword1"><span class="command">using</span></span> ConditionalNodeE Value.sel<span class="main">(</span>1<span class="main">)</span> condition_bounds_x.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>condition_bounds_y <span class="skolem">g</span> <span class="skolem">cond</span> <span class="skolem">fb</span> <span class="skolem">tb</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tbval</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">tb</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">tbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> condition_bounds_y.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fbval</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> fbval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">fb</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">fbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> condition_bounds_y.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tbval</span> <span class="main">≥</span> <span class="skolem">fbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> condition_bounds_y.prems<span class="main">(</span>2<span class="main">)</span> tbval fbval condition_bounds_y.hyps<span class="main">(</span>2<span class="main">)</span> int_valid_range
    <span class="keyword1"><span class="command">unfolding</span></span> wf_stamps.simps 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> Stamp.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> boundsAlwaysOverlap eval_in_ids valid_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_value.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> IntVal <span class="skolem">b</span> <span class="skolem">tbval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ConditionalNodeE tbval fbval
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> IntegerLessThanNodeE Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> condition_bounds_y.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> condition_bounds_y.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> evalDet<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> condition_bounds_y.prems<span class="main">(</span>3<span class="main">)</span> eval.RefNode evalDet tbval
    <span class="keyword1"><span class="command">using</span></span> ConditionalNodeE Value.sel<span class="main">(</span>1<span class="main">)</span> condition_bounds_y.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_zero_32<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_value <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">31</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">31</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_value.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> plus_Value_def intval_add.simps <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">31</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">31</span>›</span></span> signed_take_bit_int_eq_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_zero_64<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_value <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IntVal <span class="numeral">64</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="numeral">64</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="numeral">63</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="numeral">63</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_value.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> plus_Value_def intval_add.simps <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">63</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">63</span>›</span></span> signed_take_bit_int_eq_self <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_value <span class="main">(</span>IntVal <span class="free">bc</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bc</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">32</span><span class="main">,</span><span class="numeral">64</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>IntVal <span class="free">bc</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>IntVal <span class="free">bc</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="free">bc</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">bc</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span><span class="main">(</span>nat <span class="free">bc</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_value.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> intval_add.simps <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> bounds signed_take_bit_int_eq_self assms plus_Value_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*
lemma 
  assumes "wf_value (IntVal bl y)"
  assumes "bl ∈ {32,64}"

  shows "(IntVal bl 0) +* (IntVal bl y) = (IntVal br y)"
proof -
  have bounds: "-(2^((nat bl)-1)) ≤ y ∧ y &lt; 2^((nat bl)-1)"
    using assms unfolding wf_value.simps by auto
  then show ?thesis unfolding intval_add.simps apply auto
    using bounds assms
    apply auto using signed_take_bit_int_eq_self apply auto
    try
qed
*)</span>

<span class="comment1">(* (-x + y) ⇒ (y - x) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_value <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> wf_value <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>IntVal <span class="free">b</span> <span class="main">0</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">y</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> plus_Value_def minus_Value_def wf_value.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> CanonicalizeAddProof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CanonicalizeAdd <span class="free">g</span> <span class="free">before</span> <span class="free">after</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span> <span class="main">∧</span> wf_stamps <span class="free">g</span> <span class="main">∧</span> wf_values <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">before</span> <span class="main">↦</span> IntVal <span class="free">b</span> <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">after</span> <span class="main">↦</span> IntVal <span class="free">b'</span> <span class="free">res'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="free">res'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> addkind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">before</span> <span class="main">=</span> AddNode <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CanonicalizeAdd.simps assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> addkind
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xval</span></span> <span class="keyword2"><span class="keyword">where</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">xval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> addkind
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yval</span></span> <span class="keyword2"><span class="keyword">where</span></span> yval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="skolem">y</span> <span class="main">↦</span> <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="free">b</span> <span class="free">res</span> <span class="main">=</span> intval_add <span class="skolem">xval</span> <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> eval.AddNode
    <span class="keyword1"><span class="command">using</span></span> addkind evalDet xval yval plus_Value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms addkind xval yval res
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> <span class="quoted">"CanonicalizeAdd.induct"</span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add_both_const <span class="skolem">x</span> <span class="skolem">c_1</span> <span class="skolem">y</span> <span class="skolem">c_2</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eval.ConstantNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ConstantNodeE IRNode.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add_xzero <span class="skolem">x</span> <span class="skolem">c_1</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> xeval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ConstantNode add_xzero.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_xzero.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> yeval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="skolem">y</span> <span class="main">↦</span> <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_xzero.prems<span class="main">(</span>4<span class="main">)</span> yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ywf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_value <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> yeval add_xzero.prems<span class="main">(</span>1<span class="main">)</span> eval_in_ids wf_values.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="free">b'</span> <span class="free">res'</span> <span class="main">=</span> <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> RefNodeE add_xzero.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> evalDet yeval<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bpBits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> <span class="numeral">32</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ywf wf_int32 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> res_val<span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="free">b</span> <span class="free">res</span> <span class="main">=</span> intval_add <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.AddNode eval.ConstantNode add_xzero<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> evalDet <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IRNode.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_xzero.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> res xval<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bBits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">32</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ywf intval_add_bits bpBits y <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.RefNode yval res_val ywf add32_0 y plus_Value_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_zero_32 bpBits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add_yzero <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">c_2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> yeval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="skolem">y</span> <span class="main">↦</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ConstantNode add_yzero.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_yzero.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> xeval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">xval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_yzero.prems<span class="main">(</span>4<span class="main">)</span> xval <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xwf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_value <span class="skolem">xval</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> yeval add_yzero.prems<span class="main">(</span>1<span class="main">)</span> eval_in_ids wf_values.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="free">b'</span> <span class="free">res'</span> <span class="main">=</span> <span class="skolem">xval</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> RefNodeE add_yzero.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> evalDet xeval<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bpBits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> <span class="numeral">32</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xwf wf_int32 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IntVal <span class="free">b</span> <span class="free">res</span> <span class="main">=</span> intval_add <span class="skolem">xval</span> <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.AddNode eval.ConstantNode add_yzero<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> evalDet xeval plus_Value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"IntVal <span class="free">b</span> <span class="free">res</span> <span class="main">=</span> intval_add <span class="main">(</span>IntVal <span class="numeral">32</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">xval</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intval_add_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">32</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xwf intval_add_bits bpBits y <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> eval.RefNode xval wf_int32 intval_add_bits plus_Value_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> res add_zero_32 xwf y<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add_xsub <span class="skolem">x</span> <span class="skolem">a</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add_ysub <span class="skolem">y</span> <span class="skolem">a</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add_xnegate <span class="skolem">nx</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add_ynegate <span class="skolem">ny</span> <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> CanonicalizeSubProof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CanonicalizeSub <span class="free">g</span> <span class="free">before</span> <span class="free">after</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_stamps <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">before</span> <span class="main">↦</span> IntVal <span class="free">b1</span> <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">after</span> <span class="main">↦</span> IntVal <span class="free">b2</span> <span class="free">res'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CanonicalizeSub.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_same <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">b</span> <span class="skolem">l</span> <span class="skolem">h</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_both_const <span class="skolem">x</span> <span class="skolem">c_1</span> <span class="skolem">y</span> <span class="skolem">c_2</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_left_add1 <span class="skolem">left</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_left_add2 <span class="skolem">left</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_left_sub <span class="skolem">left</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_right_add1 <span class="skolem">right</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_right_add2 <span class="skolem">right</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_right_sub <span class="skolem">right</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_yzero <span class="skolem">y</span> <span class="skolem">uu</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_xzero <span class="skolem">x</span> <span class="skolem">uv</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_y_negate <span class="skolem">nb</span> <span class="skolem">b</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> CanonicalizeIfProof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span><span class="main">::</span><span class="quoted">MapState</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span><span class="main">::</span><span class="quoted">FieldRefHeap</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> <span class="free">before</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"CanonicalizeIf <span class="free">g</span> <span class="free">before</span> <span class="free">after</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> replace_node <span class="free">nid</span> <span class="main">(</span><span class="free">after</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">|</span> <span class="free">g</span> <span class="main">∼</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CanonicalizeIf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trueConst <span class="skolem">cond</span> <span class="skolem">condv</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ConstantNode IfNode trueConst.hyps<span class="main">(</span>1<span class="main">)</span> trueConst.hyps<span class="main">(</span>2<span class="main">)</span> trueConst.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> step.IfNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> g'step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> replace_node_lookup
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stepRefNode trueConst.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gstep g'step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lockstep_strong_bisimilulation assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>falseConst <span class="skolem">cond</span> <span class="skolem">condv</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ConstantNode IfNode falseConst.hyps<span class="main">(</span>1<span class="main">)</span> falseConst.hyps<span class="main">(</span>2<span class="main">)</span> falseConst.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> step.IfNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> g'step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> replace_node_lookup
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> falseConst.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stepRefNode<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gstep g'step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lockstep_strong_bisimilulation assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eqBranch <span class="skolem">cond</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="skolem">cond</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IfNodeCond
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> eqBranch.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eqBranch.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eqBranch<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> IfNodeStepCases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> g'step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqBranch.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stepRefNode<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gstep g'step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lockstep_strong_bisimilulation assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eqCondition <span class="skolem">cond</span> <span class="skolem">x</span> <span class="skolem">tb</span> <span class="skolem">fb</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="skolem">cond</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IfNodeCond
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> eqCondition.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eqCondition.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step.IfNode eval.IntegerEqualsNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> IntegerEqualsNodeE bool_to_val.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cval eqCondition.hyps eqCondition.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g'step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> replace_node_lookup
    <span class="keyword1"><span class="command">using</span></span> IRNode.simps<span class="main">(</span>2114<span class="main">)</span> eqCondition.prems<span class="main">(</span>3<span class="main">)</span> stepRefNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">from</span></span> gstep g'step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lockstep_strong_bisimilulation assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(*
lemma add_zero:
  assumes "x &lt; (2 ^ (LENGTH('a) - 1))"
  shows "(sint ((word_of_int 0::('a::len word)) + word_of_int x::('a::len word))) = x"
proof -
  have "sint (word_of_int x::('a word)) = x"
    using assms sorry
  show ?thesis sorry
qed

value "word_of_int (-2)::(32word)"
value "sint (word_of_int (-2)::32word)"
value "sint (word_of_int 0 + word_of_int (-2)::32word)"


(* these are incorrect with the introduction of accurate addition semantics *)
(* most obviously due to the resultant b being either 32 or 64 *)
lemma add_val_xzero:
  shows "intval_add (IntVal b 0) (IntVal b yv) = (IntVal b yv)"
  unfolding intval_add.simps sorry

lemma add_val_yzero:
  shows "intval_add (IntVal b xv) (IntVal b 0) = (IntVal b xv)"
  unfolding intval_add.simps sorry
*)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>