<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory ConditionalElimination</title>
</head>


<body>
<div class="head">
<h1>Theory ConditionalElimination</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Conditional Elimination Phase›</span></span>

<span class="keyword1"><span class="command">theory</span></span> ConditionalElimination
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Proofs/IRGraphFrames.html">Proofs.IRGraphFrames</a>
    <a href="../Proofs/Stuttering.html">Proofs.Stuttering</a>
    <a href="../Proofs/Form.html">Proofs.Form</a>
    <a href="../Proofs/Rewrites.html">Proofs.Rewrites</a>
    <a href="../Proofs/Bisimulation.html">Proofs.Bisimulation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Individual Elimination Rules›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We introduce a TriState as in the Graal compiler to represent when static
analysis can tell us information about the value of a boolean expression.
Unknown = No information can be inferred
KnownTrue/KnownFalse = We can infer the expression will always be true or false.
›</span></span>
<span class="keyword1"><span class="command">datatype</span></span> TriState <span class="main">=</span> Unknown <span class="main">|</span> KnownTrue <span class="main">|</span> KnownFalse

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The implies relation corresponds to the LogicNode.implies
method from the compiler which attempts to infer when one
logic nodes value can be inferred from a known logic node.
›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">implies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> TriState <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">&amp;</span> _ <span class="keyword1">↪</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  eq_imp_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownFalse"</span></span> <span class="main">|</span>
  eq_imp_less_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownFalse"</span></span> <span class="main">|</span>
  less_imp_rev_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownFalse"</span></span> <span class="main">|</span>
  less_imp_not_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownFalse"</span></span> <span class="main">|</span>
  less_imp_not_eq_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownFalse"</span></span> <span class="main">|</span>

  x_imp_x<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↪</span></span> KnownTrue"</span></span> <span class="main">|</span>

  negate_false<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownTrue<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>LogicNegationNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownFalse"</span></span> <span class="main">|</span>
  negate_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownFalse<span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="main">(</span>LogicNegationNode <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main"><span class="free">↪</span></span> KnownTrue"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Total relation over partial implies relation›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">condition_implies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRNode <span class="main">⇒</span> TriState <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">&amp;</span> _ <span class="keyword1">⇀</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span><span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">↪</span> <span class="free"><span class="bound"><span class="entity">imp</span></span></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="free">⇀</span></span> Unknown<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">g</span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">↪</span> <span class="free"><span class="bound"><span class="entity">imp</span></span></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">&amp;</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main"><span class="free">⇀</span></span> <span class="free"><span class="bound"><span class="entity">imp</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Proofs that the implies relation is correct with respect to the 
existing evaluation semantics.
›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> logic_negation_relation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_values <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">y</span> <span class="main">↦</span> <span class="free">val</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">neg</span> <span class="main">=</span> LogicNegationNode <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">neg</span> <span class="main">↦</span> <span class="free">invval</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_to_bool <span class="free">val</span> <span class="main">⟷</span> <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free">inval</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_value <span class="free">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> eval_in_ids wf_values.elims<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_value <span class="free">invval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> eval_in_ids wf_values.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms eval.LogicNegationNode
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implies_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span> <span class="main">∧</span> wf_values <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">&amp;</span> <span class="free">y</span> <span class="main">⇀</span> <span class="free">imp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">↦</span> <span class="free">v1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">↦</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">imp</span> <span class="main">=</span> KnownTrue <span class="main">⟶</span> <span class="main">(</span>val_to_bool <span class="free">v1</span> <span class="main">⟶</span> val_to_bool <span class="free">v2</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="free">imp</span> <span class="main">=</span> KnownFalse <span class="main">⟶</span> <span class="main">(</span>val_to_bool <span class="free">v1</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free">v2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?TP</span> <span class="main">⟶</span> <span class="var">?TC</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?FP</span> <span class="main">⟶</span> <span class="var">?FC</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> KnownTrue<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?TP</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?TC</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">&amp;</span> <span class="free">y</span> <span class="main">↪</span> <span class="free">imp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> KnownTrue assms<span class="main">(</span>2<span class="main">)</span> condition_implies.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> KnownTrue assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">imp</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> implies.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eq_imp_less <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eq_imp_less_rev <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less_imp_rev_less <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less_imp_not_eq <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less_imp_not_eq_rev <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>x_imp_x <span class="skolem">x1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> evalDet
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>negate_false <span class="skolem">x1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> evalDet
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>negate_true <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> logic_negation_relation
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> KnownFalse<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?FP</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?FC</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">&amp;</span> <span class="free">y</span> <span class="main">↪</span> <span class="free">imp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> KnownFalse assms<span class="main">(</span>2<span class="main">)</span> condition_implies.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms KnownFalse <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">imp</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> implies.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eq_imp_less <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">xval</span></span> <span class="keyword2"><span class="keyword">where</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">xval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_imp_less.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yval</span></span> <span class="keyword2"><span class="keyword">where</span></span> yval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">yval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_imp_less.prems<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> evalDet <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> eqeval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerEqualsNode <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">xval</span> <span class="main">=</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerEqualsNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> lesseval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerLessThanNode <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerLessThanNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xval</span> <span class="main">=</span> <span class="skolem">yval</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eqeval lesseval
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted">"eq_imp_less.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted">"eq_imp_less.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> evalDet val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eq_imp_less_rev <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">xval</span></span> <span class="keyword2"><span class="keyword">where</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">xval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_imp_less_rev.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yval</span></span> <span class="keyword2"><span class="keyword">where</span></span> yval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">yval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_imp_less_rev.prems<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> evalDet <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> eqeval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerEqualsNode <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">xval</span> <span class="main">=</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerEqualsNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> lesseval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerLessThanNode <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">yval</span> <span class="main">&lt;</span> <span class="skolem">xval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerLessThanNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xval</span> <span class="main">=</span> <span class="skolem">yval</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="skolem">yval</span> <span class="main">&lt;</span> <span class="skolem">xval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eqeval lesseval
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> eq_imp_less_rev.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> eq_imp_less_rev.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> evalDet val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less_imp_rev_less <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">xval</span></span> <span class="keyword2"><span class="keyword">where</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">xval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_imp_rev_less.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yval</span></span> <span class="keyword2"><span class="keyword">where</span></span> yval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">yval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_imp_rev_less.prems<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> evalDet <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> lesseval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerLessThanNode <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerLessThanNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> revlesseval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerLessThanNode <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">yval</span> <span class="main">&lt;</span> <span class="skolem">xval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerLessThanNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="skolem">yval</span> <span class="main">&lt;</span> <span class="skolem">xval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> evalDet less_imp_rev_less.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> less_imp_rev_less.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lesseval revlesseval val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less_imp_not_eq <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">xval</span></span> <span class="keyword2"><span class="keyword">where</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">xval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_imp_not_eq.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yval</span></span> <span class="keyword2"><span class="keyword">where</span></span> yval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">yval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_imp_not_eq.prems<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> evalDet <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> eqeval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerEqualsNode <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">xval</span> <span class="main">=</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerEqualsNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> lesseval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerLessThanNode <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerLessThanNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="skolem">xval</span> <span class="main">=</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eqeval evalDet less_imp_not_eq.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> less_imp_not_eq.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lesseval val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less_imp_not_eq_rev <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">xval</span></span> <span class="keyword2"><span class="keyword">where</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">xval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_imp_not_eq_rev.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yval</span></span> <span class="keyword2"><span class="keyword">where</span></span> yval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">yval</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_imp_not_eq_rev.prems<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> evalDet <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> eqeval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerEqualsNode <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">yval</span> <span class="main">=</span> <span class="skolem">xval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerEqualsNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> lesseval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>IntegerLessThanNode <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">↦</span> bool_to_val<span class="main">(</span><span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval.IntegerLessThanNode
      <span class="keyword1"><span class="command">using</span></span> xval yval <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="skolem">yval</span> <span class="main">=</span> <span class="skolem">xval</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eqeval evalDet less_imp_not_eq_rev.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> less_imp_not_eq_rev.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lesseval val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>x_imp_x <span class="skolem">x1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>negate_false <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> logic_negation_relation <span class="keyword1"><span class="command">sorry</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>negate_true <span class="skolem">x1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> implies_true_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span> <span class="main">∧</span> wf_values <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">&amp;</span> <span class="free">y</span> <span class="main">⇀</span> <span class="free">imp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">imp</span> <span class="main">=</span> KnownTrue"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">↦</span> <span class="free">v1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">↦</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_to_bool <span class="free">v1</span> <span class="main">⟶</span> val_to_bool <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms implies_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> implies_false_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span> <span class="main">∧</span> wf_values <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">&amp;</span> <span class="free">y</span> <span class="main">⇀</span> <span class="free">imp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">imp</span> <span class="main">=</span> KnownFalse"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">x</span> <span class="main">↦</span> <span class="free">v1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="free">y</span> <span class="main">↦</span> <span class="free">v2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_to_bool <span class="free">v1</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free">v2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms implies_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following relation corresponds to the UnaryOpLogicNode.tryFold
and BinaryOpLogicNode.tryFold methods and their associated concrete implementations.

The relation determines if a logic operation can be shown true or false
through the stamp typing information.
›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">tryFold</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRNode <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">⇒</span> Stamp<span class="main">)</span> <span class="main">⇒</span> TriState <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>alwaysDistinct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">tryFold</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> KnownFalse"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>neverDistinct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">tryFold</span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> KnownTrue"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_IntegerStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    is_IntegerStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    stpi_upper <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">&lt;</span> stpi_lower <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">tryFold</span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> KnownTrue"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_IntegerStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span>
    is_IntegerStamp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">;</span>
    stpi_lower <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">≥</span> stpi_upper <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="free">tryFold</span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> KnownFalse"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Proofs that show that when the stamp lookup function is well-formed,
the tryFold relation correctly predicts the output value with respect to
our evaluation semantics.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> tryFoldIntegerEqualsAlwaysDistinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_stamp <span class="free">g</span> <span class="free">stamps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IntegerEqualsNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="main">↦</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alwaysDistinct <span class="main">(</span><span class="free">stamps</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">stamps</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> IntVal <span class="main">1</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms eval.IntegerEqualsNode join_unequal alwaysDistinct.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> IntegerEqualsNodeE bool_to_val.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> eval_in_ids wf_stamp.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tryFoldIntegerEqualsNeverDistinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_stamp <span class="free">g</span> <span class="free">stamps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IntegerEqualsNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="main">↦</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"neverDistinct <span class="main">(</span><span class="free">stamps</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">stamps</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> IntVal <span class="main">1</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms neverDistinctEqual IntegerEqualsNodeE
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval_in_ids wf_stamp.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tryFoldIntegerLessThanTrue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_stamp <span class="free">g</span> <span class="free">stamps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IntegerLessThanNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="main">↦</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stpi_upper <span class="main">(</span><span class="free">stamps</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> stpi_lower <span class="main">(</span><span class="free">stamps</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> IntVal <span class="main">1</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> stamp_type<span class="main">:</span> <span class="quoted"><span class="quoted">"is_IntegerStamp <span class="main">(</span><span class="free">stamps</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntegerLessThanNodeE Stamp.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Value.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval_in_ids valid_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_stamp.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xval</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">x</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">xval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> eval.IntegerLessThanNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yval</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> yval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">y</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> eval.IntegerLessThanNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_IntegerStamp <span class="main">(</span><span class="free">stamps</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> is_IntegerStamp <span class="main">(</span><span class="free">stamps</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stamp_type Stamp.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Value.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval_in_ids valid_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_stamp.simps yval<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> boundsNoOverlap xval yval assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> eval_in_ids wf_stamp.elims<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> IntegerLessThanNodeE Value.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> evalDet xval yval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tryFoldIntegerLessThanFalse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_stamp <span class="free">g</span> <span class="free">stamps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IntegerLessThanNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="main">↦</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stpi_lower <span class="main">(</span><span class="free">stamps</span> <span class="free">x</span><span class="main">)</span> <span class="main">≥</span> stpi_upper <span class="main">(</span><span class="free">stamps</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> IntVal <span class="main">1</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> stamp_type<span class="main">:</span> <span class="quoted"><span class="quoted">"is_IntegerStamp <span class="main">(</span><span class="free">stamps</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntegerLessThanNodeE Stamp.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Value.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval_in_ids valid_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_stamp.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xval</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> xval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">x</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">xval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> eval.IntegerLessThanNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yval</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> yval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">y</span> <span class="main">↦</span> IntVal <span class="skolem">b</span> <span class="skolem">yval</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> eval.IntegerLessThanNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_IntegerStamp <span class="main">(</span><span class="free">stamps</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> is_IntegerStamp <span class="main">(</span><span class="free">stamps</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stamp_type Stamp.disc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Value.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eval_in_ids valid_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_stamp.simps yval<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">xval</span> <span class="main">&lt;</span> <span class="skolem">yval</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> boundsAlwaysOverlap xval yval assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> eval_in_ids wf_stamp.elims<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> IntegerLessThanNodeE Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> bool_to_val.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> evalDet xval yval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> tryFoldProofTrue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_stamp <span class="free">g</span> <span class="free">stamps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tryFold <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="free">stamps</span> <span class="free">tristate</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">tristate</span> <span class="main">=</span> KnownTrue"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">nid</span> <span class="main">↦</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_to_bool <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span>"</span></span> <span class="quoted"><span class="free">stamps</span></span> <span class="quoted"><span class="free">tristate</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tryFold.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">stamps</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tryFoldIntegerEqualsAlwaysDistinct assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> IRNode.distinct<span class="main"><span class="main">(</span></span>949<span class="main"><span class="main">)</span></span> TriState.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tryFold.cases tryFoldIntegerEqualsNeverDistinct val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">stamps</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tryFoldIntegerEqualsAlwaysDistinct assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> IRNode.distinct<span class="main"><span class="main">(</span></span>949<span class="main"><span class="main">)</span></span> TriState.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tryFold.cases tryFoldIntegerEqualsNeverDistinct val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">stamps</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tryFoldIntegerLessThanTrue assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> IRNode.simps<span class="main"><span class="main">(</span></span>994<span class="main"><span class="main">)</span></span> TriState.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> tryFold.cases val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">stamps</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tryFoldIntegerLessThanFalse assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> IRNode.simps<span class="main"><span class="main">(</span></span>994<span class="main"><span class="main">)</span></span> TriState.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> tryFold.simps tryFoldIntegerLessThanTrue val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> tryFoldProofFalse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_stamp <span class="free">g</span> <span class="free">stamps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tryFold <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="free">stamps</span> <span class="free">tristate</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">tristate</span> <span class="main">=</span> KnownFalse"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="main">↦</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span>"</span></span> <span class="quoted"><span class="free">stamps</span></span> <span class="quoted"><span class="free">tristate</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tryFold.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">stamps</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tryFoldIntegerEqualsAlwaysDistinct assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> IRNode.distinct<span class="main"><span class="main">(</span></span>949<span class="main"><span class="main">)</span></span> TriState.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tryFold.cases val_to_bool.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">stamps</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tryFoldIntegerEqualsNeverDistinct assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> IRNode.distinct<span class="main"><span class="main">(</span></span>949<span class="main"><span class="main">)</span></span> TriState.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Value.inject<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tryFold.cases tryFoldIntegerEqualsAlwaysDistinct val_to_bool.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">stamps</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tryFoldIntegerLessThanTrue assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> TriState.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tryFold.cases tryFoldIntegerEqualsAlwaysDistinct tryFoldIntegerLessThanFalse val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">stamps</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tryFoldIntegerLessThanFalse assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> TriState.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tryFold.cases tryFoldIntegerEqualsAlwaysDistinct val_to_bool.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">inductive_cases</span></span> StepE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">nid'</span><span class="main">,</span><span class="free">m'</span><span class="main">,</span><span class="free">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Perform conditional elimination rewrites on the graph for a particular node.

In order to determine conditional eliminations appropriately the rule needs two
data structures produced by static analysis.
The first parameter is the set of IRNodes that we know result in a true value
when evaluated.
The second parameter is a mapping from node identifiers to the flow-sensitive stamp.

The relation transforms the third parameter to the fifth parameter for a node identifier
which represents the fourth parameter.
›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ConditionalEliminationStep</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"IRNode set <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">⇒</span> Stamp<span class="main">)</span> <span class="main">⇒</span> IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> IRGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  impliesTrue<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cid</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cid</span></span></span><span class="main">;</span>
    <span class="main">∃</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span> <span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⊢</span> <span class="bound">c</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">↪</span> KnownTrue<span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> constantCondition True <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ConditionalEliminationStep</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span> <span class="main">|</span>

  impliesFalse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cid</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cid</span></span></span><span class="main">;</span>
    <span class="main">∃</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span> <span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⊢</span> <span class="bound">c</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">↪</span> KnownFalse<span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> constantCondition False <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ConditionalEliminationStep</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span> <span class="main">|</span>

  tryFoldTrue<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cid</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cid</span></span></span><span class="main">;</span>
    tryFold <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> KnownTrue<span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> constantCondition True <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ConditionalEliminationStep</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span> <span class="main">|</span>

  tryFoldFalse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free"><span class="bound"><span class="entity">cid</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main">=</span> kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cid</span></span></span><span class="main">;</span>
    tryFold <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cid</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> KnownFalse<span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">=</span> constantCondition False <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>
    <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ConditionalEliminationStep</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span>


<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">ConditionalEliminationStep</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">thm</span></span> ConditionalEliminationStep.equation

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Control-flow Graph Traversal›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> Seen <span class="main">=</span> <span class="quoted"><span class="quoted">"ID set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> Conditions <span class="main">=</span> <span class="quoted"><span class="quoted">"IRNode list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> StampFlow <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ID <span class="main">⇒</span> Stamp<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
nextEdge helps determine which node to traverse next by returning the first successor
edge that isn't in the set of already visited nodes.
If there is not an appropriate successor, None is returned instead.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nextEdge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Seen <span class="main">⇒</span> ID <span class="main">⇒</span> IRGraph <span class="main">⇒</span> ID option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nextEdge</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">nids</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">nid'</span><span class="main">.</span> <span class="bound">nid'</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">)</span> <span class="main">(</span>successors_of <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> 
     <span class="main">(</span><span class="keyword1">if</span> length <span class="bound">nids</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">(</span>hd <span class="bound">nids</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
pred determines which node, if any, acts as the predecessor of another.

Merge nodes represent a special case where-in the predecessor exists as
an input edge of the merge node, to simplify the traversal we treat only
the first input end node as the predecessor, ignoring that multiple nodes
may act as a successor.

For all other nodes, the predecessor is the first element of the predecessors set.
Note that in a well-formed graph there should only be one element in the predecessor set.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>MergeNode <span class="bound">ends</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>hd <span class="bound">ends</span><span class="main">)</span> <span class="main">|</span>
    <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> 
      <span class="main">(</span><span class="keyword1">if</span> IRGraph.predecessors <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> <span class="main">{}</span> 
        <span class="keyword1">then</span> None <span class="keyword1">else</span>
        Some <span class="main">(</span>hd <span class="main">(</span>sorted_list_of_set <span class="main">(</span>IRGraph.predecessors <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
When the basic block of an if statement is entered, we know that the condition of the
preceding if statement must be true.
As in the GraalVM compiler, we introduce the registerNewCondition funciton which roughly
corresponds to the ConditionalEliminationPhase.registerNewCondition.
This method updates the flow-sensitive stamp information based on the condition which
we know must be true. 
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">clip_upper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> int <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clip_upper</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">clip_upper</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">clip_lower</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Stamp <span class="main">⇒</span> int <span class="main">⇒</span> Stamp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">clip_lower</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span>IntegerStamp <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">clip_lower</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">registerNewCondition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> IRNode <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">⇒</span> Stamp<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">⇒</span> Stamp<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(* constrain equality by joining the stamps *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">registerNewCondition</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>IntegerEqualsNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> join <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">:=</span> join <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="comment1">(* constrain less than by removing overlapping stamps *)</span>
  <span class="quoted"><span class="quoted">"<span class="free">registerNewCondition</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>IntegerLessThanNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> clip_upper <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>stpi_lower <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">:=</span> clip_lower <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span>stpi_upper <span class="main">(</span><span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">registerNewCondition</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">stamps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hdOr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hdOr</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">de</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">hdOr</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">de</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">de</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The Step relation is a small-step traversal of the graph which handles transitions between
individual nodes of the graph.

It relates a pairs of tuple of the current node, the set of seen nodes, 
the always true stack of IfNode conditions, and the flow-sensitive stamp information.
›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">Step</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> Seen <span class="main">×</span> Conditions <span class="main">×</span> StampFlow<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> Seen <span class="main">×</span> Conditions <span class="main">×</span> StampFlow<span class="main">)</span> option <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹
  Hit a BeginNode with an IfNode predecessor which represents
  the start of a basic block for the IfNode.
     1. nid' will be the successor of the begin node.
     2. Find the first and only predecessor.
     3. Extract condition from the preceding IfNode.
     4. Negate condition if the begin node is second branch
        (we've taken the else branch of the condition)
     5. Add the condition or the negated condition to stack
     6. Perform any stamp updates based on the condition using
        the registerNewCondition function and place them on the
        top of the stack of stamp information
  ›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> BeginNode <span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>

    Some <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">=</span> pred <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>
    kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span> <span class="main">=</span> IfNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> find_index <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span>successors_of <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">ifcond</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="keyword1">else</span> NegateNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">conds'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">flow'</span></span></span> <span class="main">=</span> registerNewCondition <span class="free">g</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span><span class="main">)</span> <span class="main">(</span>hdOr <span class="free"><span class="bound"><span class="entity">flow</span></span></span> <span class="main">(</span>stamp <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Step</span> <span class="free">g</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹
  Hit an EndNode
     1. nid' will be the usage of EndNode
     2. pop the conditions and stamp stack
  ›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">=</span> EndNode<span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="main">=</span> any_usage <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">conds'</span></span></span> <span class="main">=</span> tl <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">flow'</span></span></span> <span class="main">=</span> tl <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Step</span> <span class="free">g</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹We can find a successor edge that is not in seen, go there›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_EndNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_BeginNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>

    Some <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="main">=</span> nextEdge <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free">g</span><span class="main">⟧</span>
   <span class="main">⟹</span> <span class="free">Step</span> <span class="free">g</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹We can cannot find a successor edge that is not in seen, give back None›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span><span class="main">(</span>is_EndNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">¬</span><span class="main">(</span>is_BeginNode <span class="main">(</span>kind <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

    <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>

    None <span class="main">=</span> nextEdge <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free">g</span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">Step</span> <span class="free">g</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> None"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹We've already seen this node, give back None›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Step</span> <span class="free">g</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">Step</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The ConditionalEliminationPhase relation is responsible for combining
the individual traversal steps from the Step relation and the optimizations
from the ConditionalEliminationStep relation to perform a transformation of the
whole graph.
›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ConditionalEliminationPhase</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> Seen <span class="main">×</span> Conditions <span class="main">×</span> StampFlow<span class="main">)</span> <span class="main">⇒</span> IRGraph <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

  <span class="comment1">― ‹Can do a step and optimise for the current node›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    ConditionalEliminationStep <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">)</span> <span class="main">(</span>hdOr <span class="free"><span class="bound"><span class="entity">flow</span></span></span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">;</span>
    
    <span class="free">ConditionalEliminationPhase</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">ConditionalEliminationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹Can do a step, matches whether optimised or not causing non-determinism
      We need to find a way to negate ConditionalEliminationStep›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    
    <span class="free">ConditionalEliminationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">ConditionalEliminationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹Can't do a step but there is a predecessor we can backtrace to›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> None<span class="main">;</span>
    Some <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>
    <span class="free">ConditionalEliminationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">ConditionalEliminationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">― ‹Can't do a step and have no predecessors so terminate›</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> None<span class="main">;</span>
    None <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">ConditionalEliminationPhase</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">ConditionalEliminationPhase</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ConditionalEliminationPhaseWithTrace</span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> <span class="main">(</span>ID <span class="main">×</span> Seen <span class="main">×</span> Conditions <span class="main">×</span> StampFlow<span class="main">)</span> <span class="main">⇒</span> ID list <span class="main">⇒</span> IRGraph <span class="main">⇒</span> ID list <span class="main">⇒</span> Conditions <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span><span class="comment1">✐<span class="quoted">‹tag invisible›</span></span>

  <span class="comment1">(* Can do a step and optimise for the current nid *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    ConditionalEliminationStep <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">)</span> <span class="main">(</span>hdOr <span class="free"><span class="bound"><span class="entity">flow</span></span></span> <span class="main">(</span>stamp <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span><span class="main">;</span>
    
    <span class="free">ConditionalEliminationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">conds''</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">ConditionalEliminationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">conds''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* Can do a step, matches whether optimised or not causing non-determinism
     Need to find a way to negate ConditionalEliminationStep *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    
    <span class="free">ConditionalEliminationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow'</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">conds''</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">ConditionalEliminationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">conds''</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* Can't do a step but there is a predecessor we can backtrace to *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> None<span class="main">;</span>
    Some <span class="free"><span class="bound"><span class="entity">nid'</span></span></span> <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">seen'</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">;</span>
    <span class="free">ConditionalEliminationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">ConditionalEliminationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">g'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">conds'</span></span></span>"</span></span> <span class="main">|</span>

  <span class="comment1">(* Can't do a step and have no predecessors do terminate *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Step <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> None<span class="main">;</span>
    None <span class="main">=</span> pred <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">ConditionalEliminationPhaseWithTrace</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">seen</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">flow</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">conds</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ i ⇒ o ⇒ o ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">ConditionalEliminationPhaseWithTrace</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">lemma</span></span> IfNodeStepE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">m'</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">cond</span> <span class="bound">tb</span> <span class="bound">fb</span> <span class="bound">val</span><span class="main">.</span>
        kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> IfNode <span class="bound">cond</span> <span class="bound">tb</span> <span class="bound">fb</span> <span class="main">⟹</span>
        <span class="free">nid'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="bound">val</span> <span class="keyword1">then</span> <span class="bound">tb</span> <span class="keyword1">else</span> <span class="bound">fb</span><span class="main">)</span> <span class="main">⟹</span> 
        <span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="bound">cond</span> <span class="main">↦</span> <span class="bound">val</span> <span class="main">⟹</span> <span class="free">m'</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> StepE
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> best<span class="main"><span class="main">)</span></span> IfNode Pair_inject stepDet<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ifNodeHasCondEvalStutter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="free">nid'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">cond</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> IfNodeStepE assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>  stutter.cases
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IfNodeCond<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ifNodeHasCondEval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">m'</span><span class="main">,</span> <span class="free">h'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">t</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">cond</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> IfNodeStepE assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> IRNode.disc<span class="main"><span class="main">(</span></span>932<span class="main"><span class="main">)</span></span> IRNode.simps<span class="main"><span class="main">(</span></span>938<span class="main"><span class="main">)</span></span> IRNode.simps<span class="main"><span class="main">(</span></span>958<span class="main"><span class="main">)</span></span> IRNode.simps<span class="main"><span class="main">(</span></span>972<span class="main"><span class="main">)</span></span> IRNode.simps<span class="main"><span class="main">(</span></span>974<span class="main"><span class="main">)</span></span> IRNode.simps<span class="main"><span class="main">(</span></span>978<span class="main"><span class="main">)</span></span> Pair_inject StutterStep ifNodeHasCondEvalStutter is_AbstractEndNode.simps is_EndNode.simps<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span> step.cases<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> replace_if_t<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">cond</span> <span class="main">↦</span> <span class="free">bool</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"val_to_bool <span class="free">bool</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> replace_usages <span class="free">nid</span> <span class="free">tb</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nid'</span> <span class="main">.</span><span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> g1step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IfNode assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g2step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g' <span class="keyword1"><span class="command">unfolding</span></span> replace_usages.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stepRefNode<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> g1step g2step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> StutterStep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> replace_if_t_imp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">cond</span> <span class="main">↦</span> <span class="free">bool</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"val_to_bool <span class="free">bool</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> replace_usages <span class="free">nid</span> <span class="free">tb</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nid'</span> <span class="main">.</span><span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> replace_if_t assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_if_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g</span> <span class="free">cond</span> <span class="main">↦</span> <span class="free">bool</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>val_to_bool <span class="free">bool</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> replace_usages <span class="free">nid</span> <span class="free">fb</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nid'</span> <span class="main">.</span><span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> g1step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IfNode assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g2step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g' <span class="keyword1"><span class="command">unfolding</span></span> replace_usages.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stepRefNode<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> g1step g2step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> StutterStep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Prove that the individual conditional elimination rules are correct
with respect to preservation of stuttering steps.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ConditionalEliminationStepProof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wg<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_stamps <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wv<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_values <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conds_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">conds</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="bound">c</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> val_to_bool <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ce<span class="main">:</span> <span class="quoted"><span class="quoted">"ConditionalEliminationStep <span class="free">conds</span> <span class="free">stamps</span> <span class="free">g</span> <span class="free">nid</span> <span class="free">g'</span>"</span></span>

  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nid'</span> <span class="main">.</span><span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ce <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">nid</span></span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ConditionalEliminationStep.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>impliesTrue <span class="skolem">g</span> <span class="skolem">ifcond</span> <span class="skolem">cid</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">cond</span> <span class="skolem">conds</span> <span class="skolem">g'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ifcond</span> <span class="main">↝</span> <span class="free">nid'</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">condv</span></span> <span class="keyword2"><span class="keyword">where</span></span> condv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">cid</span> <span class="main">↦</span> <span class="skolem">condv</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> implies.simps impliesTrue.hyps<span class="main">(</span>3<span class="main">)</span> impliesTrue.prems<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> impliesTrue.hyps<span class="main">(</span>2<span class="main">)</span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ifNodeHasCondEvalStutter impliesTrue.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> condvTrue<span class="main">:</span> <span class="quoted"><span class="quoted">"val_to_bool <span class="skolem">condv</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> condition_implies.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> condv impliesTrue.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impliesTrue.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> impliesTrue.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impliesTrue.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> impliesTrue.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> implies_true_valid<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> constantConditionValid 
      <span class="keyword1"><span class="command">using</span></span> impliesTrue.hyps<span class="main">(</span>1<span class="main">)</span> condv impliesTrue.hyps<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>impliesFalse <span class="skolem">g</span> <span class="skolem">ifcond</span> <span class="skolem">cid</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">cond</span> <span class="skolem">conds</span> <span class="skolem">g'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="skolem">ifcond</span> <span class="main">↝</span> <span class="free">nid'</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">condv</span></span> <span class="keyword2"><span class="keyword">where</span></span> condv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">cid</span> <span class="main">↦</span> <span class="skolem">condv</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ifNodeHasCondEvalStutter impliesFalse.hyps<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> condvFalse<span class="main">:</span> <span class="quoted"><span class="quoted">"False <span class="main">=</span> val_to_bool <span class="skolem">condv</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> condition_implies.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> condv impliesFalse.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impliesFalse.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> impliesFalse.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impliesFalse.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> impliesFalse.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> implies_false_valid<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> constantConditionValid 
      <span class="keyword1"><span class="command">using</span></span> impliesFalse.hyps<span class="main">(</span>1<span class="main">)</span> condv impliesFalse.hyps<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tryFoldTrue <span class="skolem">g</span> <span class="skolem">ifcond</span> <span class="skolem">cid</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">cond</span> <span class="skolem">g'</span> <span class="skolem">conds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> constantConditionValid tryFoldProofTrue
    <span class="keyword1"><span class="command">using</span></span> StutterStep constantConditionTrue <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tryFoldFalse <span class="skolem">g</span> <span class="skolem">ifcond</span> <span class="skolem">cid</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">cond</span> <span class="skolem">g'</span> <span class="skolem">conds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> constantConditionValid tryFoldProofFalse
    <span class="keyword1"><span class="command">using</span></span> StutterStep constantConditionFalse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Prove that the individual conditional elimination rules are correct
with respect to finding a bisimulation between the unoptimized and optimized graphs.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ConditionalEliminationStepProofBisimulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span> <span class="main">∧</span> wf_stamp <span class="free">g</span> <span class="free">stamps</span> <span class="main">∧</span> wf_values <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> conds_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">conds</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="bound">c</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> val_to_bool <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ce<span class="main">:</span> <span class="quoted"><span class="quoted">"ConditionalEliminationStep <span class="free">conds</span> <span class="free">stamps</span> <span class="free">g</span> <span class="free">nid</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">h</span> <span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="bound">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="bound">nid'</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="bound">h</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(* we don't yet consider optimizations which produce a step that didn't already exist *)</span>

  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">|</span> <span class="free">g</span> <span class="main">∼</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ce gstep <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">nid</span></span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ConditionalEliminationStep.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>impliesTrue <span class="skolem">g</span> <span class="skolem">ifcond</span> <span class="skolem">cid</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">cond</span> <span class="skolem">conds</span> <span class="skolem">g'</span> <span class="skolem">stamps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> impliesTrue<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IfNode StutterStep condition_implies.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ifNodeHasCondEvalStutter impliesTrue.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impliesTrue.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impliesTrue.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> impliesTrue.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impliesTrue.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> implies_true_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constantConditionTrue impliesTrue.hyps<span class="main">(</span>1<span class="main">)</span> impliesTrue.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gstep
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stepDet strong_noop_bisimilar.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>impliesFalse <span class="skolem">g</span> <span class="skolem">ifcond</span> <span class="skolem">cid</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">cond</span> <span class="skolem">conds</span> <span class="skolem">g'</span> <span class="skolem">stamps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> impliesFalse<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IfNode condition_implies.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ifNodeHasCondEval impliesFalse.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> impliesFalse.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impliesFalse.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> impliesFalse.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> impliesFalse.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> implies_false_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constantConditionFalse impliesFalse.hyps<span class="main">(</span>1<span class="main">)</span> impliesFalse.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gstep
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stepDet strong_noop_bisimilar.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tryFoldTrue <span class="skolem">g</span> <span class="skolem">ifcond</span> <span class="skolem">cid</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">cond</span> <span class="skolem">stamps</span> <span class="skolem">g'</span> <span class="skolem">conds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tryFoldTrue<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">cid</span> <span class="main">↦</span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ifNodeHasCondEval tryFoldTrue.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_to_bool <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tryFoldProofTrue tryFoldTrue.prems<span class="main">(</span>2<span class="main">)</span> tryFoldTrue<span class="main">(</span>3<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tryFoldTrue<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IfNode <span class="quoted"><span class="quoted">‹<span class="skolem">g</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="skolem">g</span> <span class="skolem">cid</span> <span class="main">↦</span> <span class="skolem">val</span>›</span></span> tryFoldTrue.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constantConditionTrue tryFoldTrue.hyps<span class="main">(</span>1<span class="main">)</span> tryFoldTrue.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gstep
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stepDet strong_noop_bisimilar.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tryFoldFalse <span class="skolem">g</span> <span class="skolem">ifcond</span> <span class="skolem">cid</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">cond</span> <span class="skolem">stamps</span> <span class="skolem">g'</span> <span class="skolem">conds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tryFoldFalse<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> gstep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> IfNode ifNodeHasCondEval tryFoldFalse.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tryFoldFalse.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tryFoldFalse.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tryFoldProofFalse<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">ifcond</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constantConditionFalse tryFoldFalse.hyps<span class="main">(</span>1<span class="main">)</span> tryFoldFalse.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gstep
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stepDet strong_noop_bisimilar.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Mostly experimental proofs from here on out.›</span></span>

<span class="comment1">(* lies we tell isabelle to get things to pass *)</span>
<span class="keyword1"><span class="command">lemma</span></span> if_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="main">∈</span> control_nodes"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="free">nid'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">sorry</span></span>

<span class="keyword1"><span class="command">lemma</span></span> StepConditionsValid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">cond</span> <span class="main">∈</span> set <span class="free">conds</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="bound">cond</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> val_to_bool <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Step <span class="free">g</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">seen</span><span class="main">,</span> <span class="free">conds</span><span class="main">,</span> <span class="free">flow</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">seen'</span><span class="main">,</span> <span class="free">conds'</span><span class="main">,</span> <span class="free">flow'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">cond</span> <span class="main">∈</span> set <span class="free">conds'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="bound">cond</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> val_to_bool <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">seen</span><span class="main">,</span> <span class="free">conds</span><span class="main">,</span> <span class="free">flow</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">seen'</span><span class="main">,</span> <span class="free">conds'</span><span class="main">,</span> <span class="free">flow'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Step.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ifcond</span> <span class="skolem">cond</span> <span class="skolem">t</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cv</span></span> <span class="keyword2"><span class="keyword">where</span></span> cv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="skolem">c</span> <span class="main">↦</span> <span class="skolem">cv</span>"</span></span>
    <span class="keyword1"><span class="command">sorry</span></span>
  <span class="keyword1"><span class="command">have</span></span> cvt<span class="main">:</span> <span class="quoted"><span class="quoted">"val_to_bool <span class="skolem">cv</span>"</span></span>
    <span class="keyword1"><span class="command">sorry</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">conds'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">c</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">conds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span><span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> cv cvt assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">conds'</span> <span class="main">⊆</span> set <span class="free">conds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ConditionalEliminationPhaseProof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_stamps <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ConditionalEliminationPhase <span class="free">g</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free">g'</span>"</span></span>
  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nid'</span> <span class="main">.</span><span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="main">0</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="main">0</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> wf_folds <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ConditionalEliminationPhase.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">g</span> <span class="skolem">nid</span> <span class="skolem">g'</span> <span class="skolem">succs</span> <span class="skolem">nid'</span> <span class="skolem">g''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">succs</span> <span class="skolem">g</span> <span class="skolem">nid</span> <span class="skolem">nid'</span> <span class="skolem">g''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">succs</span> <span class="skolem">g</span> <span class="skolem">nid</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>