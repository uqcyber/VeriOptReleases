<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Construction</title>
</head>


<body>
<div class="head">
<h1>Theory Construction</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Graph Construction Phase›</span></span>

<span class="keyword1"><span class="command">theory</span></span>
  Construction
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Proofs/Bisimulation.html">Proofs.Bisimulation</a>
  <a href="../Proofs/IRGraphFrames.html">Proofs.IRGraphFrames</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_const_nodes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xn<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span>ConstantNode <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">xv</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> yn<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span>ConstantNode <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">yv</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> zn<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span>AddNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wn<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span>ConstantNode <span class="main">(</span>intval_add <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">xv</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">yv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"intval_add <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">xv</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">yv</span><span class="main">)</span> <span class="main">=</span> IntVal <span class="free">b</span> <span class="free">v1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ez<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">z</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">v1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ew<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">w</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">v2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> zv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">z</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="free">b</span> <span class="free">v1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.AddNode eval.ConstantNode xn yn zn val plus_Value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> wv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">w</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="free">b</span> <span class="free">v2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval.ConstantNode wn ew <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> evalDet zv wv ew ez
    <span class="keyword1"><span class="command">using</span></span> ConstantNode val wn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* these are incorrect with the introduction of accurate addition semantics *)</span>
<span class="comment1">(* most obviously due to the resultant b being either 32 or 64 *)</span>
<span class="keyword1"><span class="command">lemma</span></span> add_val_xzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"intval_add <span class="main">(</span>IntVal <span class="free">b</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">yv</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">yv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> intval_add.simps <span class="keyword1"><span class="command">sorry</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_val_yzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"intval_add <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">xv</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">xv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> intval_add.simps <span class="keyword1"><span class="command">sorry</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\Snip{CreateAddNode}%›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">create_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID <span class="main">⇒</span> IRNode"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">create_add</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">of</span> 
      ConstantNode <span class="main">(</span>IntVal <span class="bound">b</span> <span class="bound">xv</span><span class="main">)</span> <span class="main">⇒</span> 
        <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
          ConstantNode <span class="main">(</span>IntVal <span class="bound">b</span> <span class="bound">yv</span><span class="main">)</span> <span class="main">⇒</span> 
            ConstantNode <span class="main">(</span>intval_add <span class="main">(</span>IntVal <span class="bound">b</span> <span class="bound">xv</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="bound">b</span> <span class="bound">yv</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> 
          <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">xv</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> RefNode <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">else</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>
        <span class="main">)</span> <span class="main">|</span>
      <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
            ConstantNode <span class="main">(</span>IntVal <span class="bound">b</span> <span class="bound">yv</span><span class="main">)</span> <span class="main">⇒</span> 
              <span class="keyword1">if</span> <span class="bound">yv</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> RefNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">|</span>
            <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> AddNode <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>
           <span class="main">)</span>
    <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\EndSnip›</span></span>


<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\Snip{AddNodeCreate}%›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> add_node_create<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="free">b</span> <span class="free">xv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> yv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">y</span><span class="main">)</span> <span class="main">↦</span> IntVal <span class="free">b</span> <span class="free">yv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> intval_add <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">xv</span><span class="main">)</span> <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">yv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>AddNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">↦</span> <span class="free">res</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>create_add <span class="free">g</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">↦</span> <span class="free">res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\EndSnip›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>AddNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">↦</span> <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>create_add <span class="free">g</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">↦</span> <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> xv yv res eval.AddNode plus_Value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xconst<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free">y</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> yconst<span class="main">:</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"create_add <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ConstantNode <span class="free">res</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> xconst yconst
        <span class="keyword1"><span class="command">using</span></span> ConstantNodeE is_ConstantNode_def xv yv res <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eval.ConstantNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> ynotconst<span class="main">:</span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> ConstantNode <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">xv</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ConstantNodeE xconst
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ConstantNode_def xv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> add_def<span class="main">:</span>
        <span class="quoted"><span class="quoted">"create_add <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xv</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> RefNode <span class="free">y</span> <span class="keyword1">else</span> AddNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> xconst ynotconst is_ConstantNode_def
        <span class="keyword1"><span class="command">unfolding</span></span> create_add.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> IRNode.split<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xv</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> xzero<span class="main">:</span> True
        <span class="keyword1"><span class="command">have</span></span> ref<span class="main">:</span> <span class="quoted"><span class="quoted">"create_add <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> RefNode <span class="free">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> xzero add_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
        <span class="keyword1"><span class="command">have</span></span> refval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> RefNode <span class="free">y</span> <span class="main">↦</span> IntVal <span class="free">b</span> <span class="free">yv</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> eval.RefNode yv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> IntVal <span class="free">b</span> <span class="free">yv</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">unfolding</span></span> xzero add_val_xzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> xzero ref refval <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> xnotzero<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> P add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> notxconst<span class="main">:</span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_ConstantNode <span class="main">(</span>kind <span class="free">g</span> <span class="free">y</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> yconst<span class="main">:</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">y</span> <span class="main">=</span> ConstantNode <span class="main">(</span>IntVal <span class="free">b</span> <span class="free">yv</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ConstantNodeE yconst
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_ConstantNode_def yv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> add_def<span class="main">:</span>
        <span class="quoted"><span class="quoted">"create_add <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">yv</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> RefNode <span class="free">x</span> <span class="keyword1">else</span> AddNode <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> notxconst yconst is_ConstantNode_def
        <span class="keyword1"><span class="command">unfolding</span></span> create_add.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> IRNode.split<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">yv</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> yzero<span class="main">:</span> True
        <span class="keyword1"><span class="command">have</span></span> ref<span class="main">:</span> <span class="quoted"><span class="quoted">"create_add <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> RefNode <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> yzero add_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
        <span class="keyword1"><span class="command">have</span></span> refval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> RefNode <span class="free">x</span> <span class="main">↦</span> IntVal <span class="free">b</span> <span class="free">xv</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> eval.RefNode xv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> IntVal <span class="free">b</span> <span class="free">xv</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">unfolding</span></span> yzero add_val_yzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> yzero ref refval <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> ynotzero<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> P add_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">qed</span></span>
      
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> notyconst<span class="main">:</span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"create_add <span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> AddNode <span class="free">x</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> notxconst notyconst is_ConstantNode_def 
        create_add.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> IRNode.split<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> P Q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The following function definition and lemmas designed to hide stamps
   from the definition of if_node_create for the ITP paper which does
   not include stamps *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_node_fake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ID <span class="main">⇒</span> IRNode <span class="main">⇒</span> IRGraph <span class="main">⇒</span> IRGraph"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_node_fake</span> <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> add_node <span class="free"><span class="bound"><span class="entity">nid</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> VoidStamp<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>
<span class="keyword1"><span class="command">lemma</span></span> add_node_lookup_fake<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">gup</span> <span class="main">=</span> add_node_fake <span class="free">nid</span> <span class="free">k</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">gup</span> <span class="free">nid</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_node_lookup <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> NoNode"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> NoNode"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> not_in_g <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_node_fake.simps add_node_lookup<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_node_lookup assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemma</span></span> add_node_unchanged_fake<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">new</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">gup</span> <span class="main">=</span> add_node_fake <span class="free">new</span> <span class="free">k</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="free">g</span> <span class="free">gup</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_node_fake.simps add_node_unchanged assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_add_unchanged<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> add_node_fake <span class="free">n</span> <span class="free">k</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">≠</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_changed assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> preserve_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"inputs <span class="free">g'</span> <span class="free">nid</span> <span class="main">∪</span> succ <span class="free">g'</span> <span class="free">nid</span> <span class="main">⊆</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> add_node_fake <span class="free">nid</span> <span class="free">k</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_folds
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> dom_add_unchanged<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_node_unchanged_fake assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> kind_unchanged<span class="main">)</span>
  <span class="keyword1"><span class="command">sorry</span></span>

<span class="keyword1"><span class="command">lemma</span></span> equal_closure_bisimilar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">P'</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">P'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">.</span> <span class="free">g</span> <span class="main">∼</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms weak_bisimilar.simps mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_size<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_AbstractEndNode <span class="main">(</span>kind <span class="free">g</span> <span class="free">nid</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>usages <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_folds
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sequentials_have_successors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_sequential_node <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>successors_of <span class="free">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> step_reaches_successors_only<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid'</span> <span class="main">∈</span> succ <span class="free">g</span> <span class="free">nid</span> <span class="main">∨</span> <span class="free">nid'</span> <span class="main">∈</span> usages <span class="free">g</span> <span class="free">nid</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span><span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> SequentialNode
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sequentials_have_successors
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_mem succ.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfNode <span class="skolem">cond</span> <span class="skolem">tb</span> <span class="skolem">fb</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> successors_of_IfNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IfNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EndNodes <span class="skolem">i</span> <span class="skolem">phis</span> <span class="skolem">inputs</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> step_in_ids
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> usage_size<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>usages <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf EndNodes<span class="main">(</span>1<span class="main">)</span> wf_size
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> usage_size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>sorted_list_of_set <span class="main">(</span>usages <span class="free">g</span> <span class="free">nid</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_sorted_list_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"usages <span class="free">g</span> <span class="free">nid</span> <span class="main">⊆</span> ids <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> finite_usage<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>usages <span class="free">g</span> <span class="free">nid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot_nat_0.extremum_strict list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sorted_list_of_set.infinite usage_size<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EndNodes<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid'</span> <span class="main">∈</span> usages <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> any_usage.simps
    <span class="keyword1"><span class="command">using</span></span> usage_size finite_usage
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_in_set length_greater_0_conv sorted_list_of_set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>NewInstanceNode <span class="skolem">f</span> <span class="skolem">obj</span> <span class="skolem">ref</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> successors_of_NewInstanceNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LoadFieldNode <span class="skolem">f</span> <span class="skolem">obj</span> <span class="skolem">ref</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SignedDivNode <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">zero</span> <span class="skolem">sb</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SignedRemNode <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">zero</span> <span class="skolem">sb</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StaticLoadFieldNode <span class="skolem">f</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StoreFieldNode <span class="skolem">f</span> <span class="skolem">newval</span> <span class="skolem">uu</span> <span class="skolem">obj</span> <span class="skolem">val</span> <span class="skolem">ref</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StaticStoreFieldNode <span class="skolem">f</span> <span class="skolem">newval</span> <span class="skolem">uv</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stutter_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="free">nid'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="main">∈</span> ids <span class="free">g</span> <span class="main">.</span> <span class="free">nid'</span> <span class="main">∈</span> succ <span class="free">g</span> <span class="bound">n</span> <span class="main">∨</span> <span class="free">nid'</span> <span class="main">∈</span> usages <span class="free">g</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">nid</span></span> <span class="quoted"><span class="free">nid'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stutter.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StutterStep <span class="skolem">nid</span> <span class="skolem">nid'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nid</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> StutterStep.hyps step_in_ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> StutterStep step_reaches_successors_only
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Transitive <span class="skolem">nid</span> <span class="skolem">nid''</span> <span class="skolem">nid'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> unchanged_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> kind <span class="free">g'</span> <span class="free">nid</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="free">nid</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> succ<span class="main">:</span> <span class="quoted"><span class="quoted">"succ <span class="free">g</span> <span class="free">nid</span> <span class="main">=</span> succ <span class="free">g'</span> <span class="free">nid</span>"</span></span>
  <span class="comment1">(*assumes usage: "unchanged (usages g nid) g g'"*)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nid'</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> SequentialNode
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> step.SequentialNode<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>IfNode <span class="skolem">cond</span> <span class="skolem">tb</span> <span class="skolem">fb</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> stay_same step.IfNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> IRNodes.inputs_of_IfNode child_unchanged inputs.elims list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EndNodes <span class="skolem">i</span> <span class="skolem">phis</span> <span class="skolem">inputs</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">sorry</span></span> <span class="comment1">(* this is going to be a big problem *)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>NewInstanceNode <span class="skolem">f</span> <span class="skolem">obj</span> <span class="skolem">ref</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.NewInstanceNode
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LoadFieldNode <span class="skolem">f</span> <span class="skolem">obj</span> <span class="skolem">ref</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">obj</span> <span class="main">∈</span> inputs <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LoadFieldNode<span class="main">(</span>1<span class="main">)</span> inputs_of_LoadFieldNode 
    <span class="keyword1"><span class="command">using</span></span> opt_to_list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LoadFieldNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">obj</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged
    <span class="keyword1"><span class="command">using</span></span> child_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">obj</span> <span class="main">↦</span> ObjRef <span class="skolem">ref</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged wf stay_same
    <span class="keyword1"><span class="command">using</span></span> LoadFieldNode.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.LoadFieldNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LoadFieldNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> LoadFieldNode.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> LoadFieldNode.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SignedDivNode <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">zero</span> <span class="skolem">sb</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> inputs <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> SignedDivNode<span class="main">(</span>1<span class="main">)</span> inputs_of_SignedDivNode
    <span class="keyword1"><span class="command">using</span></span> opt_to_list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SignedDivNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged
    <span class="keyword1"><span class="command">using</span></span> child_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">v1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged wf stay_same
    <span class="keyword1"><span class="command">using</span></span> SignedDivNode.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> inputs <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> SignedDivNode<span class="main">(</span>1<span class="main">)</span> inputs_of_SignedDivNode
    <span class="keyword1"><span class="command">using</span></span> opt_to_list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SignedDivNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged
    <span class="keyword1"><span class="command">using</span></span> child_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">y</span> <span class="main">↦</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged wf stay_same
    <span class="keyword1"><span class="command">using</span></span> SignedDivNode.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.SignedDivNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SignedDivNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> SignedDivNode.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> SignedDivNode.hyps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">v1</span>›</span></span> kind<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SignedRemNode <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">zero</span> <span class="skolem">sb</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> inputs <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> SignedRemNode<span class="main">(</span>1<span class="main">)</span> inputs_of_SignedRemNode
    <span class="keyword1"><span class="command">using</span></span> opt_to_list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SignedRemNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged
    <span class="keyword1"><span class="command">using</span></span> child_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">v1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged wf stay_same
    <span class="keyword1"><span class="command">using</span></span> SignedRemNode.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> inputs <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> SignedRemNode<span class="main">(</span>1<span class="main">)</span> inputs_of_SignedRemNode
    <span class="keyword1"><span class="command">using</span></span> opt_to_list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SignedRemNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">y</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged
    <span class="keyword1"><span class="command">using</span></span> child_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">y</span> <span class="main">↦</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged wf stay_same
    <span class="keyword1"><span class="command">using</span></span> SignedRemNode.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SignedRemNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> SignedRemNode.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> SignedRemNode.hyps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">v1</span>›</span></span> kind step.SignedRemNode<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StaticLoadFieldNode <span class="skolem">f</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.StaticLoadFieldNode
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StoreFieldNode <span class="skolem">f</span> <span class="skolem">newval</span> <span class="skolem">uu</span> <span class="skolem">obj</span> <span class="skolem">val</span> <span class="skolem">ref</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">obj</span> <span class="main">∈</span> inputs <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> StoreFieldNode<span class="main">(</span>1<span class="main">)</span> inputs_of_StoreFieldNode
    <span class="keyword1"><span class="command">using</span></span> opt_to_list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StoreFieldNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">obj</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged
    <span class="keyword1"><span class="command">using</span></span> child_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">obj</span> <span class="main">↦</span> ObjRef <span class="skolem">ref</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged wf stay_same
    <span class="keyword1"><span class="command">using</span></span> StoreFieldNode.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">newval</span> <span class="main">∈</span> inputs <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> StoreFieldNode<span class="main">(</span>1<span class="main">)</span> inputs_of_StoreFieldNode
    <span class="keyword1"><span class="command">using</span></span> opt_to_list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StoreFieldNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">newval</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged
    <span class="keyword1"><span class="command">using</span></span> child_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">newval</span> <span class="main">↦</span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged wf stay_same
    <span class="keyword1"><span class="command">using</span></span> StoreFieldNode.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.StoreFieldNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> StoreFieldNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> StoreFieldNode.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> StoreFieldNode.hyps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">obj</span> <span class="main">↦</span> ObjRef <span class="skolem">ref</span>›</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StaticStoreFieldNode <span class="skolem">f</span> <span class="skolem">newval</span> <span class="skolem">uv</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">newval</span> <span class="main">∈</span> inputs <span class="free">g</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> StoreFieldNode<span class="main">(</span>1<span class="main">)</span> inputs_of_StoreFieldNode
    <span class="keyword1"><span class="command">using</span></span> opt_to_list.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> StaticStoreFieldNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">newval</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged
    <span class="keyword1"><span class="command">using</span></span> child_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="free">m</span> <span class="main">⊢</span> kind <span class="free">g'</span> <span class="skolem">newval</span> <span class="main">↦</span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unchanged wf stay_same
    <span class="keyword1"><span class="command">using</span></span> StaticStoreFieldNode.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.StaticStoreFieldNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> StaticStoreFieldNode.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> StaticStoreFieldNode.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> StaticStoreFieldNode.hyps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> kind<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> unchanged_closure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span> <span class="main">∧</span> wf_graph <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">=</span> add_node_fake <span class="free">nid</span> <span class="free">k</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid'</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid'</span> <span class="main">↝</span> <span class="free">nid''</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">g'</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid'</span> <span class="main">↝</span> <span class="free">nid''</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">⟷</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> niddiff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">≠</span> <span class="free">nid'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms niddiff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stutter.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StutterStep <span class="skolem">start</span> <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="skolem">start</span><span class="main">)</span> <span class="free">g</span> <span class="free">g'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> StutterStep.prems<span class="main">(</span>4<span class="main">)</span> add_node_unchanged_fake assms<span class="main">(</span>1<span class="main">)</span> g' wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> succ_same<span class="main">:</span> <span class="quoted"><span class="quoted">"succ <span class="free">g</span> <span class="skolem">start</span> <span class="main">=</span> succ <span class="free">g'</span> <span class="skolem">start</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> StutterStep.prems<span class="main">(</span>4<span class="main">)</span> kind_unchanged succ.simps unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="skolem">start</span> <span class="main">=</span> kind <span class="free">g'</span> <span class="skolem">start</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> StutterStep.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add_node_fake.elims add_node_unchanged assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> g' kind_unchanged<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">start</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unchanged_step wf unchanged succ_same
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> StutterStep.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> stutter.StutterStep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Transitive <span class="skolem">nid</span> <span class="skolem">nid''</span> <span class="skolem">nid'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_node_unchanged_fake kind_unchanged step_in_ids stutter.Transitive stutter.cases succ.simps unchanged_step<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> niddiff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">≠</span> <span class="free">nid'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> Q <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms niddiff
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stutter.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>StutterStep <span class="skolem">start</span> <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_usages <span class="free">g'</span> <span class="skolem">start</span> <span class="main">⊆</span> eval_usages <span class="free">g</span> <span class="skolem">start</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g' eval_usages <span class="keyword1"><span class="command">sorry</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g'</span> <span class="skolem">start</span><span class="main">)</span> <span class="free">g'</span> <span class="free">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> StutterStep.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add_node_unchanged_fake assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> g' subset_iff unchanged.simps wf<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> succ_same<span class="main">:</span> <span class="quoted"><span class="quoted">"succ <span class="free">g</span> <span class="skolem">start</span> <span class="main">=</span> succ <span class="free">g'</span> <span class="skolem">start</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> StutterStep.prems<span class="main">(</span>4<span class="main">)</span> eval_usages_self node_unchanged succ.simps unchanged
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> StutterStep.hyps step_in_ids<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="skolem">start</span> <span class="main">=</span> kind <span class="free">g'</span> <span class="skolem">start</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> StutterStep.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add_node_fake.elims add_node_unchanged assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> g' kind_unchanged<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">start</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> StutterStep<span class="main">(</span>1<span class="main">)</span> wf unchanged_step unchanged succ_same 
      <span class="keyword1"><span class="command">sorry</span></span> <span class="comment1">(* :( *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> stutter.StutterStep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Transitive <span class="skolem">nid</span> <span class="skolem">nid''</span> <span class="skolem">nid'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> add_node_unchanged_fake kind_unchanged step_in_ids stutter.Transitive stutter.cases succ.simps unchanged_step
      <span class="keyword1"><span class="command">sorry</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\Snip{CreateIfNode}%›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">create_if</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"IRGraph <span class="main">⇒</span> ID <span class="main">⇒</span> ID <span class="main">⇒</span> ID <span class="main">⇒</span> IRNode"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">create_if</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>kind <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span><span class="main">)</span> <span class="keyword1">of</span> 
      ConstantNode <span class="bound">condv</span> <span class="main">⇒</span> 
        RefNode <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>val_to_bool <span class="bound">condv</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span> <span class="main">|</span>
      <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span> <span class="keyword1">then</span>
              RefNode <span class="free"><span class="bound"><span class="entity">tb</span></span></span>
            <span class="keyword1">else</span> 
              IfNode <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">tb</span></span></span> <span class="free"><span class="bound"><span class="entity">fb</span></span></span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\EndSnip›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> if_node_create_bisimulation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted">FieldRefHeap</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span> <span class="main">↦</span> <span class="free">cv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">cond</span><span class="main">,</span> <span class="free">tb</span><span class="main">,</span> <span class="free">fb</span><span class="main">}</span> <span class="main">⊆</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gif</span> <span class="main">=</span> add_node_fake <span class="free">nid</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gcreate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gcreate</span> <span class="main">=</span> add_node_fake <span class="free">nid</span> <span class="main">(</span>create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span> <span class="free">g</span>"</span></span>

  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">.</span> <span class="free">gif</span> <span class="main">∼</span> <span class="free">gcreate</span>"</span></span>

<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> indep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>eval_uses <span class="free">g</span> <span class="free">cond</span> <span class="free">nid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cv eval_in_ids fresh no_external_use wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">gif</span> <span class="free">nid</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gif add_node_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">cond</span><span class="main">,</span> <span class="free">tb</span><span class="main">,</span> <span class="free">fb</span><span class="main">}</span> <span class="main">=</span> inputs <span class="free">gif</span> <span class="free">nid</span> <span class="main">∪</span> succ <span class="free">gif</span> <span class="free">nid</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inputs_of_IfNode successors_of_IfNode
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_set inputs.simps insert_is_Un list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> succ.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf_gif<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">gif</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed wf preserve_wf
    <span class="keyword1"><span class="command">using</span></span> fresh gif <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span> <span class="main">∨</span>
        create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span> <span class="main">=</span> RefNode <span class="free">tb</span> <span class="main">∨</span>
        create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span> <span class="main">=</span> RefNode <span class="free">fb</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"kind <span class="free">g</span> <span class="free">cond</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kind <span class="free">gcreate</span> <span class="free">nid</span>  <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span> <span class="main">∨</span>
        kind <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">=</span> RefNode <span class="free">tb</span> <span class="main">∨</span>
        kind <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">=</span> RefNode <span class="free">fb</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> gcreate add_node_lookup
    <span class="keyword1"><span class="command">using</span></span> add_node_lookup_fake fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inputs <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">∪</span> succ <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">cond</span><span class="main">,</span> <span class="free">tb</span><span class="main">,</span> <span class="free">fb</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inputs_of_IfNode successors_of_IfNode inputs_of_RefNode successors_of_RefNode
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf_gcreate<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">gcreate</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed wf preserve_wf fresh gcreate
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tb_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> ids <span class="free">g</span><span class="main">.</span> <span class="free">nid</span> <span class="main">∈</span> succ <span class="free">g</span> <span class="bound">n</span> <span class="main">∨</span> <span class="free">nid</span> <span class="main">∈</span> usages <span class="free">g</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fresh mem_Collect_eq subsetD usages.simps wf_folds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∉</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf stutter_closed
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> gif_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unchanged_closure fresh wf gif closed wf_gif
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> gcreate_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unchanged_closure fresh wf gcreate closed wf_gcreate
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> gif_set gcreate_set <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> fb_unchanged<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> ids <span class="free">g</span><span class="main">.</span> <span class="free">nid</span> <span class="main">∈</span> succ <span class="free">g</span> <span class="bound">n</span> <span class="main">∨</span> <span class="free">nid</span> <span class="main">∈</span> usages <span class="free">g</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fresh mem_Collect_eq subsetD usages.simps wf_folds<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∉</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf stutter_closed
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> gif_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unchanged_closure fresh wf gif closed wf_gif
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> gcreate_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unchanged_closure fresh wf gcreate closed wf_gcreate
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> gif_set gcreate_set <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">val</span> <span class="main">.</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span> <span class="main">=</span> ConstantNode <span class="bound">val</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gif_closure</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">P'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gcreate_closure</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">P'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> constantCond<span class="main">:</span> True
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span> <span class="main">=</span> ConstantNode <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constantCond <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"val_to_bool <span class="skolem">val</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> constantTrue<span class="main">:</span> True
    <span class="keyword1"><span class="command">have</span></span> if_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gif</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gif add_node_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> if_cv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gif</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">gif</span> <span class="free">cond</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">val</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ConstantNodeE add_node_unchanged_fake cv eval_in_ids fresh gif stay_same val wf<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step.IfNode if_kind if_cv
      <span class="keyword1"><span class="command">using</span></span> constantTrue <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gif_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gif_closure</span> <span class="main">=</span> <span class="main">{</span><span class="free">tb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stuttering_successor <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
    <span class="keyword1"><span class="command">have</span></span> ref_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>RefNode <span class="free">tb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gcreate add_node_lookup constantTrue constantCond <span class="keyword1"><span class="command">unfolding</span></span> create_if.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gcreate</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stepRefNode ref_kind <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gcreate_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gcreate_closure</span> <span class="main">=</span> <span class="main">{</span><span class="free">tb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stuttering_successor
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> gif_closure gcreate_closure <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gif_closure</span> <span class="main">=</span> <span class="var">?gcreate_closure</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tb_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> equal_closure_bisimilar <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> constantFalse<span class="main">:</span> False
    <span class="keyword1"><span class="command">have</span></span> if_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gif</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gif add_node_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> if_cv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gif</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">gif</span> <span class="free">cond</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">val</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ConstantNodeE add_node_unchanged_fake cv eval_in_ids fresh gif stay_same val wf<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step.IfNode if_kind if_cv
      <span class="keyword1"><span class="command">using</span></span> constantFalse <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gif_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gif_closure</span> <span class="main">=</span> <span class="main">{</span><span class="free">fb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stuttering_successor <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> ref_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">=</span> RefNode <span class="free">fb</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> add_node_lookup_fake constantFalse fresh gcreate val <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gcreate</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stepRefNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gcreate_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gcreate_closure</span> <span class="main">=</span> <span class="main">{</span><span class="free">fb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stuttering_successor <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">from</span></span> gif_closure gcreate_closure <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gif_closure</span> <span class="main">=</span> <span class="var">?gcreate_closure</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fb_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> equal_closure_bisimilar <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gif_closure</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">P'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gcreate_closure</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">P'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> notConstantCond<span class="main">:</span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">tb</span> <span class="main">=</span> <span class="free">fb</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> equalBranches<span class="main">:</span> True
     <span class="keyword1"><span class="command">have</span></span> if_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gif</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gif add_node_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step.IfNode if_kind cv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"val_to_bool <span class="free">cv</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_node_fake.simps add_node_unchanged eval_in_ids fresh gif stay_same wf<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_node_unchanged_fake eval_in_ids fresh gif stay_same wf<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gif_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gif_closure</span> <span class="main">=</span> <span class="main">{</span><span class="free">tb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> equalBranches
      <span class="keyword1"><span class="command">using</span></span> stuttering_successor <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> iref_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>RefNode <span class="free">tb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gcreate add_node_lookup notConstantCond equalBranches
      <span class="keyword1"><span class="command">unfolding</span></span> create_if.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gcreate</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stepRefNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gcreate_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gcreate_closure</span> <span class="main">=</span> <span class="main">{</span><span class="free">tb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stuttering_successor <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">from</span></span> gif_closure gcreate_closure <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gif_closure</span> <span class="main">=</span> <span class="var">?gcreate_closure</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tb_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> equal_closure_bisimilar <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> uniqueBranches<span class="main">:</span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tb_closure</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">tb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">tb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fb_closure</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">fb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">fb</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">have</span></span> if_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gif</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gif add_node_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> if_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step.IfNode if_kind cv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"val_to_bool <span class="free">cv</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_node_fake.simps add_node_unchanged eval_in_ids fresh gif stay_same wf<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_node_unchanged_fake eval_in_ids fresh gif stay_same wf<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gif_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gif_closure</span> <span class="main">=</span> <span class="var">?tb_closure</span> <span class="main">∨</span> <span class="var">?gif_closure</span> <span class="main">=</span> <span class="var">?fb_closure</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stuttering_successor <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> gc_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gcreate add_node_lookup notConstantCond uniqueBranches
      <span class="keyword1"><span class="command">unfolding</span></span> create_if.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gcreate</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">tb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">gcreate</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">fb</span><span class="main">,</span> <span class="free">m</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_node_lookup_fake fresh gcreate gif if_step<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gcreate_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gcreate_closure</span> <span class="main">=</span> <span class="var">?tb_closure</span> <span class="main">∨</span> <span class="var">?gcreate_closure</span> <span class="main">=</span> <span class="var">?fb_closure</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_node_lookup_fake fresh gc_kind gcreate gif gif_closure<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> gif_closure gcreate_closure <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gif_closure</span> <span class="main">=</span> <span class="var">?gcreate_closure</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tb_unchanged fb_unchanged
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_node_lookup_fake fresh gc_kind gcreate gif<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> equal_closure_bisimilar <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\Snip{IfNodeCreate}%›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> if_node_create<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_graph <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span> <span class="main">↦</span> <span class="free">cv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">∉</span> ids <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gif</span> <span class="main">=</span> add_node_fake <span class="free">nid</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gcreate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gcreate</span> <span class="main">=</span> add_node_fake <span class="free">nid</span> <span class="main">(</span>create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">nid'</span><span class="main">.</span> <span class="main">(</span><span class="free">gif</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">gcreate</span> <span class="free">m</span> <span class="free">h</span> <span class="main">⊢</span> <span class="free">nid</span> <span class="main">↝</span> <span class="bound">nid'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\EndSnip›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">val</span> <span class="main">.</span> <span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span> <span class="main">=</span> ConstantNode <span class="bound">val</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val</span></span> <span class="keyword2"><span class="keyword">where</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span> <span class="main">=</span> ConstantNode <span class="skolem">val</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> cond_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cond</span> <span class="main">∈</span> ids <span class="free">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cv eval_in_ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> if_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gif</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gif add_node_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> if_cv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gif</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">gif</span> <span class="free">cond</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">val</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step.IfNode if_kind
      <span class="keyword1"><span class="command">using</span></span> True eval.ConstantNode gif fresh
      <span class="keyword1"><span class="command">using</span></span> stay_same cond_exists
      <span class="keyword1"><span class="command">using</span></span> val
      <span class="keyword1"><span class="command">using</span></span> add_node.rep_eq kind.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> if_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="skolem">val</span> <span class="keyword1">then</span> <span class="free">tb</span> <span class="keyword1">else</span> <span class="free">fb</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.IfNode if_kind if_cv 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> create_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gcreate</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="skolem">val</span> <span class="keyword1">then</span> <span class="free">tb</span> <span class="keyword1">else</span> <span class="free">fb</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> create_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gcreate add_node_lookup_fake
        <span class="keyword1"><span class="command">using</span></span> fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> create_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span> <span class="main">=</span> RefNode <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="skolem">val</span> <span class="keyword1">then</span> <span class="free">tb</span> <span class="keyword1">else</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True create_kind val <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> stepRefNode create_kind create_fun if_cv 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> StutterStep create_step if_step
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> not_const<span class="main">:</span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nid'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nid'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="free">cv</span> <span class="keyword1">then</span> <span class="free">tb</span> <span class="keyword1">else</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nid_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">nid'</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">gcreate</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">nid'</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> indep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>eval_uses <span class="free">g</span> <span class="free">cond</span> <span class="free">nid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> no_external_use
      <span class="keyword1"><span class="command">using</span></span> cv eval_in_ids fresh wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> nid'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nid'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="free">cv</span> <span class="keyword1">then</span> <span class="free">tb</span> <span class="keyword1">else</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">nid'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> val_to_bool <span class="free">cv</span> <span class="keyword1">then</span> <span class="free">tb</span> <span class="keyword1">else</span> <span class="free">fb</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> gif_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gif</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> add_node_lookup_fake gif
      <span class="keyword1"><span class="command">using</span></span> fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">nid</span> <span class="main">≠</span> <span class="free">cond</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cv fresh indep
      <span class="keyword1"><span class="command">using</span></span> eval_in_ids <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="free">cond</span><span class="main">)</span> <span class="free">g</span> <span class="free">gif</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gif add_node_unchanged_fake
      <span class="keyword1"><span class="command">using</span></span> cv eval_in_ids fresh wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cv2</span></span> <span class="keyword2"><span class="keyword">where</span></span> cv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gif</span> <span class="free">m</span> <span class="main">⊢</span> <span class="main">(</span>kind <span class="free">gif</span> <span class="free">cond</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">cv2</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> cv gif wf stay_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cv</span> <span class="main">=</span> <span class="skolem">cv2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> indep gif cv
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">nid</span> <span class="main">≠</span> <span class="free">cond</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> fresh
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹unchanged <span class="main">(</span>eval_usages <span class="free">g</span> <span class="free">cond</span><span class="main">)</span> <span class="free">g</span> <span class="free">gif</span>›</span></span> evalDet stay_same wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eval_gif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gif</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">nid'</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step.IfNode gif_kind nid' cv2 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> gcreate_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"kind <span class="free">gcreate</span> <span class="free">nid</span> <span class="main">=</span> <span class="main">(</span>create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gcreate add_node_lookup_fake
      <span class="keyword1"><span class="command">using</span></span> fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> eval_gcreate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gcreate</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">nid</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">nid'</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">tb</span> <span class="main">=</span> <span class="free">fb</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span> <span class="main">=</span> RefNode <span class="free">tb</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_const True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> True gcreate_kind nid' stepRefNode
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"create_if <span class="free">g</span> <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span> <span class="main">=</span> IfNode <span class="free">cond</span> <span class="free">tb</span> <span class="free">fb</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_const False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>kind <span class="free">g</span> <span class="free">cond</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> eval_gif gcreate gif
        <span class="keyword1"><span class="command">using</span></span> IfNode <span class="quoted"><span class="quoted">‹<span class="free">cv</span> <span class="main">=</span> <span class="skolem">cv2</span>›</span></span> cv2 gif_kind nid' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_gcreate eval_gif StutterStep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nid_eq StutterStep <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>